 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ff6b6b">
    <title>Durga Puja Pandal Map - Kolkata 2025</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Offline & PWA Meta Tags -->
    <meta name="application-name" content="Durga Puja Map">
    <meta name="msapplication-TileColor" content="#ff6b6b">
    <meta name="msapplication-TileImage" content="icon-192.png">
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Improve scrolling performance on mobile */
        html {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            min-height: 100vh;
            -webkit-text-size-adjust: 100%; /* Prevent text scaling on iOS */
            -ms-text-size-adjust: 100%;
            overscroll-behavior: none; /* Prevent pull-to-refresh */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .col-md-8 {
            flex: 1;
            min-width: 300px;
        }

        .col-md-4 {
            flex: 0 0 420px;
            min-width: 350px;
            max-width: 100%;
        }

        /* Location Selector Overlay */
        .location-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.95), rgba(255, 140, 0, 0.95));
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .location-selector {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: slideInUp 0.8s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .location-selector h2 {
            color: #8B0000;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: bold;
        }

        .location-selector p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .location-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .location-card {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 180px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
        }

        .location-card h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .location-card p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        .location-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .selector-footer {
            margin-top: 20px;
            color: #888;
            font-size: 0.9rem;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #d32f2f 0%, #f57c00 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Navigation */
        .navbar {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            min-height: 44px; /* iOS recommended touch target size */
            min-width: 44px;
            justify-content: center;
            text-align: center;
            -webkit-tap-highlight-color: transparent; /* Remove iOS tap highlight */
            touch-action: manipulation; /* Improve touch response */
            margin: 4px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            color: white;
        }

        .btn-refresh {
            background: linear-gradient(135deg, #8e24aa 0%, #d81b60 100%);
            color: white;
            position: relative;
        }

        .btn-refresh:hover {
            background: linear-gradient(135deg, #7b1fa2 0%, #c2185b 100%);
            transform: translateY(-2px);
        }

        .btn-refresh i {
            transition: transform 0.3s ease;
        }

        .btn-refresh:hover i {
            transform: rotate(180deg);
        }

        .btn-info {
            background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Enhanced Routing Styles */
        .routing-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .enhanced-route-icon {
            animation: none;
        }

        .enhanced-route-icon:hover {
            animation: pulse 1s infinite;
        }

        .custom-number-icon {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
        }

        /* Route info cards */
        .route-info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .route-step {
            background: #f8f9fa;
            border-left: 3px solid #2196f3;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .route-step:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        /* Navigation improvements */
        .navigation-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #2196f3;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.2);
        }

        /* Leaflet routing control customization */
        .leaflet-routing-container {
            background: white !important;
            border-radius: 10px !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
        }

        .leaflet-routing-alt {
            margin: 8px !important;
            padding: 12px !important;
            border-radius: 8px !important;
            border: 1px solid #e0e0e0 !important;
        }

        .leaflet-routing-alt:first-child {
            border-color: #2196f3 !important;
            background: #e3f2fd !important;
        }

        /* Transport Mode Selection */
        .transport-mode-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 4px;
            cursor: pointer;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .transport-mode-btn:hover {
            border-color: #2196f3;
            color: #2196f3;
            transform: translateY(-1px);
        }

        .transport-mode-btn.active {
            background: #2196f3;
            border-color: #2196f3;
            color: white;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .transport-mode-btn i {
            font-size: 16px;
        }

        /* Animated route segment */
        .current-route-segment {
            animation: route-pulse 2s ease-in-out infinite;
        }

        @keyframes route-pulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.6; }
        }

        /* Route segment styling */
        .leaflet-interactive {
            cursor: pointer;
        }

        /* Main Content */
        main {
            padding: 30px 0;
            min-height: calc(100vh - 200px);
        }

        /* Map Container */
        .map-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .search-box {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            -webkit-appearance: none; /* Remove iOS styling */
            appearance: none; /* Standard property */
            -webkit-tap-highlight-color: transparent;
        }

        .search-box input:focus {
            outline: none;
            border-color: #2196f3;
        }

        .search-box button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-controls select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Map */
        #map {
            width: 100%;
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Fullscreen Button */
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
        }

        .fullscreen-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }

        /* Fullscreen Mode */
        .map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
            padding: 0;
            background: white;
        }

        .map-container.fullscreen #map {
            height: 100vh;
            border-radius: 0;
        }

        .map-container.fullscreen .search-box,
        .map-container.fullscreen .filter-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .map-container.fullscreen .filter-controls {
            top: 80px;
        }

        .map-container.fullscreen .fullscreen-btn {
            top: 20px;
            right: 20px;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            height: fit-content;
            width: 100%;
            box-sizing: border-box;
        }

        .sidebar h3 {
            color: #d32f2f;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* Famous Pandals Section */
        .pandal-list {
            margin-bottom: 20px;
        }

        /* Route Planner Section */
        .route-planner {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid #dee2e6;
        }

        .route-planner h3 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #dee2e6;
        }

        /* Pandal Cards */
        .pandal-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .pandal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
        }

        .pandal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .pandal-card h4 {
            color: #d32f2f;
            margin-bottom: 6px;
            font-size: 15px;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .pandal-card p {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .pandal-card .theme {
            display: inline-block;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1976d2;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 6px;
        }

        .pandal-card .rating {
            float: right;
            color: #ff9800;
            font-weight: bold;
        }

        /* Route Planner */
        .route-planner {
            margin-top: 30px;
        }

        .selected-pandal {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-pandal {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Search and Filter Controls */
        #pandal-search {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #pandal-search:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        #area-filter, #theme-filter {
            transition: border-color 0.3s ease;
            cursor: pointer;
        }

        #area-filter:focus, #theme-filter:focus {
            outline: none;
            border-color: #007bff;
        }

        #filter-results {
            font-style: italic;
        }

        /* Enhanced pandal item styling */
        .pandal-item-theme {
            background: linear-gradient(90deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 3px;
            padding: 1px 4px;
            margin-top: 2px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #d32f2f;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-section ul {
            list-style: none;
            padding-left: 0;
        }

        .info-section li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .info-section li::before {
            content: '•';
            color: #ff6b6b;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* Footer */
        footer {
            background: linear-gradient(135deg, #d32f2f 0%, #f57c00 100%);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 50px;
        }

        .heart {
            color: #ff4081;
            font-size: 1.2em;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Go to Top Button */
        .go-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .go-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .go-to-top:hover {
            background: linear-gradient(135deg, #ff5722 0%, #ff9800 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6);
        }

        .go-to-top:active {
            transform: translateY(-1px);
        }

        /* Custom Leaflet Popup */
        .custom-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .custom-popup h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .custom-popup p {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .custom-popup .theme-tag {
            display: inline-block;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1976d2;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
        }

        /* Responsive Design */
        /* Tablet and small desktop */
        @media (max-width: 1024px) {
            .container {
                padding: 0 15px;
            }
            
            .col-md-4 {
                flex: 0 0 380px;
            }
            
            #map {
                height: 450px;
            }
        }

        /* Tablet portrait */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
                gap: 15px;
            }
            
            .col-md-4 {
                flex: 1;
                order: -1;
                min-width: 100%;
                max-width: 100%;
            }
            
            .col-md-8 {
                min-width: 100%;
            }
            
            header h1 {
                font-size: 1.8rem;
                text-align: center;
            }
            
            header p {
                text-align: center;
            }
            
            .nav-controls {
                justify-content: center;
                gap: 8px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
                margin: 3px;
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .filter-controls select {
                width: 100%;
                padding: 12px 15px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            #map {
                height: 400px;
                border-radius: 10px;
            }
            
            .sidebar {
                margin-bottom: 20px;
                padding: 15px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
            
            .search-box input {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        /* Mobile phones */
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            header {
                padding: 15px 0;
            }
            
            header h1 {
                font-size: 1.5rem;
                line-height: 1.3;
            }
            
            header p {
                font-size: 1rem;
                margin-top: 8px;
            }
            
            .navbar {
                padding: 12px 0;
            }
            
            .nav-controls {
                gap: 5px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
                margin: 2px;
                min-height: 40px;
            }
            
            #map {
                height: 350px;
                border-radius: 8px;
            }
            
            .map-container {
                padding: 0;
            }
            
            .search-box {
                margin-bottom: 15px;
                flex-direction: column;
                gap: 10px;
            }
            
            .search-box input,
            .search-box button {
                width: 100%;
                margin: 0;
            }
            
            .filter-controls {
                gap: 8px;
            }
            
            .sidebar {
                padding: 12px;
            }
            
            .pandal-card {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .pandal-card h4 {
                font-size: 14px;
                line-height: 1.4;
            }
            
            .pandal-card p {
                font-size: 12px;
            }
            
            .fullscreen-btn {
                width: 35px;
                height: 35px;
                padding: 8px;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 98%;
                padding: 15px;
                border-radius: 10px;
            }
        }

        /* Extra small screens */
        @media (max-width: 360px) {
            header h1 {
                font-size: 1.3rem;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 11px;
                min-height: 38px;
            }
            
            .nav-controls {
                gap: 3px;
            }
            
            #map {
                height: 300px;
            }
            
            .pandal-card h4 {
                font-size: 13px;
            }
            
            .pandal-card p {
                font-size: 11px;
            }
            
            .sidebar {
                padding: 8px;
            }
        }

        /* Landscape orientation optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 10px 0;
            }
            
            header h1 {
                font-size: 1.4rem;
            }
            
            .navbar {
                padding: 8px 0;
            }
            
            #map {
                height: 250px;
            }
            
            .row {
                gap: 10px;
            }
        }

        /* Touch-specific improvements */
        @media (pointer: coarse) {
            .btn {
                min-height: 48px; /* Better touch target for coarse pointers */
                min-width: 48px;
            }
            
            .pandal-card {
                cursor: default; /* Remove cursor pointer on touch devices */
            }
            
            .fullscreen-btn {
                min-width: 48px;
                min-height: 48px;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #d32f2f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Intro Animation Styles */
        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 50%, #8b0000 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 1s ease 4s forwards;
        }

        .intro-image {
            width: 300px;
            height: 400px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.3);
            animation: zoomInGlow 2s ease forwards;
            border: 3px solid gold;
            background: linear-gradient(45deg, #8B0000, #FFD700, #FF6347);
            display: flex;
            align-items: center;
            justify-content: center;
            color: gold;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            flex-direction: column;
        }

        .intro-text {
            margin-top: 30px;
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
            font-family: 'Georgia', serif;
            animation: slideUpFade 1.5s ease 1s forwards;
            opacity: 0;
            text-align: center;
        }

        .intro-subtitle {
            margin-top: 10px;
            font-size: 1.2rem;
            color: #FFF8DC;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
            animation: slideUpFade 1.5s ease 1.5s forwards;
            opacity: 0;
            text-align: center;
        }

        .intro-blessing {
            margin-top: 20px;
            font-size: 1rem;
            color: #FFE4B5;
            font-style: italic;
            animation: slideUpFade 1.5s ease 2s forwards;
            opacity: 0;
            text-align: center;
        }

        @keyframes zoomInGlow {
            0% {
                transform: scale(0.3) rotate(-10deg);
                opacity: 0;
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }
            50% {
                transform: scale(1.1) rotate(2deg);
                box-shadow: 0 20px 60px rgba(255, 215, 0, 0.5);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
                box-shadow: 0 20px 60px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes slideUpFade {
            0% {
                transform: translateY(50px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                visibility: visible;
            }
            100% {
                opacity: 0;
                visibility: hidden;
            }
        }

        /* Floating particles animation */
        .particle {
            position: absolute;
            background: #FFD700;
            border-radius: 50%;
            pointer-events: none;
            animation: float 6s infinite ease-in-out;
        }

        .particle:nth-child(1) { width: 4px; height: 4px; top: 20%; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 6px; height: 6px; top: 60%; left: 85%; animation-delay: 1s; }
        .particle:nth-child(3) { width: 3px; height: 3px; top: 40%; left: 90%; animation-delay: 2s; }
        .particle:nth-child(4) { width: 5px; height: 5px; top: 80%; left: 15%; animation-delay: 3s; }
        .particle:nth-child(5) { width: 4px; height: 4px; top: 30%; left: 5%; animation-delay: 4s; }
        .particle:nth-child(6) { width: 6px; height: 6px; top: 70%; left: 95%; animation-delay: 2.5s; }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
                opacity: 0.8;
            }
        }

        /* Hide main content during intro */
        .main-content {
            opacity: 0;
            animation: showMainContent 1s ease 4s forwards;
        }

        @keyframes showMainContent {
            to {
                opacity: 1;
            }
        }

        /* Feedback System Styles */
        .feedback-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            animation: pulse-feedback 2s infinite;
        }

        .feedback-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6);
        }

        @keyframes pulse-feedback {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .feedback-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .feedback-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideInUp 0.4s ease;
        }

        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .feedback-form h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            text-align: center;
        }

        .rating-container {
            text-align: center;
            margin: 15px 0;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }

        .rating-star {
            font-size: 30px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-star:hover,
        .rating-star.active {
            color: #ffc107;
            transform: scale(1.1);
        }

        .feedback-form input,
        .feedback-form textarea {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.3s ease;
            resize: vertical;
        }

        .feedback-form input:focus,
        .feedback-form textarea:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .feedback-form textarea {
            min-height: 100px;
        }

        .feedback-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .feedback-submit-btn {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .feedback-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .feedback-cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .feedback-cancel-btn:hover {
            background: #5a6268;
        }

        .feedback-success {
            text-align: center;
            padding: 20px;
            color: #4caf50;
            display: none;
        }

        .feedback-success i {
            font-size: 50px;
            margin-bottom: 15px;
            display: block;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .feedback-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 18px;
            }

            .feedback-modal-content {
                margin: 10% auto;
                padding: 20px;
                width: 95%;
            }

            .rating-star {
                font-size: 25px;
            }
        }

        /* Arrival Notification Styles */
        .arrival-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideInRight 0.5s ease-out, pulse 2s infinite 0.5s;
            max-width: 350px;
            min-width: 280px;
        }

        .notification-content {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .notification-icon {
            font-size: 2em;
            animation: bounce 1s infinite;
        }

        .notification-text h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        .notification-text p {
            margin: 0 0 3px 0;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .notification-text small {
            font-size: 0.75em;
            opacity: 0.7;
        }

        .notification-close {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.7;
            padding: 0;
            line-height: 1;
        }

        .notification-close:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Progress indicator */
        #proximity-indicator {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            margin: 5px 0;
            text-align: center;
        }

        /* Weather Widget Scroll Enhancement */
        #weather-time-widget {
            transition: all 0.3s ease;
        }

        /* Responsive scroll for weather widget */
        @media (max-width: 768px) {
            #weather-time-widget {
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                left: auto !important;
                width: 300px !important;
                max-width: calc(100vw - 40px) !important;
                max-height: 70vh !important;
                transform-origin: top right !important;
            }

            #weather-time-content {
                max-height: calc(70vh - 80px) !important;
                overflow-y: auto !important;
                padding: 12px !important;
            }
        }

        @media (max-width: 480px) {
            #weather-time-widget {
                top: 15px !important;
                right: 15px !important;
                width: 280px !important;
                max-width: calc(100vw - 30px) !important;
                max-height: 60vh !important;
            }

            #weather-time-content {
                max-height: calc(60vh - 70px) !important;
                padding: 10px !important;
                font-size: 13px !important;
            }

            #weather-time-widget h3 {
                font-size: 14px !important;
            }
        }

        /* Enhanced scrollbar for mobile */
        @media (pointer: coarse) {
            #weather-time-content::-webkit-scrollbar {
                width: 8px;
            }
            
            #weather-time-content::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #00c9ff, #92fe9d);
                border-radius: 4px;
            }
        }

        /* Smooth scroll behavior */
        #weather-time-content {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Fade effect for scrollable content */
        #weather-time-widget::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, rgba(255,255,255,0.9));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 0 0 12px 12px;
        }

        #weather-time-widget.scrollable::after {
            opacity: 1;
        }

        /* Scroll progress indicator */
        #weather-time-widget::before {
            content: '';
            position: absolute;
            top: 60px;
            right: 2px;
            width: 3px;
            height: calc(100% - 80px);
            background: rgba(0, 201, 255, 0.2);
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #weather-time-widget.scrollable::before {
            opacity: 1;
        }

        /* Scroll thumb indicator */
        #weather-time-widget .scroll-thumb {
            position: absolute;
            top: 60px;
            right: 2px;
            width: 3px;
            height: 20px;
            background: linear-gradient(135deg, #00c9ff, #92fe9d);
            border-radius: 2px;
            transition: all 0.1s ease;
            opacity: 0;
        }

        #weather-time-widget.scrollable .scroll-thumb {
            opacity: 1;
        }

        /* Weather Toggle Button */
        .weather-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 201, 255, 0.4);
            z-index: 10020;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weather-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 201, 255, 0.6);
        }

        .weather-toggle-btn:active {
            transform: scale(0.95);
        }

        /* Hide weather widget by default */
        #weather-time-widget {
            display: none;
            transform: translateY(-10px) scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #weather-time-widget.show {
            display: flex;
            transform: translateY(0) scale(1);
            opacity: 1;
            animation: slideInFromTop 0.3s ease;
        }

        @keyframes slideInFromTop {
            from {
                transform: translateY(-20px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 360px) {
            #weather-time-widget {
                width: 260px !important;
                max-width: calc(100vw - 20px) !important;
                right: 10px !important;
                top: 10px !important;
            }
            
            .weather-toggle-btn {
                bottom: 15px !important;
                right: 15px !important;
                width: 45px !important;
                height: 45px !important;
                font-size: 18px !important;
            }
        }

        /* Prevent weather widget from covering important elements */
        @media (max-height: 600px) {
            #weather-time-widget {
                max-height: 50vh !important;
            }
            
            #weather-time-content {
                max-height: calc(50vh - 60px) !important;
            }
        }

        /* Add subtle overlay when weather widget is open on mobile */
        @media (max-width: 768px) {
            body.weather-widget-open::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.1);
                z-index: 10013;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            body.weather-widget-open.show-overlay::before {
                opacity: 1;
            }
        }

        /* Ensure weather widget content is scrollable on very small screens */
        @media (max-height: 500px) {
            #weather-time-widget {
                max-height: 80vh !important;
            }
            
            #weather-time-content {
                max-height: calc(80vh - 50px) !important;
                font-size: 12px !important;
            }
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Location service improvements */
        .location-detect-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            z-index: 10010;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .location-detect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .location-detect-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .weather-toggle-btn {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .location-detect-btn {
                top: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Location Selector Overlay -->
    <div class="location-selector-overlay" id="location-selector-overlay">
        <div class="location-selector">
            <h2><i class="fas fa-map-marked-alt"></i> Welcome to PujaPop</h2>
            <p>Choose your location to explore Durga Puja pandals</p>
            
            <div class="location-options">
                <button class="location-card" onclick="window.selectLocation('kolkata')">
                    <i class="fas fa-city"></i>
                    <h3>Kolkata</h3>
                    <p>Main city with 50+ famous pandals</p>
                </button>
                
                <button class="location-card" onclick="window.selectLocation('kalyani')">
                    <i class="fas fa-leaf"></i>
                    <h3>Kalyani</h3>
                    <p>Beautiful suburban pandals</p>
                </button>
                
                <button class="location-card" onclick="window.selectLocation('chuchura')">
                    <i class="fas fa-water"></i>
                    <h3>Chuchura</h3>
                    <p>Historic town with traditional pandals</p>
                </button>
                
                <button class="location-card" onclick="window.selectLocation('bandel')">
                    <i class="fas fa-church"></i>
                    <h3>Bandel</h3>
                    <p>Heritage town with cultural celebrations</p>
                </button>
            </div>
            
            <div class="selector-footer">
                <p><i class="fas fa-info-circle"></i> You can change location anytime from the menu</p>
            </div>
        </div>
    </div>

    <!-- Intro Animation Overlay -->
    <div class="intro-overlay" id="intro-overlay">
        <!-- Floating particles -->
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        
        <!-- Main intro content -->
        <img src="https://github.com/workarijit06/puajpop/blob/main/1.jpg?raw=true" alt="Durga Maa" class="intro-image">
        
        <div class="intro-text">Welcome to PujaPop</div>
        <div class="intro-subtitle">Your Ultimate Durga Puja Guide</div>
        <div class="intro-blessing">✨ Jay Maa Durga ✨</div>
    </div>

    <!-- Main Website Content -->
    <div class="main-content">
    
    <!-- Weather Toggle Button -->
    <button id="weather-toggle-btn" class="weather-toggle-btn" onclick="toggleWeatherWidget()" title="Show Weather Info">
        <i class="fas fa-cloud-sun"></i>
    </button>
    
    <!-- Auto Location Detect Button -->
    <button id="location-detect-btn" class="location-detect-btn" onclick="autoDetectLocation()" title="Auto-detect my location">
        <i class="fas fa-crosshairs"></i> Auto-detect Location
    </button>
    
    <header>
        <div class="container">
            <h1><i class="fas fa-map-marked-alt"></i> Durga Puja Pandal Map - Kolkata 2025</h1>
            <p>Your ultimate guide for pandal hopping in the City of Joy</p>
        </div>
    </header>

    <nav class="navbar">
        <div class="container">
            <div class="nav-controls">
                <button id="change-location-btn" class="btn btn-warning">
                    <i class="fas fa-map-marker-alt"></i> Change Location
                </button>
                <button id="show-all-btn" class="btn btn-primary">
                    <i class="fas fa-eye"></i> Show All Pandals
                </button>
                <button id="plan-route-btn" class="btn btn-secondary">
                    <i class="fas fa-route"></i> Plan Route
                </button>
                <button id="toggle-info-btn" class="btn btn-info">
                    <i class="fas fa-info-circle"></i> Festival Info
                </button>
                <button id="location-btn" class="btn btn-success">
                    <i class="fas fa-map-marker-alt"></i> Track My Location
                </button>
                <button id="refresh-btn" class="btn btn-refresh" onclick="window.location.reload()" title="Refresh Page">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <!-- Mobile HTTPS Notice -->
            <div id="mobile-https-notice" class="alert alert-warning" style="display: none; margin: 10px 0; font-size: 14px;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Mobile Notice:</strong> Live location requires HTTPS. If location tracking fails, please 
                <a href="#" onclick="showHttpsHelp()" style="color: #0066cc; text-decoration: underline;">click here for setup help</a>.
            </div>
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <div class="map-container">
                        <div class="search-box">
                            <input type="text" id="search-input" placeholder="Search pandals by name or area...">
                            <button id="search-btn"><i class="fas fa-search"></i></button>
                        </div>
                        
                        <div class="filter-controls">
                            <select id="area-filter">
                                <option value="">All Areas</option>
                                <option value="Kalyani">Kalyani</option>
                                <option value="North">North Kolkata</option>
                                <option value="Central">Central Kolkata</option>
                                <option value="South">South Kolkata</option>
                                <option value="East">East Kolkata</option>
                                <option value="West">West Kolkata</option>
                            </select>
                            
                            <select id="theme-filter">
                                <option value="">All Themes</option>
                                <option value="Traditional">Traditional</option>
                                <option value="Modern">Modern</option>
                                <option value="Eco-friendly">Eco-friendly</option>
                                <option value="Theme-based">Theme-based</option>
                            </select>
                        </div>
                        
                        <div id="map"></div>

    <!-- Feedback Button -->
    <button class="feedback-btn" onclick="openFeedbackModal()" title="Give Feedback">
        <i class="fas fa-comment"></i>
    </button>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="feedback-modal">
        <div class="feedback-modal-content">
            <div class="feedback-form" id="feedbackForm">
                <h3><i class="fas fa-heart" style="color: #ff6b6b;"></i> Share Your Experience</h3>
                
                <div class="rating-container">
                    <label>Rate your experience:</label>
                    <div class="rating-stars" id="ratingStars">
                        <span class="rating-star" data-rating="1">★</span>
                        <span class="rating-star" data-rating="2">★</span>
                        <span class="rating-star" data-rating="3">★</span>
                        <span class="rating-star" data-rating="4">★</span>
                        <span class="rating-star" data-rating="5">★</span>
                    </div>
                </div>

                <input type="text" id="feedbackName" placeholder="Your Name (Optional)" />
                
                <textarea id="feedbackMessage" placeholder="Tell us about your experience with the Durga Puja Map..."></textarea>
                
                <div class="feedback-buttons">
                    <button class="feedback-cancel-btn" onclick="closeFeedbackModal()">Cancel</button>
                    <button class="feedback-submit-btn" onclick="submitFeedback()">
                        <i class="fas fa-paper-plane"></i> Submit
                    </button>
                </div>
            </div>

            <div class="feedback-success" id="feedbackSuccess">
                <i class="fas fa-check-circle"></i>
                <h3>Thank You!</h3>
                <p>Your feedback helps us improve the Durga Puja Map experience.</p>
                <button class="feedback-submit-btn" onclick="closeFeedbackModal()" style="margin-top: 15px;">Close</button>
            </div>
        </div>
    </div>
                        <button class="fullscreen-btn" id="fullscreen-toggle" title="Toggle Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="sidebar">
                        <!-- Famous Pandals Section - Always Visible -->
                        <div class="pandal-list">
                            <h3><i class="fas fa-list"></i> Famous Pandals</h3>
                            <div id="pandal-cards"></div>
                        </div>
                        
                        <!-- Route Planner Section - Toggleable -->
                        <div class="route-planner" id="route-planner" style="display: none;">
                            <div style="border-top: 2px solid #e0e0e0; margin: 20px 0; padding-top: 20px;">
                                <h3><i class="fas fa-route"></i> Route Planner</h3>
                                
                                <!-- Transportation Mode Selection -->
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                    <h4 style="color: #2196f3; margin-bottom: 10px;"><i class="fas fa-route"></i> Transportation Mode</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                        <button id="mode-walking" class="transport-mode-btn active" onclick="window.app.setTransportMode('foot')">
                                            <i class="fas fa-walking"></i><br>Walking
                                        </button>
                                        <button id="mode-driving" class="transport-mode-btn" onclick="window.app.setTransportMode('driving')">
                                            <i class="fas fa-car"></i><br>Driving
                                        </button>
                                        <button id="mode-cycling" class="transport-mode-btn" onclick="window.app.setTransportMode('cycling')">
                                            <i class="fas fa-bicycle"></i><br>Cycling
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="pandal-selection" style="display: block;">
                                    <h4 style="color: #d32f2f; margin-bottom: 15px;">Select Pandals to Visit:</h4>
                                    
                                    <!-- Search and Filter Controls -->
                                    <div style="margin-bottom: 15px;">
                                        <!-- Search Box -->
                                        <div style="margin-bottom: 10px;">
                                            <input type="text" id="pandal-search" placeholder="🔍 Search pandals..." 
                                                   style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        </div>
                                        
                                        <!-- Filter Dropdowns -->
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <select id="area-filter" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white;">
                                                <option value="">All Areas</option>
                                                <option value="Kalyani">Kalyani</option>
                                                <option value="Salt Lake">Salt Lake</option>
                                                <option value="Chuchura">Chuchura</option>
                                                <option value="Bandel">Bandel</option>
                                                <option value="North">North</option>
                                                <option value="Central">Central</option>
                                                <option value="South">South</option>
                                                <option value="East">East</option>
                                                <option value="West">West</option>
                                            </select>
                                            
                                            <select id="theme-filter" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white;">
                                                <option value="">All Themes</option>
                                                <option value="Traditional">Traditional</option>
                                                <option value="Modern">Modern</option>
                                                <option value="Eco-friendly">Eco-friendly</option>
                                                <option value="Heritage">Heritage</option>
                                                <option value="Contemporary">Contemporary</option>
                                                <option value="Artistic">Artistic</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Clear Filters and Results Count -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                            <div id="filter-results" style="font-size: 12px; color: #666;"></div>
                                            <button id="clear-filters-btn" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; background: white; color: #666; font-size: 11px; cursor: pointer;">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div style="max-height: 250px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; margin: 10px 0; background: #f9f9f9;">
                                        <div id="pandal-checklist"></div>
                                    </div>
                                    <button id="start-route-btn" class="btn btn-primary" style="width: 100%; margin: 10px 0;">
                                        <i class="fas fa-play"></i> Start My Route
                                    </button>
                                </div>
                                
                                <div id="active-route" style="display: none;">
                                    <h4><i class="fas fa-navigation"></i> Active Route</h4>
                                    <div id="current-destination"></div>
                                    <div id="route-progress"></div>
                                    <div id="next-pandal"></div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0;">
                                        <button id="show-full-route-btn" class="btn btn-info" onclick="window.app.showFullRoute()">
                                            <i class="fas fa-map"></i> Full Route
                                        </button>
                                        <button id="arrived-btn" class="btn btn-success" onclick="window.app.arrivedAtPandal()">
                                            <i class="fas fa-check"></i> Arrived
                                        </button>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 5px 0;">
                                        <button id="undo-arrival-btn" class="btn btn-warning" onclick="window.app.undoLastArrival()" 
                                                style="display: none; font-size: 0.85em;">
                                            <i class="fas fa-undo"></i> Undo Last
                                        </button>
                                        <button id="end-route-btn" class="btn btn-secondary" onclick="window.app.resetRoute()" style="font-size: 0.85em;">
                                            <i class="fas fa-stop"></i> End Route
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="selected-pandals"></div>
                                <div id="route-info"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-info-circle"></i> Durga Puja 2025 - Festival Information</h2>
            
            <div class="info-section">
                <h3><i class="fas fa-calendar-alt"></i> Festival Dates</h3>
                <ul>
                    <li><strong>Mahalaya:</strong> September 21, 2025</li>
                    <li><strong>Sasthi:</strong> September 27, 2025</li>
                    <li><strong>Saptami:</strong> September 28, 2025</li>
                    <li><strong>Ashtami:</strong> September 29, 2025</li>
                    <li><strong>Navami:</strong> September 30, 2025</li>
                    <li><strong>Dashami (Visarjan):</strong> October 1, 2025</li>
                </ul>
            </div>

            <div class="info-section">
                <h3><i class="fas fa-bus"></i> Transportation Tips</h3>
                <ul>
                    <li>Use Metro for major destinations - extended hours during Puja</li>
                    <li>Bus services available but expect heavy crowds</li>
                    <li>Shared cabs and app-based rides may have surge pricing</li>
                    <li>Walking is often faster in crowded areas</li>
                </ul>
            </div>

            <div class="info-section">
                <h3><i class="fas fa-shield-alt"></i> Safety Tips</h3>
                <ul>
                    <li>Stay hydrated and carry water</li>
                    <li>Keep valuables secure</li>
                    <li>Travel in groups, especially at night</li>
                    <li>Be aware of crowd movement</li>
                    <li>Keep emergency contacts handy</li>
                </ul>
            </div>

            <div class="info-section">
                <h3><i class="fas fa-phone"></i> Emergency Contacts</h3>
                <ul>
                    <li><strong>Police:</strong> 100</li>
                    <li><strong>Fire:</strong> 101</li>
                    <li><strong>Ambulance:</strong> 108</li>
                    <li><strong>Tourist Helpline:</strong> 1033</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Go to Top Button -->
    <button class="go-to-top" id="goToTopBtn" onclick="scrollToTop()" title="Go to Top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <footer>
        <div class="container">
            <p>Made by Arijit Paswan | &copy; 2025 Durga Puja Pandal Map. Created for pandal hoppers in Kolkata. 
               <span class="heart">❤️</span> Made with love for Ma Durga</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script>
        // Durga Puja Pandal Map Application
        class DurgaPujaMap {
            constructor() {
                this.map = null;
                this.markers = [];
                this.pandals = [];
                this.selectedPandals = [];
                this.routeControl = null;
                this.userLocationMarker = null;
                this.userLocation = null;
                this.watchId = null;
                this.isTrackingLocation = false;
                this.activeRoute = [];
                this.selectedLocation = null; // New property for location filtering
                this.currentDestinationIndex = 0;
                this.isRouteActive = false;
                this.routePolylines = [];
                this.styledSegments = []; // For styled route segments
                this.transportMode = 'foot'; // Default to walking
                
                // Enhanced navigation tracking
                this.visitedDestinations = []; // Track visited pandals with timestamps
                this.arrivalDetectionRadius = 0.04; // 40 meters in kilometers
                this.autoArrivalEnabled = true; // Enable automatic arrival detection
                this.lastNotificationTime = 0; // Prevent spam notifications
                this.routeStartTime = null; // Track when route started
                this.destinationArrivalTimes = []; // Track arrival times for each destination
                
                this.init();
            }

            init() {
                this.loadPandalData();
                this.initMap();
                this.bindEvents();
                this.renderPandalCards();
            }

            setLocation(location) {
                this.selectedLocation = location;
                this.loadPandalData(); // Reload data with location filter
                this.clearMap();
                this.addPandalMarkers();
                this.renderPandalCards();
                
                // Update map center based on location
                if (location === 'kolkata') {
                    this.map.setView([22.5726, 88.3639], 12);
                } else if (location === 'kalyani') {
                    this.map.setView([22.9751, 88.4345], 14);
                } else if (location === 'chuchura') {
                    this.map.setView([22.9034, 88.3967], 14);
                } else if (location === 'bandel') {
                    this.map.setView([22.9245, 88.3798], 14);
                }
            }

            loadPandalData() {
                // All pandals data with location field
                const allPandals = [
                    {
                        id: 1,
                        name: "Bagbazar Sarbojanin",
                        lat: 22.5958,
                        lng: 88.3639,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "One of the oldest and most famous pandals in Kolkata",
                        timings: "24 hours",
                        specialFeatures: "Traditional craftsmanship, Cultural programs",
                        rating: 4.8,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    {
                        id: 2,
                        name: "Kumortuli Park",
                        lat: 22.5942,
                        lng: 88.3678,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Famous for traditional idol making area",
                        timings: "5 AM - 12 AM",
                        specialFeatures: "Potter's colony, Traditional art",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "No parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    {
                        id: 3,
                        name: "Bosepukur Sitala Mandir",
                        lat: 22.5123,
                        lng: 88.3515,
                        area: "South",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Known for innovative themes and grand decorations",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Theme-based decorations, Light shows",
                        rating: 4.9,
                        crowdLevel: "Very High",
                        parkingAvailable: "Paid parking available",
                        nearestMetro: "Kasba"
                    },
                    {
                        id: 4,
                        name: "Santosh Mitra Square",
                        lat: 22.5629,
                        lng: 88.3433,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Famous for traditional pandal with massive crowds",
                        timings: "24 hours",
                        specialFeatures: "Traditional architecture, Cultural programs",
                        rating: 4.7,
                        crowdLevel: "Very High",
                        parkingAvailable: "No parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 5,
                        name: "College Square",
                        lat: 22.5726,
                        lng: 88.3586,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "One of the most famous and oldest pandals in Kolkata",
                        timings: "24 hours",
                        specialFeatures: "Heritage pandal, Traditional ceremonies",
                        rating: 4.8,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Mahatma Gandhi Road"
                    },
                    {
                        id: 6,
                        name: "Mohammad Ali Park",
                        lat: 22.5835,
                        lng: 88.3567,
                        area: "Central",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Known for innovative themes and modern decorations",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Modern themes, Art installations",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Paid parking nearby",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 7,
                        name: "Triangular Park (Gariahat)",
                        lat: 22.5154,
                        lng: 88.3659,
                        area: "South",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Popular South Kolkata pandal with creative themes",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Shopping area nearby, Theme decorations",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Mall parking available",
                        nearestMetro: "Rabindra Sarobar"
                    },
                    {
                        id: 8,
                        name: "Suruchi Sangha (New Alipore)",
                        lat: 22.5089,
                        lng: 88.3267,
                        area: "South",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Famous for elaborate theme-based decorations",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Award-winning themes, Professional decoration",
                        rating: 4.9,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Netaji Bhawan"
                    },
                    {
                        id: 9,
                        name: "Chetla Agrani Club",
                        lat: 22.5245,
                        lng: 88.3398,
                        area: "South",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Famous for traditional celebrations and community participation",
                        timings: "5 AM - 12 AM",
                        specialFeatures: "Community involvement, Traditional customs",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Netaji Bhawan"
                    },
                    {
                        id: 10,
                        name: "Deshapriya Park",
                        lat: 22.5298,
                        lng: 88.3567,
                        area: "South",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Known for innovative and award-winning themes",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Award-winning pandal, Innovative themes",
                        rating: 4.8,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Kalighat"
                    },
                    {
                        id: 11,
                        name: "Ballygunge Cultural Association",
                        lat: 22.5345,
                        lng: 88.3634,
                        area: "South",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Heritage pandal with traditional Bengali culture",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Cultural programs, Traditional architecture",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Rabindra Sarobar"
                    },
                    {
                        id: 12,
                        name: "Mudiali Club",
                        lat: 22.5789,
                        lng: 88.3723,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Famous North Kolkata pandal with rich heritage",
                        timings: "24 hours",
                        specialFeatures: "Heritage pandal, Traditional customs",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "No parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 13,
                        name: "Hatibagan Nabin Pally",
                        lat: 22.5923,
                        lng: 88.3598,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "One of the oldest pandals in North Kolkata",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Historical significance, Traditional decorations",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Shyama Charan"
                    },
                    {
                        id: 14,
                        name: "Sreebhumi Sporting Club",
                        lat: 22.5678,
                        lng: 88.4123,
                        area: "East",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Famous for grand theme-based decorations and replica monuments",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Monument replicas, Grand themes",
                        rating: 4.9,
                        crowdLevel: "Very High",
                        parkingAvailable: "Paid parking available",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 15,
                        name: "Jodhpur Park",
                        lat: 22.5012,
                        lng: 88.3789,
                        area: "South",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Known for creative themes and modern artistic approach",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Artistic themes, Modern decoration",
                        rating: 4.7,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking available",
                        nearestMetro: "Joka"
                    },
                    {
                        id: 16,
                        name: "66 Palli (Saltlake)",
                        lat: 22.5789,
                        lng: 88.4234,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Popular Saltlake pandal with traditional celebrations",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Modern locality, Traditional celebrations",
                        rating: 4.5,
                        crowdLevel: "Medium",
                        parkingAvailable: "Ample parking",
                        nearestMetro: "Bidhannagar"
                    },
                    {
                        id: 17,
                        name: "Shib Mandir (Tollygunge)",
                        lat: 22.4789,
                        lng: 88.3567,
                        area: "South",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Traditional South Kolkata pandal with spiritual significance",
                        timings: "5 AM - 10 PM",
                        specialFeatures: "Spiritual significance, Traditional rituals",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Tollygunge"
                    },
                    {
                        id: 18,
                        name: "Behala Nutan Dal",
                        lat: 22.4923,
                        lng: 88.3145,
                        area: "South",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Popular Behala pandal known for innovative themes",
                        timings: "6 AM - 11 PM",
                        specialFeatures: "Innovative themes, Community participation",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Behala Chowrasta"
                    },
                    {
                        id: 19,
                        name: "Badamtala Ashar Sangha",
                        lat: 22.5567,
                        lng: 88.3823,
                        area: "East",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Famous for unique and creative theme-based pandals",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Creative themes, Professional decoration",
                        rating: 4.8,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 20,
                        name: "Hindustan Park",
                        lat: 22.5234,
                        lng: 88.3678,
                        area: "South",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Heritage pandal in South Kolkata with traditional celebrations",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Heritage value, Traditional customs",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Park available",
                        nearestMetro: "Rabindra Sarobar"
                    },
                    // Salt Lake Pandals
                    {
                        id: 21,
                        name: "AJ Block Durga Puja 2025",
                        lat: 22.5913,
                        lng: 88.4287,
                        area: "Salt Lake",
                        location: "kolkata",
                        theme: "Modern",
                        description: "AJ Block Sector II pandal with contemporary celebrations",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Modern decorations, Community participation",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Block parking available",
                        nearestMetro: "Salt Lake Stadium"
                    },
                    {
                        id: 22,
                        name: "BD Block Sarbojanin Durgotsab Committee 2025",
                        lat: 22.5950,
                        lng: 88.4060,
                        area: "Salt Lake",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "BD Block Sector I/II traditional Durga Puja celebration",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Traditional customs, Sarbojanin celebration",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Block parking available",
                        nearestMetro: "Salt Lake Stadium"
                    },
                    {
                        id: 23,
                        name: "BJ Block Saradotsav Committee 2025",
                        lat: 22.5912,
                        lng: 88.4264,
                        area: "Salt Lake",
                        location: "kolkata",
                        theme: "Cultural",
                        description: "BJ Block Sector II Saradotsav with cultural programs",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Cultural events, Community programs",
                        rating: 4.2,
                        crowdLevel: "Medium",
                        parkingAvailable: "Block parking available",
                        nearestMetro: "Salt Lake Stadium"
                    },
                    {
                        id: 24,
                        name: "BL Block Durga Puja 2025",
                        lat: 22.5844,
                        lng: 88.4300,
                        area: "Salt Lake",
                        location: "kolkata",
                        theme: "Modern",
                        description: "BL Block Sector II modern Durga Puja celebration",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Modern theme, Youth participation",
                        rating: 4.1,
                        crowdLevel: "Medium",
                        parkingAvailable: "Block parking available",
                        nearestMetro: "Salt Lake Stadium"
                    },
                    {
                        id: 25,
                        name: "Prafulla Kanan Sarbojanin Durgotsab 2025",
                        lat: 22.5955,
                        lng: 88.4240,
                        area: "Salt Lake",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Prafulla Kanan Kestopur area traditional celebration",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Traditional rituals, Garden setting",
                        rating: 4.5,
                        crowdLevel: "Medium",
                        parkingAvailable: "Area parking available",
                        nearestMetro: "Salt Lake Stadium"
                    },
                    // Kalyani Pandals
                    {
                        id: 26,
                        name: "Kalyani ITI More (Luminous Club)",
                        lat: 22.9751,
                        lng: 88.4345,
                        area: "Kalyani",
                        location: "kalyani",
                        theme: "Theme-based",
                        description: "Famous pandal that won Governor's Durga Ratna award for grandeur and visual delight",
                        timings: "24 hours",
                        specialFeatures: "Governor's Durga Ratna award winner, Visual delight",
                        rating: 4.9,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Kalyani Ghoshpara"
                    },
                    {
                        id: 27,
                        name: "Kalyani RathTala Sarbojanin Durga Puja Committee",
                        lat: 22.9801,
                        lng: 88.4298,
                        area: "Kalyani",
                        location: "kalyani",
                        theme: "Traditional",
                        description: "A beautiful pandal which celebrates the spirit of the 5 days",
                        timings: "24 hours",
                        specialFeatures: "Traditional celebrations, Community spirit",
                        rating: 4.7,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking available",
                        nearestMetro: "Kalyani Ghoshpara"
                    },
                    {
                        id: 28,
                        name: "Kalyani C-8 Sarbojanin Durga Puja",
                        lat: 22.9689,
                        lng: 88.4312,
                        area: "Kalyani",
                        location: "kalyani",
                        theme: "Traditional",
                        description: "One of the oldest pandals in Kalyani township, notable for its heritage",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Heritage value, Traditional decorations",
                        rating: 4.5,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Kalyani Ghoshpara"
                    },
                    {
                        id: 29,
                        name: "A-9 Square Park, Kalyani",
                        lat: 22.9823,
                        lng: 88.4356,
                        area: "Kalyani",
                        location: "kalyani",
                        theme: "Modern",
                        description: "Modern pandal with contemporary themes and decorations",
                        timings: "6 AM - 11 PM",
                        specialFeatures: "Modern themes, Contemporary art",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Park available",
                        nearestMetro: "Kalyani Ghoshpara"
                    },
                    {
                        id: 25,
                        name: "Kalyani Boat Park (B-9)",
                        lat: 22.9734,
                        lng: 88.4289,
                        area: "Kalyani",
                        location: "kalyani",
                        theme: "Theme-based",
                        description: "Listed among top 5 pandals in Kalyani for 2024",
                        timings: "24 hours",
                        specialFeatures: "Top-rated pandal, Boat park setting",
                        rating: 4.8,
                        crowdLevel: "High",
                        parkingAvailable: "Ample parking",
                        nearestMetro: "Kalyani Ghoshpara"
                    },
                    {
                        id: 30,
                        name: "Kalyani A-2 Football Ground",
                        lat: 22.9812,
                        lng: 88.4278,
                        area: "Kalyani",
                        location: "kalyani",
                        theme: "Sports",
                        description: "Unique sports-themed pandal at the football ground",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Sports theme, Football ground setting",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Large parking area",
                        nearestMetro: "Kalyani Ghoshpara"
                    },
                    // Chuchura Pandals
                    {
                        id: 31,
                        name: "Chapatola",
                        lat: 22.882869093272767,
                        lng: 88.39036723632421,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Historic pandal in the heart of Chuchura",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Traditional decorations, Heritage location",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 32,
                        name: "Panchanan Tala",
                        lat: 22.882903853779748,
                        lng: 88.39135520748854,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Famous Chuchura pandal with traditional celebrations",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Traditional customs, Community participation",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 33,
                        name: "Shyambabur Ghat",
                        lat: 22.880540525294993,
                        lng: 88.39530424666262,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Riverside pandal with beautiful ghat location",
                        timings: "5 AM - 10 PM",
                        specialFeatures: "Riverside location, Scenic views",
                        rating: 4.6,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 34,
                        name: "Swanderswar Tala",
                        lat: 22.881319997121413,
                        lng: 88.39715212584262,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Historic pandal with traditional architecture",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Historic significance, Traditional art",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 35,
                        name: "Kamar Para",
                        lat: 22.88245427816954,
                        lng: 88.39413782838037,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Local community pandal with traditional celebrations",
                        timings: "6 AM - 10 PM",
                        specialFeatures: "Community spirit, Local traditions",
                        rating: 4.2,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 36,
                        name: "Kanaksali",
                        lat: 22.87991597945041,
                        lng: 88.39093003550116,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Traditional pandal with cultural programs",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Cultural events, Traditional music",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 37,
                        name: "Boloram Goli",
                        lat: 22.882814925307496,
                        lng: 88.39176488264559,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Small but vibrant local pandal",
                        timings: "6 AM - 10 PM",
                        specialFeatures: "Local community, Intimate setting",
                        rating: 4.1,
                        crowdLevel: "Low",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 38,
                        name: "Madhabitola",
                        lat: 22.884684791685007,
                        lng: 88.39723039399564,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Historic pandal with traditional Bengali culture",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Bengali traditions, Cultural heritage",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 39,
                        name: "Choumatha",
                        lat: 22.894905197597794,
                        lng: 88.39107552428284,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Central location pandal with traditional celebrations",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Central location, Easy access",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 40,
                        name: "Ajad Hind Club",
                        lat: 22.89203515596628,
                        lng: 88.40347267865319,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Club organized pandal with good management",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Well organized, Club management",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Club parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 41,
                        name: "Akhan Bajar",
                        lat: 22.890440038510857,
                        lng: 88.39982042468122,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Market area pandal with bustling atmosphere",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Market location, Bustling atmosphere",
                        rating: 4.2,
                        crowdLevel: "High",
                        parkingAvailable: "Market parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 42,
                        name: "Peyara Bagan",
                        lat: 22.896805464571244,
                        lng: 88.39109203393008,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Garden area pandal with natural surroundings",
                        timings: "6 AM - 10 PM",
                        specialFeatures: "Garden setting, Natural beauty",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Garden parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 43,
                        name: "Beguntola",
                        lat: 22.899438578389063,
                        lng: 88.3892728050945,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Traditional pandal with local community involvement",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Community involvement, Local traditions",
                        rating: 4.1,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 44,
                        name: "Karbala",
                        lat: 22.901208860397222,
                        lng: 88.38993730933902,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Historic pandal with cultural significance",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Historic significance, Cultural heritage",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Chuchura"
                    },
                    {
                        id: 41,
                        name: "3 No Gate",
                        lat: 22.8978,
                        lng: 88.3956,
                        area: "Chuchura",
                        location: "chuchura",
                        theme: "Traditional",
                        description: "Gate area pandal with easy accessibility",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Easy access, Gate location",
                        rating: 4.2,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Chuchura"
                    },
                    // Bandel Pandals
                    {
                        id: 45,
                        name: "Ujjal Sangha",
                        lat: 22.9234,
                        lng: 88.3789,
                        area: "Bandel",
                        location: "bandel",
                        theme: "Traditional",
                        description: "Famous Bandel pandal with traditional celebrations",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Heritage location, Traditional customs",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Bandel"
                    },
                    {
                        id: 46,
                        name: "Nabin Sangha",
                        lat: 22.9267,
                        lng: 88.3812,
                        area: "Bandel",
                        location: "bandel",
                        theme: "Traditional",
                        description: "Historic pandal with cultural heritage",
                        timings: "5 AM - 11 PM",
                        specialFeatures: "Cultural heritage, Historic significance",
                        rating: 4.5,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Bandel"
                    },
                    {
                        id: 47,
                        name: "Kailash Nagar",
                        lat: 22.9245,
                        lng: 88.3798,
                        area: "Bandel",
                        location: "bandel",
                        theme: "Traditional",
                        description: "Residential area pandal with community spirit",
                        timings: "6 AM - 10 PM",
                        specialFeatures: "Residential area, Community participation",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Residential parking",
                        nearestMetro: "Bandel"
                    },
                    // Additional Central Kolkata Pandals
                    {
                        id: 45,
                        name: "14 Pally Udayan Sangha",
                        lat: 22.5745,
                        lng: 88.3598,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Popular Central Kolkata pandal with traditional celebrations",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Traditional decorations, Community participation",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Mahatma Gandhi Road"
                    },
                    {
                        id: 46,
                        name: "37 Pally Sarbojanin Durgotsab",
                        lat: 22.5712,
                        lng: 88.3556,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Community-driven pandal in Central Kolkata",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Community involvement, Traditional customs",
                        rating: 4.5,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Mahatma Gandhi Road"
                    },
                    {
                        id: 47,
                        name: "47 Pally Jubak Brinda Durga Puja",
                        lat: 22.5698,
                        lng: 88.3589,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Youth-organized pandal with vibrant celebrations",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Youth participation, Cultural programs",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Mahatma Gandhi Road"
                    },
                    {
                        id: 48,
                        name: "Central Calcutta Youth Association",
                        lat: 22.5681,
                        lng: 88.3634,
                        area: "Central",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Youth association pandal with modern themes",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Youth culture, Modern themes",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Paid parking nearby",
                        nearestMetro: "Chandni Chowk"
                    },
                    {
                        id: 49,
                        name: "Entally Matribhumi Durga Puja",
                        lat: 22.5867,
                        lng: 88.3689,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Famous Entally area pandal with traditional charm",
                        timings: "5 AM - 12 AM",
                        specialFeatures: "Traditional ceremonies, Heritage location",
                        rating: 4.7,
                        crowdLevel: "High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 50,
                        name: "Entally Sarbojanin Sri Sri Durga Puja",
                        lat: 22.5889,
                        lng: 88.3712,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Community pandal in historic Entally area",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Historic area, Community spirit",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 51,
                        name: "Interact Club of Chowringhee High School Sarbojanin Durga Puja",
                        lat: 22.5534,
                        lng: 88.3598,
                        area: "Central",
                        location: "kolkata",
                        theme: "Educational",
                        description: "School-organized pandal with educational themes",
                        timings: "7 AM - 11 PM",
                        specialFeatures: "Educational themes, Student participation",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "School parking",
                        nearestMetro: "Park Street"
                    },
                    {
                        id: 52,
                        name: "Kanai Dhar Lane Adhibasi Brinda",
                        lat: 22.5756,
                        lng: 88.3567,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Lane-based community pandal with local charm",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Local community, Traditional setup",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "No parking",
                        nearestMetro: "Mahatma Gandhi Road"
                    },
                    {
                        id: 53,
                        name: "Machua Bazar Sarbajanik Durga Puja Samity",
                        lat: 22.5823,
                        lng: 88.3634,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Market area pandal with traditional celebrations",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Market area, Traditional decorations",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 54,
                        name: "New Market Sarbojanin Sri Sri Durga Puja",
                        lat: 22.5567,
                        lng: 88.3523,
                        area: "Central",
                        location: "kolkata",
                        theme: "Commercial",
                        description: "Famous New Market area pandal with shopping nearby",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Shopping area, Commercial district",
                        rating: 4.6,
                        crowdLevel: "Very High",
                        parkingAvailable: "Paid parking available",
                        nearestMetro: "Esplanade"
                    },
                    {
                        id: 55,
                        name: "Pallir Yubak Brinda Durga Puja",
                        lat: 22.5734,
                        lng: 88.3612,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Youth group pandal with vibrant atmosphere",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Youth organization, Cultural events",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Mahatma Gandhi Road"
                    },
                    {
                        id: 56,
                        name: "Shishu Palan Foundation",
                        lat: 22.5645,
                        lng: 88.3645,
                        area: "Central",
                        location: "kolkata",
                        theme: "Social",
                        description: "Foundation-organized pandal with social welfare focus",
                        timings: "7 AM - 11 PM",
                        specialFeatures: "Social welfare, Child care activities",
                        rating: 4.5,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Chandni Chowk"
                    },
                    {
                        id: 57,
                        name: "Wellington Nagarik Kalyan Samity Durga Puja",
                        lat: 22.5612,
                        lng: 88.3578,
                        area: "Central",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Civic welfare organization pandal with community focus",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Civic welfare, Community development",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Park Street"
                    },
                    // East Kolkata Pandals
                    {
                        id: 58,
                        name: "Beleghata Sarkar Bazar Durga Puja",
                        lat: 22.5823,
                        lng: 88.3945,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Popular East Kolkata pandal in Beleghata area",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Traditional celebrations, Local community",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 59,
                        name: "Beliaghata 33 Palli Durga Puja",
                        lat: 22.5812,
                        lng: 88.3923,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Community pandal in Beliaghata locality",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Community involvement, Traditional setup",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 60,
                        name: "EKTP Phase 2 Abasik Puja Samity",
                        lat: 22.5756,
                        lng: 88.4123,
                        area: "East",
                        location: "kolkata",
                        theme: "Residential",
                        description: "Residential complex pandal in East Kolkata Township",
                        timings: "6 AM - 11 PM",
                        specialFeatures: "Residential community, Modern setup",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Complex parking",
                        nearestMetro: "New Town"
                    },
                    {
                        id: 61,
                        name: "Jawpur Bayam Samity Durga Puja",
                        lat: 22.5689,
                        lng: 88.4089,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Local samity pandal in Jawpur area",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Local traditions, Community participation",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "New Town"
                    },
                    {
                        id: 62,
                        name: "Judge Bagan Sarbojanin Durgotsab",
                        lat: 22.5534,
                        lng: 88.3867,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Historic Judge Bagan area pandal with heritage charm",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Heritage location, Traditional ceremonies",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 63,
                        name: "Kanjial Para Puja Samity Durga Puja",
                        lat: 22.5645,
                        lng: 88.3998,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Para-based community pandal in East Kolkata",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Para community, Local customs",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "No parking",
                        nearestMetro: "Park Circus"
                    },
                    {
                        id: 64,
                        name: "Nabapally Adhibashi Brinda Durga Puja",
                        lat: 22.5723,
                        lng: 88.4056,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Adhibashi brinda pandal with cultural focus",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Cultural programs, Traditional setup",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Park Circus"
                    },
                    {
                        id: 65,
                        name: "Netaji Sporting Club Durga Puja",
                        lat: 22.5567,
                        lng: 88.3912,
                        area: "East",
                        location: "kolkata",
                        theme: "Sports",
                        description: "Sporting club organized pandal with sports theme",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Sports club, Athletic events",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Club parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 66,
                        name: "Purba Kalikata Sarbojanin Durgotsav",
                        lat: 22.5612,
                        lng: 88.3934,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "East Kolkata regional pandal with grand celebrations",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Regional pandal, Grand decorations",
                        rating: 4.7,
                        crowdLevel: "Very High",
                        parkingAvailable: "Paid parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 67,
                        name: "Purbanchal Prabhati Sangha Durga Puja",
                        lat: 22.5698,
                        lng: 88.4012,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Morning assembly group pandal in eastern area",
                        timings: "5 AM - 12 AM",
                        specialFeatures: "Morning programs, Cultural activities",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Park Circus"
                    },
                    {
                        id: 68,
                        name: "Sixemes Cooperative Housing Durgotsav",
                        lat: 22.5745,
                        lng: 88.4089,
                        area: "East",
                        location: "kolkata",
                        theme: "Residential",
                        description: "Cooperative housing society pandal with modern approach",
                        timings: "6 AM - 11 PM",
                        specialFeatures: "Housing society, Modern facilities",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Society parking",
                        nearestMetro: "New Town"
                    },
                    {
                        id: 69,
                        name: "Sree Sree Durga Puja Committee, Rabindrapally",
                        lat: 22.5534,
                        lng: 88.3845,
                        area: "East",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Rabindrapally area pandal with traditional worship",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Traditional worship, Cultural heritage",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sealdah"
                    },
                    // North Kolkata Pandals - Batch 1
                    {
                        id: 70,
                        name: "31 Pally Sadharan Durgotsab Samity",
                        lat: 22.6156,
                        lng: 88.3698,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Local pally pandal in North Kolkata",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Community participation, Traditional setup",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 71,
                        name: "Ahiritola Jubak Brinda Durga Puja",
                        lat: 22.5923,
                        lng: 88.3567,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Youth group pandal in historic Ahiritola area",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Youth participation, Historic location",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 72,
                        name: "Amherst Sarbojanin Durgotsab",
                        lat: 22.5845,
                        lng: 88.3623,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Amherst Street area pandal with heritage value",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Heritage street, Traditional ceremonies",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 73,
                        name: "Aswiningar Sarbojanin Durgotsav",
                        lat: 22.6123,
                        lng: 88.3745,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Community pandal in Aswiningar locality",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Local community, Traditional customs",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "No parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 74,
                        name: "Baghbazar Palli Puja O Pradarshani",
                        lat: 22.5967,
                        lng: 88.3634,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Famous Baghbazar area pandal with exhibition",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Exhibition, Traditional art",
                        rating: 4.7,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    {
                        id: 75,
                        name: "Bandhudal Durgotsob",
                        lat: 22.6089,
                        lng: 88.3712,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Brotherhood group pandal in North Kolkata",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Brotherhood theme, Community unity",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 76,
                        name: "Beadon Street Sarbojanin Durgotsav",
                        lat: 22.5812,
                        lng: 88.3598,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Historic Beadon Street pandal with traditional charm",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Historic street, Traditional setup",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 77,
                        name: "Belgachia Sadharan Durgotsab",
                        lat: 22.6234,
                        lng: 88.3812,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Community pandal in Belgachia area",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Community involvement, Traditional customs",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Belgachia"
                    },
                    {
                        id: 78,
                        name: "Belgachia Yuba Sammilani Durga Puja",
                        lat: 22.6245,
                        lng: 88.3834,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Youth assembly pandal in Belgachia",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Youth assembly, Cultural programs",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Belgachia"
                    },
                    {
                        id: 79,
                        name: "Bhagabati Park Durga Puja Committee",
                        lat: 22.6012,
                        lng: 88.3687,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Park-based pandal with spacious setup",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Park location, Open space",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Park parking",
                        nearestMetro: "Shyama Charan"
                    },
                    // North Kolkata Pandals - Batch 2
                    {
                        id: 80,
                        name: "Bharatiya Tarun Sangha Durga Puja",
                        lat: 22.5978,
                        lng: 88.3654,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Youth organization pandal with patriotic theme",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Youth organization, Patriotic theme",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    {
                        id: 81,
                        name: "Biswanath Apartment Sharodutsab",
                        lat: 22.6067,
                        lng: 88.3723,
                        area: "North",
                        location: "kolkata",
                        theme: "Residential",
                        description: "Apartment complex pandal with modern setup",
                        timings: "6 AM - 11 PM",
                        specialFeatures: "Apartment complex, Modern facilities",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Apartment parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 82,
                        name: "Brindaban Matri Mandir Durga Puja",
                        lat: 22.5934,
                        lng: 88.3589,
                        area: "North",
                        location: "kolkata",
                        theme: "Religious",
                        description: "Temple-based pandal with religious significance",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Temple location, Religious ceremonies",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Temple parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 83,
                        name: "Calcutta Youth Forum",
                        lat: 22.5856,
                        lng: 88.3612,
                        area: "North",
                        location: "kolkata",
                        theme: "Modern",
                        description: "Youth forum pandal with contemporary themes",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Youth forum, Contemporary themes",
                        rating: 4.4,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 84,
                        name: "Campbagan Sadharan Durgotsav",
                        lat: 22.6145,
                        lng: 88.3756,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Campbagan area pandal with traditional setup",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Traditional setup, Local community",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 85,
                        name: "Chaltabagan Lohapatty Durga Puja",
                        lat: 22.5923,
                        lng: 88.3545,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Chaltabagan area pandal in historic locality",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Historic locality, Traditional customs",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 86,
                        name: "Charer Palli Sarbojanin Durgotsab",
                        lat: 22.6089,
                        lng: 88.3689,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Char area community pandal with river proximity",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "River proximity, Community involvement",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "No parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 87,
                        name: "Chorebagan Sarbojanin Durgotsab Samity",
                        lat: 22.5945,
                        lng: 88.3567,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Chorebagan area pandal with heritage value",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Heritage area, Traditional ceremonies",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 88,
                        name: "Cossipore Shakti Sangha Durga Puja",
                        lat: 22.6267,
                        lng: 88.3745,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Cossipore area pandal with Shakti worship focus",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Shakti worship, Traditional rituals",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Cossipore"
                    },
                    {
                        id: 89,
                        name: "Dakshin Rabindrapally Sarbojanin Durga Puja",
                        lat: 22.5512,
                        lng: 88.3823,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "South Rabindrapally area pandal with cultural focus",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Cultural focus, Community participation",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    // North Kolkata Pandals - Batch 3 (continuing with the large list)
                    {
                        id: 90,
                        name: "Darjeepara Sarbojanin Durgotsab Samity",
                        lat: 22.6156,
                        lng: 88.3723,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Darjeepara area community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Community samity, Traditional setup",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 91,
                        name: "Deshbandhunagar Sarbojanin Durgotsab",
                        lat: 22.6123,
                        lng: 88.3689,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Patriotic themed pandal in Deshbandhunagar",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Patriotic theme, Community involvement",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 92,
                        name: "Dum Dum Park Bharat Chakra Durga Puja",
                        lat: 22.6298,
                        lng: 88.4012,
                        area: "North",
                        location: "kolkata",
                        theme: "Patriotic",
                        description: "Patriotic themed pandal in Dum Dum Park",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Patriotic theme, Park location",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Park parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 93,
                        name: "Dum Dum Park Sarbojanin Durga Puja",
                        lat: 22.6312,
                        lng: 88.4034,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Community pandal in Dum Dum Park area",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Park area, Community participation",
                        rating: 4.7,
                        crowdLevel: "Very High",
                        parkingAvailable: "Park parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 94,
                        name: "Durbar Mahila Samanya Committee",
                        lat: 22.5834,
                        lng: 88.3634,
                        area: "North",
                        location: "kolkata",
                        theme: "Women Empowerment",
                        description: "Women's committee pandal with empowerment theme",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Women empowerment, Social awareness",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 95,
                        name: "Garden Lane Sarbojanin Durgotsab",
                        lat: 22.5912,
                        lng: 88.3612,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Garden Lane area pandal with green theme",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Green theme, Lane community",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 96,
                        name: "Goabagan Sarodatsav Sammilani Durga Puja",
                        lat: 22.5998,
                        lng: 88.3678,
                        area: "North",
                        location: "kolkata",
                        theme: "Cultural",
                        description: "Cultural festival pandal in Goabagan",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Cultural festival, Music programs",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Shyama Charan"
                    },
                    {
                        id: 97,
                        name: "Golaghata Sammilani Durga Puja",
                        lat: 22.6045,
                        lng: 88.3734,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Golaghata area assembly pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Assembly group, Traditional customs",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "No parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 98,
                        name: "Grey Street Sarbojanin Durga Puja",
                        lat: 22.5823,
                        lng: 88.3589,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Grey Street area pandal with street community",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Street community, Traditional setup",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 99,
                        name: "Halsibagan Sarbojanin Durgotsab",
                        lat: 22.6234,
                        lng: 88.3789,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Halsibagan area community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Local community, Traditional celebrations",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Belgachia"
                    },
                    // North Kolkata Pandals - Final Batch (Key remaining pandals)
                    {
                        id: 100,
                        name: "Hari Ghosh Street Sarbojanin",
                        lat: 22.5889,
                        lng: 88.3645,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Historic Hari Ghosh Street pandal",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Historic street, Traditional ceremonies",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 101,
                        name: "Kumartuli Park Sarbojanin Durgotsab Committee",
                        lat: 22.5945,
                        lng: 88.3689,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Kumartuli potter's area pandal with traditional craftsmanship",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Potter's area, Traditional idol making",
                        rating: 4.8,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    {
                        id: 102,
                        name: "Kumartuli Sarbojanin Durgotsab",
                        lat: 22.5956,
                        lng: 88.3698,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Another famous Kumartuli area pandal",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Traditional art, Idol making heritage",
                        rating: 4.7,
                        crowdLevel: "Very High",
                        parkingAvailable: "No parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    {
                        id: 103,
                        name: "Shyambazar Nabin Sangha Durga Puja",
                        lat: 22.5867,
                        lng: 88.3567,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Famous Shyambazar area pandal with heritage value",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Heritage area, Traditional customs",
                        rating: 4.7,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited street parking",
                        nearestMetro: "Shyambazar"
                    },
                    {
                        id: 104,
                        name: "Sovabazar Sarbojanin Durgotsav",
                        lat: 22.5823,
                        lng: 88.3534,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Historic Sovabazar area pandal with royal heritage",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Royal heritage, Historic significance",
                        rating: 4.8,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 105,
                        name: "Sreebhumi Sporting Club Durga Puja",
                        lat: 22.6456,
                        lng: 88.4123,
                        area: "North",
                        location: "kolkata",
                        theme: "Theme-based",
                        description: "Famous Sreebhumi sporting club with grand themes",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Grand themes, Sporting club",
                        rating: 4.9,
                        crowdLevel: "Very High",
                        parkingAvailable: "Club parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 106,
                        name: "Tala Barowari Durgotsab",
                        lat: 22.6089,
                        lng: 88.3656,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Tala area community pandal with local charm",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Local community, Traditional setup",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 107,
                        name: "Ultadanga Jagarani Sangha Durga Puja",
                        lat: 22.5734,
                        lng: 88.3934,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Ultadanga area awakening group pandal",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Awakening theme, Community spirit",
                        rating: 4.6,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Ultadanga"
                    },
                    {
                        id: 108,
                        name: "Ultadanga Pallyshree Durga Puja",
                        lat: 22.5745,
                        lng: 88.3912,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Ultadanga neighborhood beauty pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Neighborhood beauty, Community pride",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Ultadanga"
                    },
                    {
                        id: 109,
                        name: "Young Citizens Club Durga Puja",
                        lat: 22.5978,
                        lng: 88.3623,
                        area: "North",
                        location: "kolkata",
                        theme: "Modern",
                        description: "Young citizens club with modern approach",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Young citizens, Modern themes",
                        rating: 4.4,
                        crowdLevel: "High",
                        parkingAvailable: "Club parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    // Additional North Kolkata Pandals - Missing from previous batch
                    {
                        id: 110,
                        name: "Lake View Park Sarbojanin Durgotsav Samity",
                        lat: 22.6123,
                        lng: 88.3812,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Lake view park pandal with scenic beauty",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Lake view, Park setting",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Park parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 111,
                        name: "Mahalla Sarbojanin Durgautsab Samity",
                        lat: 22.5934,
                        lng: 88.3612,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Mahalla community pandal with local traditions",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Mahalla community, Local traditions",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 112,
                        name: "Mitali Kankurgachi Durga Puja",
                        lat: 22.5756,
                        lng: 88.3923,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Friendship themed pandal in Kankurgachi area",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Friendship theme, Community bonding",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Ultadanga"
                    },
                    {
                        id: 113,
                        name: "Mohan Bagan Barwari Durga Puja",
                        lat: 22.6034,
                        lng: 88.3689,
                        area: "North",
                        location: "kolkata",
                        theme: "Sports",
                        description: "Famous Mohan Bagan area pandal with football heritage",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Football heritage, Sports theme",
                        rating: 4.7,
                        crowdLevel: "Very High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Shyama Charan"
                    },
                    {
                        id: 114,
                        name: "Mondal Para Sporting Club Durga Puja",
                        lat: 22.6012,
                        lng: 88.3712,
                        area: "North",
                        location: "kolkata",
                        theme: "Sports",
                        description: "Sporting club pandal in Mondal Para area",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Sporting club, Athletic activities",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Club parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 115,
                        name: "Nainan Para & Jogendra Basak Road Sarbojanin Shree Shree Durgapuja",
                        lat: 22.5889,
                        lng: 88.3678,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Joint para pandal on Jogendra Basak Road",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Joint para initiative, Traditional worship",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 116,
                        name: "Nalin Sarkar Street Sarbojanin Durgotsab",
                        lat: 22.5823,
                        lng: 88.3612,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Nalin Sarkar Street community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Street community, Traditional setup",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 117,
                        name: "Nimta Boy's Athletic Club Sarbojanin Durgotsav",
                        lat: 22.6434,
                        lng: 88.4156,
                        area: "North",
                        location: "kolkata",
                        theme: "Sports",
                        description: "Boys' athletic club pandal in Nimta",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Athletic club, Youth sports",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Club parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 118,
                        name: "Nimtala Sarbojanin Durgotsab",
                        lat: 22.5912,
                        lng: 88.3534,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Nimtala area community pandal with heritage",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Heritage area, Traditional ceremonies",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 119,
                        name: "North Tangra Durga Puja",
                        lat: 22.5645,
                        lng: 88.3934,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "North Tangra area pandal with Chinese community influence",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Multicultural area, Community harmony",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Park Circus"
                    },
                    {
                        id: 120,
                        name: "North Tridhara Sarbojanin Durga Puja",
                        lat: 22.6089,
                        lng: 88.3734,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "North Tridhara area three-stream community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Three-stream community, Unity theme",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 121,
                        name: "Nutan Pally Sarbojanin Durgotsab",
                        lat: 22.6156,
                        lng: 88.3756,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "New neighborhood community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "New neighborhood, Modern community",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 122,
                        name: "Pathuria Ghata Pancher Palli Sarbojanin",
                        lat: 22.5945,
                        lng: 88.3512,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Pathuria Ghata five-neighborhood joint pandal",
                        timings: "5 AM - 1 AM",
                        specialFeatures: "Five neighborhoods, Joint initiative",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 123,
                        name: "Ramesh Dutta Street Sarbojanin Durgotsab",
                        lat: 22.5867,
                        lng: 88.3589,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Ramesh Dutta Street community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Street community, Traditional customs",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 124,
                        name: "Rammohan Sammilani Durga Puja",
                        lat: 22.5834,
                        lng: 88.3567,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Rammohan assembly pandal with social reform theme",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Social reform theme, Educational focus",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sealdah"
                    },
                    {
                        id: 125,
                        name: "Sadhukhan Bari Durga Puja",
                        lat: 22.5912,
                        lng: 88.3623,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Sadhukhan house pandal with family traditions",
                        timings: "6 AM - 11 PM",
                        specialFeatures: "Family traditions, House pandal",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Sovabazar-Sutanuti"
                    },
                    {
                        id: 126,
                        name: "Sammilita Lalabagan Sarbojanin Durga Puja",
                        lat: 22.6023,
                        lng: 88.3698,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "United Lalabagan area community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "United community, Lalabagan area",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Shyama Charan"
                    },
                    {
                        id: 127,
                        name: "Sarkar Bagan Sammilita Sangha Durga Puja",
                        lat: 22.5978,
                        lng: 88.3645,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Sarkar Bagan united association pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "United association, Community harmony",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Shobhabazar-Sutanuti"
                    },
                    {
                        id: 128,
                        name: "Sater Palli Sarbojanin Durgotsav",
                        lat: 22.6145,
                        lng: 88.3712,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Sater Palli seven-neighborhood community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Seven neighborhoods, Community unity",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 129,
                        name: "Signum Aristo Residential Puja",
                        lat: 22.6234,
                        lng: 88.3867,
                        area: "North",
                        location: "kolkata",
                        theme: "Residential",
                        description: "Residential complex pandal with modern amenities",
                        timings: "6 AM - 11 PM",
                        specialFeatures: "Residential complex, Modern amenities",
                        rating: 4.2,
                        crowdLevel: "Low",
                        parkingAvailable: "Complex parking",
                        nearestMetro: "Belgachia"
                    },
                    {
                        id: 130,
                        name: "Sikdar Bagan Sadharan Durgotsov",
                        lat: 22.6067,
                        lng: 88.3678,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Sikdar Bagan general community celebration",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "General community, Traditional celebration",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 131,
                        name: "Simla Sporting Club Durga Puja",
                        lat: 22.6012,
                        lng: 88.3734,
                        area: "North",
                        location: "kolkata",
                        theme: "Sports",
                        description: "Simla sporting club pandal with hill station theme",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Hill station theme, Sporting activities",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Club parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 132,
                        name: "Tala Dakshin Pally Durgotsav Committee",
                        lat: 22.6078,
                        lng: 88.3645,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "South Tala neighborhood pandal committee",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "South Tala, Neighborhood committee",
                        rating: 4.4,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 133,
                        name: "Tala Park 15 Pally Durga Puja",
                        lat: 22.6098,
                        lng: 88.3667,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Tala Park 15 neighborhood pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Park area, 15 neighborhoods",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Park parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 134,
                        name: "Telengabagan Sarbojanin Durgotsab",
                        lat: 22.6189,
                        lng: 88.3789,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Telengabagan area community pandal",
                        timings: "6 AM - 12 AM",
                        specialFeatures: "Local community, Traditional setup",
                        rating: 4.3,
                        crowdLevel: "Medium",
                        parkingAvailable: "Street parking",
                        nearestMetro: "Dum Dum"
                    },
                    {
                        id: 135,
                        name: "Ultadanga Sangrami Durga Puja",
                        lat: 22.5723,
                        lng: 88.3889,
                        area: "North",
                        location: "kolkata",
                        theme: "Traditional",
                        description: "Ultadanga struggle-themed community pandal",
                        timings: "6 AM - 1 AM",
                        specialFeatures: "Struggle theme, Community resistance",
                        rating: 4.5,
                        crowdLevel: "High",
                        parkingAvailable: "Limited parking",
                        nearestMetro: "Ultadanga"
                    }
                ];

                // Filter pandals based on selected location
                if (this.selectedLocation) {
                    this.pandals = allPandals.filter(pandal => {
                        // If pandal has location field, use it; otherwise assume kolkata
                        const pandalLocation = pandal.location || 'kolkata';
                        return pandalLocation === this.selectedLocation;
                    });
                } else {
                    this.pandals = allPandals; // Show all if no location selected
                }
                
                console.log(`Loaded ${this.pandals.length} pandals for location: ${this.selectedLocation || 'all'}`);
            }

            initMap() {
                // Initialize map centered on Kolkata
                this.map = L.map('map').setView([22.5726, 88.3639], 12);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.map);

                // Add pandal markers
                this.addPandalMarkers();
            }

            clearMap() {
                // Remove all existing markers
                this.markers.forEach(marker => {
                    this.map.removeLayer(marker);
                });
                this.markers = [];
                
                // Clear any existing route lines
                if (this.routeControl) {
                    this.map.removeControl(this.routeControl);
                    this.routeControl = null;
                }
                
                // Clear route polylines if they exist
                if (this.routePolylines) {
                    this.routePolylines.forEach(line => this.map.removeLayer(line));
                    this.routePolylines = [];
                }
                
                // Clear styled segments
                if (this.styledSegments) {
                    this.styledSegments.forEach(segment => this.map.removeLayer(segment));
                    this.styledSegments = [];
                }
            }

            addPandalMarkers() {
                this.pandals.forEach(pandal => {
                    const marker = L.marker([pandal.lat, pandal.lng])
                        .addTo(this.map)
                        .bindPopup(this.createPopupContent(pandal));

                    // Store reference for later use
                    marker.pandalData = pandal;
                    this.markers.push(marker);

                    // Add click event for route planning
                    marker.on('click', () => {
                        this.selectPandalForRoute(pandal);
                    });
                });
            }

            createPopupContent(pandal) {
                return `
                    <div class="custom-popup">
                        <h3>${pandal.name}</h3>
                        <p><strong>Area:</strong> ${pandal.area} Kolkata</p>
                        <p><strong>Timings:</strong> ${pandal.timings}</p>
                        <p><strong>Crowd Level:</strong> ${pandal.crowdLevel}</p>
                        <p><strong>Rating:</strong> ⭐ ${pandal.rating}/5</p>
                        <p><strong>Nearest Metro:</strong> ${pandal.nearestMetro}</p>
                        <p><strong>Parking:</strong> ${pandal.parkingAvailable}</p>
                        <div class="theme-tag">${pandal.theme}</div>
                        <br><br>
                        <button onclick="window.app.addToRoute(${pandal.id})" style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            Add to Route
                        </button>
                    </div>
                `;
            }

            renderPandalCards() {
                const container = document.getElementById('pandal-cards');
                container.innerHTML = '';

                // Group pandals by area
                const pandalsByArea = {};
                this.pandals.forEach(pandal => {
                    if (!pandalsByArea[pandal.area]) {
                        pandalsByArea[pandal.area] = [];
                    }
                    pandalsByArea[pandal.area].push(pandal);
                });

                // Define the order of areas (Kalyani first, then others)
                const areaOrder = ['Kalyani', 'Salt Lake', 'Chuchura', 'Bandel', 'North', 'Central', 'South', 'East', 'West'];
                
                areaOrder.forEach(area => {
                    if (pandalsByArea[area]) {
                        // Create area header
                        const areaHeader = document.createElement('div');
                        areaHeader.style.cssText = `
                            background: linear-gradient(135deg, #d32f2f 0%, #f57c00 100%);
                            color: white;
                            padding: 10px 15px;
                            margin: 20px 0 10px 0;
                            border-radius: 8px;
                            font-weight: bold;
                            font-size: 16px;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        `;
                        
                        let areaTitle = area;
                        if (area === 'Kalyani') {
                            areaTitle = '🏆 Kalyani Special';
                        } else {
                            areaTitle = `${area} Kolkata`;
                        }
                        
                        areaHeader.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${areaTitle}`;
                        container.appendChild(areaHeader);

                        // Add pandals for this area
                        pandalsByArea[area].forEach(pandal => {
                            const card = document.createElement('div');
                            card.className = 'pandal-card';
                            
                            // Special styling for Kalyani pandals
                            if (area === 'Kalyani') {
                                card.style.border = '2px solid #ff6b6b';
                                card.style.background = 'linear-gradient(135deg, #fff8f0 0%, #ffffff 100%)';
                            }
                            
                            // Add distance info if user location is available
                            const distanceInfo = this.userLocation ? 
                                `<p><i class="fas fa-route"></i> ${this.calculateDistance(this.userLocation, pandal).toFixed(1)} km away</p>` : '';
                            
                            card.innerHTML = `
                                <div class="rating">⭐ ${pandal.rating}</div>
                                <h4>${pandal.name}</h4>
                                <p><i class="fas fa-map-marker-alt"></i> ${pandal.area}${pandal.area !== 'Kalyani' ? ' Kolkata' : ''}</p>
                                <p><i class="fas fa-clock"></i> ${pandal.timings}</p>
                                <p><i class="fas fa-users"></i> ${pandal.crowdLevel} crowd</p>
                                <p><i class="fas fa-subway"></i> ${pandal.nearestMetro}</p>
                                ${distanceInfo}
                                <div class="theme">${pandal.theme}</div>
                                <div style="margin-top: 10px; display: flex; gap: 5px;">
                                    <button onclick="window.app.focusOnPandal(${pandal.id})" 
                                            style="background: #2196f3; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; flex: 1;">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button onclick="window.app.quickAddToRoute(${pandal.id})" 
                                            style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; flex: 1;">
                                        <i class="fas fa-plus"></i> Add to Route
                                    </button>
                                </div>
                            `;

                            container.appendChild(card);
                        });
                    }
                });
            }

            filterPandals() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const areaFilter = document.getElementById('area-filter').value;
                const themeFilter = document.getElementById('theme-filter').value;

                const filteredPandals = this.pandals.filter(pandal => {
                    const matchesSearch = pandal.name.toLowerCase().includes(searchTerm) ||
                                        pandal.area.toLowerCase().includes(searchTerm);
                    const matchesArea = !areaFilter || pandal.area === areaFilter;
                    const matchesTheme = !themeFilter || pandal.theme === themeFilter;

                    return matchesSearch && matchesArea && matchesTheme;
                });

                // Hide all markers
                this.markers.forEach(marker => {
                    this.map.removeLayer(marker);
                });

                // Show filtered markers
                this.markers.forEach(marker => {
                    if (filteredPandals.some(p => p.id === marker.pandalData.id)) {
                        this.map.addLayer(marker);
                    }
                });

                // Update pandal cards
                this.renderFilteredCards(filteredPandals);
            }

            renderFilteredCards(pandals) {
                const container = document.getElementById('pandal-cards');
                container.innerHTML = '';

                // Group filtered pandals by area
                const pandalsByArea = {};
                pandals.forEach(pandal => {
                    if (!pandalsByArea[pandal.area]) {
                        pandalsByArea[pandal.area] = [];
                    }
                    pandalsByArea[pandal.area].push(pandal);
                });

                // Define the order of areas (Kalyani first, then others)
                const areaOrder = ['Kalyani', 'Chuchura', 'Bandel', 'North', 'Central', 'South', 'East', 'West'];
                
                areaOrder.forEach(area => {
                    if (pandalsByArea[area]) {
                        // Create area header
                        const areaHeader = document.createElement('div');
                        areaHeader.style.cssText = `
                            background: linear-gradient(135deg, #d32f2f 0%, #f57c00 100%);
                            color: white;
                            padding: 10px 15px;
                            margin: 20px 0 10px 0;
                            border-radius: 8px;
                            font-weight: bold;
                            font-size: 16px;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        `;
                        
                        let areaTitle = area;
                        if (area === 'Kalyani') {
                            areaTitle = '🏆 Kalyani Special';
                        } else {
                            areaTitle = `${area} Kolkata`;
                        }
                        
                        areaHeader.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${areaTitle}`;
                        container.appendChild(areaHeader);

                        // Add pandals for this area
                        pandalsByArea[area].forEach(pandal => {
                            const card = document.createElement('div');
                            card.className = 'pandal-card';
                            
                            // Special styling for Kalyani pandals
                            if (area === 'Kalyani') {
                                card.style.border = '2px solid #ff6b6b';
                                card.style.background = 'linear-gradient(135deg, #fff8f0 0%, #ffffff 100%)';
                            }
                            
                            // Add distance info if user location is available
                            const distanceInfo = this.userLocation ? 
                                `<p><i class="fas fa-route"></i> ${this.calculateDistance(this.userLocation, pandal).toFixed(1)} km away</p>` : '';
                            
                            card.innerHTML = `
                                <div class="rating">⭐ ${pandal.rating}</div>
                                <h4>${pandal.name}</h4>
                                <p><i class="fas fa-map-marker-alt"></i> ${pandal.area}${pandal.area !== 'Kalyani' ? ' Kolkata' : ''}</p>
                                <p><i class="fas fa-clock"></i> ${pandal.timings}</p>
                                <p><i class="fas fa-users"></i> ${pandal.crowdLevel} crowd</p>
                                <p><i class="fas fa-subway"></i> ${pandal.nearestMetro}</p>
                                ${distanceInfo}
                                <div class="theme">${pandal.theme}</div>
                                <div style="margin-top: 10px; display: flex; gap: 5px;">
                                    <button onclick="window.app.focusOnPandal(${pandal.id})" 
                                            style="background: #2196f3; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; flex: 1;">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button onclick="window.app.quickAddToRoute(${pandal.id})" 
                                            style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; flex: 1;">
                                        <i class="fas fa-plus"></i> Add to Route
                                    </button>
                                </div>
                            `;

                            container.appendChild(card);
                        });
                    }
                });
            }

            showAllPandals() {
                // Reset filters
                document.getElementById('search-input').value = '';
                document.getElementById('area-filter').value = '';
                document.getElementById('theme-filter').value = '';

                // Show all markers
                this.markers.forEach(marker => {
                    if (!this.map.hasLayer(marker)) {
                        this.map.addLayer(marker);
                    }
                });

                // Reset view
                this.map.setView([22.5726, 88.3639], 12);
                
                // Render all cards
                this.renderPandalCards();
            }

            selectPandalForRoute(pandal) {
                if (!this.selectedPandals.find(p => p.id === pandal.id)) {
                    this.selectedPandals.push(pandal);
                    this.updateSelectedPandals();
                }
            }

            addToRoute(pandalId) {
                const pandal = this.pandals.find(p => p.id === pandalId);
                if (pandal && !this.selectedPandals.find(p => p.id === pandalId)) {
                    this.selectedPandals.push(pandal);
                    this.updateSelectedPandals();
                }
            }

            updateSelectedPandals() {
                const container = document.getElementById('selected-pandals');
                container.innerHTML = '';

                this.selectedPandals.forEach((pandal, index) => {
                    const div = document.createElement('div');
                    div.className = 'selected-pandal';
                    div.innerHTML = `
                        <span>${index + 1}. ${pandal.name}</span>
                        <button class="remove-pandal" onclick="window.app.removePandal(${pandal.id})">×</button>
                    `;
                    container.appendChild(div);
                });
            }

            removePandal(pandalId) {
                this.selectedPandals = this.selectedPandals.filter(p => p.id !== pandalId);
                this.updateSelectedPandals();
                
                if (this.routeControl) {
                    this.map.removeControl(this.routeControl);
                    this.routeControl = null;
                }
            }

            optimizeRoute() {
                if (this.selectedPandals.length < 2) {
                    alert('Please select at least 2 pandals for route optimization.');
                    return;
                }

                // Simple route optimization using distance (TSP approximation)
                const optimized = this.tspApproximation(this.selectedPandals);
                this.selectedPandals = optimized;
                this.updateSelectedPandals();
                
                // Create route visualization
                this.createRoute();
                this.displayRouteInfo();
            }

            tspApproximation(pandals) {
                if (pandals.length <= 2) return pandals;
                
                console.log('Optimizing route for', pandals.length, 'pandals...');
                
                // Try different starting points and find the best route
                let bestRoute = null;
                let bestDistance = Infinity;
                
                // If user location is available, start from there
                if (this.userLocation) {
                    const userPoint = { lat: this.userLocation.lat, lng: this.userLocation.lng, name: 'Your Location' };
                    bestRoute = this.nearestNeighborTSP(pandals, userPoint);
                    bestDistance = this.calculateTotalRouteDistance(bestRoute);
                } else {
                    // Try starting from each pandal and pick the best route
                    for (let i = 0; i < Math.min(pandals.length, 5); i++) { // Limit to 5 starting points for performance
                        const route = this.nearestNeighborTSP(pandals, pandals[i]);
                        const distance = this.calculateTotalRouteDistance(route);
                        
                        if (distance < bestDistance) {
                            bestDistance = distance;
                            bestRoute = route;
                        }
                    }
                }
                
                // Apply 2-opt improvement to the best route
                const optimizedRoute = this.twoOptImprovement(bestRoute);
                const finalDistance = this.calculateTotalRouteDistance(optimizedRoute);
                
                console.log(`Route optimized: ${bestDistance.toFixed(2)}km → ${finalDistance.toFixed(2)}km (${((bestDistance - finalDistance) / bestDistance * 100).toFixed(1)}% improvement)`);
                
                return optimizedRoute;
            }
            
            nearestNeighborTSP(pandals, startPoint) {
                let optimized = [];
                let remaining = [...pandals];
                let current = startPoint;
                
                // If startPoint is not in pandals list, add it as starting point
                if (!pandals.find(p => p.id === startPoint.id)) {
                    // Don't add user location to the route, just use it as reference
                    if (startPoint.name !== 'Your Location') {
                        optimized = [startPoint];
                        remaining = remaining.filter(p => p.id !== startPoint.id);
                    }
                }

                while (remaining.length > 0) {
                    let nearest = remaining[0];
                    let minDistance = this.calculateDistance(current, nearest);

                    remaining.forEach(pandal => {
                        const distance = this.calculateDistance(current, pandal);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearest = pandal;
                        }
                    });

                    optimized.push(nearest);
                    remaining = remaining.filter(p => p.id !== nearest.id);
                    current = nearest;
                }

                return optimized;
            }
            
            twoOptImprovement(route) {
                if (route.length < 4) return route;
                
                let improved = [...route];
                let bestDistance = this.calculateTotalRouteDistance(improved);
                let foundImprovement = true;
                
                while (foundImprovement) {
                    foundImprovement = false;
                    
                    for (let i = 1; i < route.length - 2; i++) {
                        for (let j = i + 1; j < route.length; j++) {
                            // Create new route by reversing the segment between i and j
                            const newRoute = [
                                ...improved.slice(0, i),
                                ...improved.slice(i, j + 1).reverse(),
                                ...improved.slice(j + 1)
                            ];
                            
                            const newDistance = this.calculateTotalRouteDistance(newRoute);
                            
                            if (newDistance < bestDistance) {
                                improved = newRoute;
                                bestDistance = newDistance;
                                foundImprovement = true;
                            }
                        }
                    }
                }
                
                return improved;
            }
            
            calculateTotalRouteDistance(route) {
                let totalDistance = 0;
                for (let i = 0; i < route.length - 1; i++) {
                    totalDistance += this.calculateDistance(route[i], route[i + 1]);
                }
                return totalDistance;
            }

            calculateDistance(p1, p2) {
                const R = 6371; // Earth's radius in km
                const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                const dLng = (p2.lng - p1.lng) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                          Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            setTransportMode(mode) {
                this.transportMode = mode;
                
                // Update UI to show active mode
                document.querySelectorAll('.transport-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (mode === 'foot') {
                    document.getElementById('mode-walking').classList.add('active');
                } else if (mode === 'driving') {
                    document.getElementById('mode-driving').classList.add('active');
                } else if (mode === 'cycling') {
                    document.getElementById('mode-cycling').classList.add('active');
                }
                
                console.log('Transport mode changed to:', mode);
                
                // If route is already created, recreate it with new transport mode
                if (this.selectedPandals.length > 1) {
                    this.createRoute();
                }
                
                // If navigation is active, update current route
                if (this.isRouteActive) {
                    this.createRouteVisualization();
                }
            }

            createRoute() {
                // Clear existing route control
                if (this.routeControl) {
                    this.map.removeControl(this.routeControl);
                    this.routeControl = null;
                }
                
                // Clear existing route lines
                this.routePolylines.forEach(line => this.map.removeLayer(line));
                this.routePolylines = [];

                if (this.selectedPandals.length < 2) {
                    alert('Please select at least 2 pandals to create a route!');
                    return;
                }

                // Create waypoints array for road-based routing
                const waypoints = this.selectedPandals.map(pandal => 
                    L.latLng(pandal.lat, pandal.lng)
                );

                // Create road-based routing using Leaflet Routing Machine
                this.routeControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    createMarker: function(i, waypoint, n) {
                        // Create custom numbered markers
                        const app = window.app;
                        const pandal = app.selectedPandals[i];
                        
                        const numberIcon = L.divIcon({
                            html: `<div style="background: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${i + 1}</div>`,
                            iconSize: [30, 30],
                            className: 'custom-number-icon'
                        });

                        return L.marker(waypoint.latLng, { 
                            icon: numberIcon,
                            title: pandal ? pandal.name : `Stop ${i + 1}`
                        }).bindPopup(pandal ? `${i + 1}. ${pandal.name}<br><small>${pandal.description}</small>` : `Stop ${i + 1}`);
                    },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: this.transportMode // Use selected transport mode
                    }),
                    lineOptions: {
                        styles: [
                            {color: '#ff6b6b', opacity: 0.8, weight: 6},
                            {color: 'white', opacity: 0.8, weight: 4}
                        ]
                    },
                    show: false, // Hide the default instruction panel
                    summaryTemplate: '<div class="routing-summary"><h3><i class="fas fa-route"></i> Route Summary</h3>{name}: {distance}, {time}</div>'
                }).addTo(this.map);

                // Store total distance and time for the route
                this.routeControl.on('routesfound', (e) => {
                    const routes = e.routes;
                    const summary = routes[0].summary;
                    
                    // Convert distance from meters to kilometers
                    const distanceKm = (summary.totalDistance / 1000).toFixed(1);
                    const timeMinutes = Math.round(summary.totalTime / 60);
                    
                    console.log(`Route calculated: ${distanceKm} km, ${timeMinutes} minutes`);
                    
                    // Update route info display
                    this.displayAdvancedRouteInfo(distanceKm, timeMinutes, routes[0]);
                });

                // Add route optimization information
                this.displayRouteOptimizationInfo();
            }

            displayRouteInfo() {
                let totalDistance = 0;
                for (let i = 0; i < this.selectedPandals.length - 1; i++) {
                    totalDistance += this.calculateDistance(
                        this.selectedPandals[i], 
                        this.selectedPandals[i + 1]
                    );
                }

                const estimatedTime = Math.ceil(totalDistance * 10 + this.selectedPandals.length * 30); // 10 min per km + 30 min per pandal

                const routeInfo = document.getElementById('route-info');
                routeInfo.innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4><i class="fas fa-route"></i> Route Summary</h4>
                        <p><strong>Total Pandals:</strong> ${this.selectedPandals.length}</p>
                        <p><strong>Estimated Distance:</strong> ${totalDistance.toFixed(1)} km</p>
                        <p><strong>Estimated Time:</strong> ${Math.floor(estimatedTime/60)}h ${estimatedTime%60}m</p>
                        <p><strong>Best Time to Start:</strong> Early morning (6 AM) for less crowds</p>
                    </div>
                `;
            }

            displayAdvancedRouteInfo(distanceKm, timeMinutes, route) {
                const routeInfo = document.getElementById('route-info');
                const timeHours = Math.floor(timeMinutes / 60);
                const remainingMinutes = timeMinutes % 60;
                
                // Calculate estimated time with pandal visit time
                const visitTimePerPandal = 30; // 30 minutes per pandal
                const totalVisitTime = this.selectedPandals.length * visitTimePerPandal;
                const totalTimeWithVisits = timeMinutes + totalVisitTime;
                const totalHours = Math.floor(totalTimeWithVisits / 60);
                const totalRemainingMinutes = totalTimeWithVisits % 60;
                
                // Transport mode specific info
                let transportIcon = '🚶';
                let transportName = 'Walking';
                let speedTip = 'Comfortable walking pace';
                
                if (this.transportMode === 'driving') {
                    transportIcon = '🚗';
                    transportName = 'Driving';
                    speedTip = 'Consider traffic and parking';
                } else if (this.transportMode === 'cycling') {
                    transportIcon = '🚴';
                    transportName = 'Cycling';
                    speedTip = 'Bicycle-friendly routes';
                }
                
                routeInfo.innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4><i class="fas fa-route"></i> Road-Based Route Summary (${transportIcon} ${transportName})</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                            <div><strong>📍 Total Pandals:</strong> ${this.selectedPandals.length}</div>
                            <div><strong>🛣️ ${transportName} Distance:</strong> ${distanceKm} km</div>
                            <div><strong>⏱️ ${transportName} Time:</strong> ${timeHours}h ${remainingMinutes}m</div>
                            <div><strong>🎯 Total Journey:</strong> ${totalHours}h ${totalRemainingMinutes}m</div>
                        </div>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107;">
                            <strong>💡 ${transportName} Tips:</strong><br>
                            • ${speedTip}<br>
                            • Start early morning (6-7 AM) for less crowds<br>
                            • Carry water and ${this.transportMode === 'foot' ? 'comfortable shoes' : this.transportMode === 'cycling' ? 'safety gear' : 'check parking availability'}<br>
                            • Allow extra time for photography and food
                        </div>
                        <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; border-left: 4px solid #17a2b8;">
                            <strong>🚌 Alternative Transport:</strong><br>
                            • Walking: Best for nearby pandals<br>
                            • Auto/Taxi: For longer distances<br>
                            • Metro: Use for major hubs<br>
                            • Bus: Check local routes
                        </div>
                    </div>
                `;
            }

            displayRouteOptimizationInfo() {
                const routeInfo = document.getElementById('route-info');
                const currentInfo = routeInfo.innerHTML;
                
                routeInfo.innerHTML = currentInfo + `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #dee2e6;">
                        <h5><i class="fas fa-cogs"></i> Route Optimization</h5>
                        <p style="margin: 5px 0;"><i class="fas fa-check-circle" style="color: #28a745;"></i> <strong>Shortest Path Algorithm Applied</strong></p>
                        <p style="margin: 5px 0;"><i class="fas fa-road" style="color: #007bff;"></i> <strong>Real Road Network Used</strong></p>
                        <p style="margin: 5px 0;"><i class="fas fa-walking" style="color: #fd7e14;"></i> <strong>Walking Directions Optimized</strong></p>
                        <small style="color: #6c757d;">
                            Routes are calculated using OpenStreetMap data and optimized for walking. 
                            Times include walking pace and account for traffic conditions.
                        </small>
                    </div>
                `;
            }

            toggleRoutePlanner() {
                const planner = document.getElementById('route-planner');
                const planRouteBtn = document.getElementById('plan-route-btn');
                
                if (planner.style.display === 'none') {
                    // Show route planner
                    planner.style.display = 'block';
                    this.showPandalSelection();
                    
                    // Update button text and style
                    if (planRouteBtn) {
                        planRouteBtn.innerHTML = '<i class="fas fa-times"></i> Close Route Planner';
                        planRouteBtn.className = 'btn btn-warning';
                    }
                    
                    // Scroll to route planner section
                    planner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                } else {
                    // Hide route planner
                    planner.style.display = 'none';
                    this.resetRouteSelection();
                    
                    // Reset button text and style
                    if (planRouteBtn) {
                        planRouteBtn.innerHTML = '<i class="fas fa-route"></i> Plan Route';
                        planRouteBtn.className = 'btn btn-secondary';
                    }
                }
            }

            showPandalSelection() {
                const checklist = document.getElementById('pandal-checklist');
                checklist.innerHTML = '';

                // Add event listeners for search and filters with a slight delay to ensure DOM is ready
                setTimeout(() => {
                    this.initializeSearchAndFilters();
                    // Apply current filters and render
                    this.renderFilteredPandals();
                }, 100);
            }

            initializeSearchAndFilters() {
                const searchInput = document.getElementById('pandal-search');
                const areaFilter = document.getElementById('area-filter');
                const themeFilter = document.getElementById('theme-filter');
                const clearBtn = document.getElementById('clear-filters-btn');

                // Ensure elements exist before adding listeners
                if (searchInput && !searchInput.hasAttribute('data-listener-added')) {
                    searchInput.addEventListener('input', (e) => {
                        console.log('Search input changed:', e.target.value); // Debug
                        this.renderFilteredPandals();
                    });
                    searchInput.setAttribute('data-listener-added', 'true');
                }
                
                if (areaFilter && !areaFilter.hasAttribute('data-listener-added')) {
                    areaFilter.addEventListener('change', (e) => {
                        console.log('Area filter changed:', e.target.value); // Debug
                        this.renderFilteredPandals();
                    });
                    areaFilter.setAttribute('data-listener-added', 'true');
                }
                
                if (themeFilter && !themeFilter.hasAttribute('data-listener-added')) {
                    themeFilter.addEventListener('change', (e) => {
                        console.log('Theme filter changed:', e.target.value); // Debug
                        this.renderFilteredPandals();
                    });
                    themeFilter.setAttribute('data-listener-added', 'true');
                }

                if (clearBtn && !clearBtn.hasAttribute('data-listener-added')) {
                    clearBtn.addEventListener('click', (e) => {
                        console.log('Clear filters clicked'); // Debug
                        this.clearFilters();
                    });
                    clearBtn.setAttribute('data-listener-added', 'true');
                }
            }

            clearFilters() {
                // Reset all filter controls
                const searchInput = document.getElementById('pandal-search');
                const areaFilter = document.getElementById('area-filter');
                const themeFilter = document.getElementById('theme-filter');

                if (searchInput) searchInput.value = '';
                if (areaFilter) areaFilter.value = '';
                if (themeFilter) themeFilter.value = '';

                // Re-render with cleared filters
                this.renderFilteredPandals();
            }

            getFilteredPandals() {
                const searchTerm = document.getElementById('pandal-search')?.value.toLowerCase() || '';
                const selectedArea = document.getElementById('area-filter')?.value || '';
                const selectedTheme = document.getElementById('theme-filter')?.value || '';

                console.log('Filter values:', { searchTerm, selectedArea, selectedTheme }); // Debug log

                return this.pandals.filter(pandal => {
                    // Search filter - check name, area, description, and nearest metro
                    const matchesSearch = searchTerm === '' || 
                        pandal.name.toLowerCase().includes(searchTerm) ||
                        pandal.area.toLowerCase().includes(searchTerm) ||
                        pandal.description.toLowerCase().includes(searchTerm) ||
                        pandal.nearestMetro.toLowerCase().includes(searchTerm);

                    // Area filter - exact match for area
                    const matchesArea = selectedArea === '' || pandal.area === selectedArea;

                    // Theme filter
                    const matchesTheme = selectedTheme === '' || this.getPandalTheme(pandal).includes(selectedTheme);

                    const matches = matchesSearch && matchesArea && matchesTheme;
                    
                    // Debug log for area filtering
                    if (selectedArea && !matchesArea) {
                        console.log(`Area mismatch: ${pandal.name} - Expected: ${selectedArea}, Got: ${pandal.area}`);
                    }

                    return matches;
                });
            }

            getPandalTheme(pandal) {
                const themes = [];
                const desc = pandal.description.toLowerCase();
                const name = pandal.name.toLowerCase();

                // Simple theme classification based on keywords
                if (desc.includes('traditional') || desc.includes('heritage') || name.includes('heritage')) {
                    themes.push('Traditional', 'Heritage');
                }
                if (desc.includes('modern') || desc.includes('contemporary')) {
                    themes.push('Modern', 'Contemporary');
                }
                if (desc.includes('eco') || desc.includes('green') || desc.includes('sustainable')) {
                    themes.push('Eco-friendly');
                }
                if (desc.includes('art') || desc.includes('sculpture') || desc.includes('creative')) {
                    themes.push('Artistic');
                }
                
                // Default themes if none detected
                if (themes.length === 0) {
                    if (pandal.area === 'North' || pandal.area === 'Central') {
                        themes.push('Traditional');
                    } else {
                        themes.push('Contemporary');
                    }
                }

                return themes;
            }

            renderFilteredPandals() {
                const checklist = document.getElementById('pandal-checklist');
                const resultsDiv = document.getElementById('filter-results');
                
                if (!checklist) {
                    console.error('Pandal checklist element not found');
                    return;
                }
                
                checklist.innerHTML = '';

                const filteredPandals = this.getFilteredPandals();
                
                console.log(`Filtered pandals count: ${filteredPandals.length} out of ${this.pandals.length}`); // Debug
                
                // Update results count
                if (resultsDiv) {
                    resultsDiv.textContent = `Showing ${filteredPandals.length} of ${this.pandals.length} pandals`;
                }

                if (filteredPandals.length === 0) {
                    checklist.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No pandals found matching your criteria</div>';
                    this.updateSelectedCount();
                    return;
                }

                // Sort pandals by area for better organization
                const sortedPandals = [...filteredPandals].sort((a, b) => {
                    if (a.area !== b.area) return a.area.localeCompare(b.area);
                    return a.name.localeCompare(b.name);
                });

                let currentArea = '';
                sortedPandals.forEach(pandal => {
                    // Add area header if new area
                    if (pandal.area !== currentArea) {
                        currentArea = pandal.area;
                        const areaHeader = document.createElement('div');
                        areaHeader.style.cssText = 'font-weight: bold; color: #d32f2f; margin: 15px 0 8px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;';
                        areaHeader.textContent = `${pandal.area} Kolkata`;
                        checklist.appendChild(areaHeader);
                    }

                    const pandalItem = document.createElement('div');
                    pandalItem.style.cssText = 'display: flex; align-items: center; padding: 8px; margin: 5px 0; background: #f9f9f9; border-radius: 5px; cursor: pointer;';
                    
                    const distance = this.userLocation ? this.calculateDistance(this.userLocation, pandal).toFixed(1) : '--';
                    const themes = this.getPandalTheme(pandal).join(', ');
                    
                    pandalItem.innerHTML = `
                        <input type="checkbox" id="pandal-${pandal.id}" style="margin-right: 10px; transform: scale(1.2);">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #333;">${pandal.name}</div>
                            <div style="font-size: 12px; color: #666;">
                                📍 ${distance} km away • ⭐ ${pandal.rating} • 🚇 ${pandal.nearestMetro}
                            </div>
                            <div style="font-size: 11px; color: #999;">${pandal.description}</div>
                            <div style="font-size: 10px; color: #007bff; margin-top: 2px;">🎨 ${themes}</div>
                        </div>
                    `;

                    pandalItem.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = pandalItem.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                        }
                        this.updateSelectedCount();
                    });

                    checklist.appendChild(pandalItem);
                });

                this.updateSelectedCount();
            }

            updateSelectedCount() {
                const checkboxes = document.querySelectorAll('#pandal-checklist input[type="checkbox"]');
                const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                const startBtn = document.getElementById('start-route-btn');
                
                if (selectedCount === 0) {
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Select Pandals to Start Route';
                    startBtn.disabled = true;
                    startBtn.style.opacity = '0.6';
                } else {
                    startBtn.innerHTML = `<i class="fas fa-play"></i> Start Route to ${selectedCount} Pandal${selectedCount > 1 ? 's' : ''}`;
                    startBtn.disabled = false;
                    startBtn.style.opacity = '1';
                }
            }

            startSelectedRoute() {
                if (!this.userLocation) {
                    alert('Please enable location tracking first to start your route!');
                    return;
                }

                const checkboxes = document.querySelectorAll('#pandal-checklist input[type="checkbox"]:checked');
                const selectedPandalIds = Array.from(checkboxes).map(cb => parseInt(cb.id.replace('pandal-', '')));
                
                if (selectedPandalIds.length === 0) {
                    alert('Please select at least one pandal to visit!');
                    return;
                }

                // Get selected pandals
                const selectedPandals = this.pandals.filter(p => selectedPandalIds.includes(p.id));
                
                // Optimize route based on distance from user location
                this.activeRoute = this.optimizeRouteFromLocation(selectedPandals);
                this.currentDestinationIndex = 0;
                this.isRouteActive = true;
                
                // Initialize route tracking
                this.routeStartTime = new Date();
                this.visitedDestinations = [];
                this.destinationArrivalTimes = [];

                // Switch to active route view
                document.getElementById('pandal-selection').style.display = 'none';
                document.getElementById('active-route').style.display = 'block';

                // Start navigation
                this.startActiveNavigation();
            }

            optimizeRouteFromLocation(pandals) {
                if (!this.userLocation || pandals.length <= 1) return pandals;

                // Start with closest pandal to user location
                let optimized = [];
                let remaining = [...pandals];
                let currentPos = this.userLocation;

                while (remaining.length > 0) {
                    let nearest = remaining[0];
                    let minDistance = this.calculateDistance(currentPos, nearest);

                    remaining.forEach(pandal => {
                        const distance = this.calculateDistance(currentPos, pandal);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearest = pandal;
                        }
                    });

                    optimized.push(nearest);
                    remaining = remaining.filter(p => p.id !== nearest.id);
                    currentPos = nearest;
                }

                return optimized;
            }

            startActiveNavigation() {
                this.updateCurrentDestination();
                this.createRouteVisualization();
                this.updateRouteProgress();
            }

            updateCurrentDestination() {
                if (this.currentDestinationIndex >= this.activeRoute.length) {
                    this.completeRoute();
                    return;
                }

                const currentPandal = this.activeRoute[this.currentDestinationIndex];
                const distance = this.userLocation ? this.calculateDistance(this.userLocation, currentPandal).toFixed(2) : '--';
                const estimatedTime = this.userLocation ? Math.ceil(this.calculateDistance(this.userLocation, currentPandal) * 10) : 0;

                document.getElementById('current-destination').innerHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h4 style="color: #1976d2; margin: 0 0 10px 0;">
                            <i class="fas fa-bullseye"></i> Current Destination
                        </h4>
                        <div style="font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px;">
                            ${currentPandal.name}
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                            📍 ${distance} km away (${Math.floor(estimatedTime/60)}h ${estimatedTime%60}m walk)
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                            🚇 Nearest Metro: ${currentPandal.nearestMetro}
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            👥 Crowd Level: ${currentPandal.crowdLevel}
                        </div>
                        <div style="background: #fff; padding: 8px; border-radius: 5px; font-size: 12px; color: #555;">
                            💡 ${currentPandal.description}
                        </div>
                    </div>
                `;

                // Show next pandal if available
                if (this.currentDestinationIndex < this.activeRoute.length - 1) {
                    const nextPandal = this.activeRoute[this.currentDestinationIndex + 1];
                    document.getElementById('next-pandal').innerHTML = `
                        <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin: 10px 0;">
                            <h5 style="color: #666; margin: 0 0 5px 0;">
                                <i class="fas fa-arrow-right"></i> Next: ${nextPandal.name}
                            </h5>
                            <div style="font-size: 12px; color: #888;">
                                ${nextPandal.area} Kolkata • ${nextPandal.theme}
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('next-pandal').innerHTML = `
                        <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center;">
                            <div style="color: #4caf50; font-weight: bold;">
                                🎉 This is your final destination!
                            </div>
                        </div>
                    `;
                }
            }

            updateRouteProgress() {
                const totalPandals = this.activeRoute.length;
                const completed = this.currentDestinationIndex;
                const progressPercent = (completed / totalPandals) * 100;

                document.getElementById('route-progress').innerHTML = `
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 14px; font-weight: bold;">Progress</span>
                            <span style="font-size: 14px;">${completed}/${totalPandals} completed</span>
                        </div>
                        <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #4caf50, #8bc34a); height: 100%; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;">
                            ${totalPandals - completed} pandal${totalPandals - completed !== 1 ? 's' : ''} remaining
                        </div>
                    </div>
                `;
            }

            createRouteVisualization() {
                // Clear existing route lines
                this.routePolylines.forEach(line => this.map.removeLayer(line));
                this.routePolylines = [];
                
                // Clear existing styled segments
                if (this.styledSegments) {
                    this.styledSegments.forEach(segment => this.map.removeLayer(segment));
                    this.styledSegments = [];
                }

                if (!this.userLocation || this.activeRoute.length === 0) return;

                // Create road-based route segments for active navigation
                this.createNavigationRouteSegments();
            }
            
            createNavigationRouteSegments() {
                // Create complete route showing all destinations with different styling
                if (!this.userLocation || this.activeRoute.length === 0) return;
                
                // Create full route waypoints starting from user location
                const allWaypoints = [L.latLng(this.userLocation.lat, this.userLocation.lng)];
                
                // Add all pandal locations to waypoints
                this.activeRoute.forEach(pandal => {
                    allWaypoints.push(L.latLng(pandal.lat, pandal.lng));
                });
                
                // Create complete route control
                const fullRouteControl = L.Routing.control({
                    waypoints: allWaypoints,
                    routeWhileDragging: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    show: false,
                    createMarker: function() { return null; }, // Don't create default markers
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: window.app.transportMode
                    }),
                    lineOptions: {
                        styles: [
                            {color: '#ff6b6b', opacity: 0.7, weight: 8}, // Main route line
                            {color: 'white', opacity: 0.9, weight: 4}   // White outline
                        ]
                    }
                });
                
                fullRouteControl.on('routesfound', (e) => {
                    const route = e.routes[0];
                    
                    // Create segment-specific styling
                    this.createStyledRouteSegments(route, allWaypoints);
                    
                    // Update navigation info for current destination
                    if (this.currentDestinationIndex < this.activeRoute.length) {
                        const currentDestination = this.activeRoute[this.currentDestinationIndex];
                        this.updateCurrentDestinationInfo(route, currentDestination);
                    }
                });
                
                fullRouteControl.addTo(this.map);
                this.routePolylines.push(fullRouteControl);

                // Add enhanced markers for all pandals in the route
                this.addEnhancedRouteMarkers();
                
                // Focus map to show the full route
                this.focusMapOnFullRoute();
            }
            
            createStyledRouteSegments(route, waypoints) {
                // Remove any existing styled segments
                if (this.styledSegments) {
                    this.styledSegments.forEach(segment => this.map.removeLayer(segment));
                }
                this.styledSegments = [];
                
                // Create styled segments for different parts of the route
                const coordinates = route.coordinates;
                if (!coordinates || coordinates.length < 2) return;
                
                // Find approximate segment boundaries based on waypoints
                const segmentBoundaries = this.findSegmentBoundaries(coordinates, waypoints);
                
                // Create styled polylines for each segment
                for (let i = 0; i < segmentBoundaries.length - 1; i++) {
                    const startIdx = segmentBoundaries[i];
                    const endIdx = segmentBoundaries[i + 1];
                    const segmentCoords = coordinates.slice(startIdx, endIdx + 1);
                    
                    // Convert coordinates to Leaflet LatLng format
                    const latLngs = segmentCoords.map(coord => L.latLng(coord.lat, coord.lng));
                    
                    // Determine segment styling based on progress
                    let segmentStyle;
                    if (i < this.currentDestinationIndex) {
                        // Completed segments - green
                        segmentStyle = {
                            color: '#4caf50',
                            weight: 6,
                            opacity: 0.9,
                            dashArray: ''
                        };
                    } else if (i === this.currentDestinationIndex) {
                        // Current segment - blue with animation
                        segmentStyle = {
                            color: '#2196f3',
                            weight: 8,
                            opacity: 0.9,
                            dashArray: '10, 5',
                            className: 'current-route-segment'
                        };
                    } else {
                        // Future segments - orange dashed
                        segmentStyle = {
                            color: '#ff9800',
                            weight: 4,
                            opacity: 0.6,
                            dashArray: '15, 10'
                        };
                    }
                    
                    const segmentPolyline = L.polyline(latLngs, segmentStyle);
                    
                    // Add popup with segment info
                    const destinationName = i < this.activeRoute.length ? this.activeRoute[i].name : 'Final Destination';
                    segmentPolyline.bindPopup(`
                        <div style="text-align: center;">
                            <strong>Segment ${i + 1}</strong><br>
                            To: ${destinationName}<br>
                            Status: ${i < this.currentDestinationIndex ? '✅ Completed' : i === this.currentDestinationIndex ? '📍 Current' : '⏳ Upcoming'}
                        </div>
                    `);
                    
                    segmentPolyline.addTo(this.map);
                    this.styledSegments.push(segmentPolyline);
                }
            }
            
            findSegmentBoundaries(coordinates, waypoints) {
                const boundaries = [0]; // Start with first coordinate
                
                // For each waypoint (except first), find closest coordinate
                for (let i = 1; i < waypoints.length; i++) {
                    const waypoint = waypoints[i];
                    let closestIdx = 0;
                    let minDistance = Infinity;
                    
                    for (let j = boundaries[boundaries.length - 1]; j < coordinates.length; j++) {
                        const coord = coordinates[j];
                        const distance = Math.sqrt(
                            Math.pow(coord.lat - waypoint.lat, 2) + 
                            Math.pow(coord.lng - waypoint.lng, 2)
                        );
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestIdx = j;
                        }
                    }
                    
                    boundaries.push(closestIdx);
                }
                
                // Add final coordinate
                if (boundaries[boundaries.length - 1] !== coordinates.length - 1) {
                    boundaries.push(coordinates.length - 1);
                }
                
                return boundaries;
            }
            
            updateCurrentDestinationInfo(route, currentDestination) {
                // Find current segment distance and time
                const segmentDistance = this.calculateSegmentDistance(route, this.currentDestinationIndex);
                const segmentTime = this.calculateSegmentTime(route, this.currentDestinationIndex);
                
                // Get turn-by-turn instructions for current segment
                const instructions = route.instructions || [];
                const currentInstructions = this.getCurrentSegmentInstructions(instructions, this.currentDestinationIndex);
                
                this.updateNavigationInfo(currentDestination, segmentDistance, segmentTime, currentInstructions);
            }
            
            calculateSegmentDistance(route, segmentIndex) {
                // Approximate segment distance (in practice, you'd need more precise calculation)
                const totalDistance = route.summary.totalDistance / 1000; // Convert to km
                const estimatedSegmentDistance = (totalDistance / this.activeRoute.length).toFixed(1);
                return estimatedSegmentDistance;
            }
            
            calculateSegmentTime(route, segmentIndex) {
                // Approximate segment time (in practice, you'd need more precise calculation)
                const totalTime = route.summary.totalTime / 60; // Convert to minutes
                const estimatedSegmentTime = Math.round(totalTime / this.activeRoute.length);
                return estimatedSegmentTime;
            }
            
            getCurrentSegmentInstructions(instructions, segmentIndex) {
                // Return relevant instructions for current segment
                const instructionsPerSegment = Math.ceil(instructions.length / this.activeRoute.length);
                const startIdx = segmentIndex * instructionsPerSegment;
                const endIdx = Math.min(startIdx + instructionsPerSegment, instructions.length);
                
                return instructions.slice(startIdx, endIdx);
            }
            
            focusMapOnFullRoute() {
                // Fit map to show entire route
                if (this.activeRoute.length > 0) {
                    const bounds = L.latLngBounds([
                        [this.userLocation.lat, this.userLocation.lng]
                    ]);
                    
                    this.activeRoute.forEach(pandal => {
                        bounds.extend([pandal.lat, pandal.lng]);
                    });
                    
                    this.map.fitBounds(bounds, { padding: [20, 20] });
                }
            }

            showFullRoute() {
                // Show complete route overview with different zoom level
                this.focusMapOnFullRoute();
                
                // Show route summary popup
                const totalPandals = this.activeRoute.length;
                const completed = this.currentDestinationIndex;
                const remaining = totalPandals - completed;
                
                const routeSummary = `
                    <div style="text-align: center; padding: 15px;">
                        <h4><i class="fas fa-route"></i> Complete Route Overview</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0;">
                            <div style="background: #4caf50; color: white; padding: 10px; border-radius: 8px;">
                                <strong>${completed}</strong><br>
                                <small>Completed</small>
                            </div>
                            <div style="background: ${completed < totalPandals ? '#2196f3' : '#e0e0e0'}; color: white; padding: 10px; border-radius: 8px;">
                                <strong>${completed < totalPandals ? '1' : '0'}</strong><br>
                                <small>Current</small>
                            </div>
                            <div style="background: #ff9800; color: white; padding: 10px; border-radius: 8px;">
                                <strong>${remaining - (completed < totalPandals ? 1 : 0)}</strong><br>
                                <small>Remaining</small>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px;">
                            <strong>Legend:</strong><br>
                            <span style="color: #4caf50;">🟢 Completed Routes</span><br>
                            <span style="color: #2196f3;">🔵 Current Route</span><br>
                            <span style="color: #ff9800;">🟠 Upcoming Routes</span>
                        </div>
                    </div>
                `;
                
                // Create temporary popup for route overview
                const center = this.map.getCenter();
                const popup = L.popup()
                    .setLatLng(center)
                    .setContent(routeSummary)
                    .openOn(this.map);
                
                // Auto-close popup after 5 seconds
                setTimeout(() => {
                    if (popup.isOpen()) {
                        this.map.closePopup(popup);
                    }
                }, 5000);
                
                console.log('Showing full route overview');
            }
            
            addEnhancedRouteMarkers() {
                this.activeRoute.forEach((pandal, index) => {
                    const isCompleted = index < this.currentDestinationIndex;
                    const isCurrent = index === this.currentDestinationIndex;
                    
                    let markerColor = '#ff9800'; // Upcoming
                    let markerIcon = '⏳';
                    let statusText = 'Upcoming';
                    
                    if (isCompleted) {
                        markerColor = '#4caf50';
                        markerIcon = '✅';
                        statusText = 'Completed';
                    } else if (isCurrent) {
                        markerColor = '#2196f3';
                        markerIcon = '📍';
                        statusText = 'Current Destination';
                    }

                    const numberIcon = L.divIcon({
                        html: `<div style="background: ${markerColor}; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); position: relative;">
                                ${index + 1}
                                <div style="position: absolute; top: -8px; right: -8px; font-size: 12px;">${markerIcon}</div>
                              </div>`,
                        iconSize: [35, 35],
                        className: 'enhanced-route-icon'
                    });

                    const marker = L.marker([pandal.lat, pandal.lng], { icon: numberIcon })
                        .addTo(this.map)
                        .bindPopup(`
                            <div style="text-align: center;">
                                <h4>${index + 1}. ${pandal.name}</h4>
                                <div style="background: ${markerColor}; color: white; padding: 5px; border-radius: 15px; margin: 5px 0; font-size: 12px;">
                                    ${statusText}
                                </div>
                                <p><strong>Area:</strong> ${pandal.area}</p>
                                <p><strong>Theme:</strong> ${pandal.theme}</p>
                                <p><strong>Rating:</strong> ⭐ ${pandal.rating}/5</p>
                                ${isCurrent ? '<button onclick="window.app.arrivedAtPandal()" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Mark as Visited</button>' : ''}
                            </div>
                        `);
                        
                    this.routePolylines.push(marker);
                });
            }
            
            updateNavigationInfo(destination, distance, time, instructions) {
                const currentDestInfo = document.getElementById('current-destination');
                if (currentDestInfo) {
                    const directionSteps = instructions.slice(0, 3).map((step, index) => 
                        `<div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #2196f3;">
                            <strong>Step ${index + 1}:</strong> ${step.text || step.instruction}
                            ${step.distance ? `<span style="float: right; color: #666;">${Math.round(step.distance)}m</span>` : ''}
                        </div>`
                    ).join('');
                    
                    currentDestInfo.innerHTML = `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <h4><i class="fas fa-navigation" style="color: #2196f3;"></i> ${destination.name}</h4>
                            
                            <!-- Proximity Indicator -->
                            <div id="proximity-indicator" style="background: rgba(33, 150, 243, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center; font-weight: bold; color: #666;">
                                📍 Calculating distance...
                            </div>
                            
                            <!-- Auto Arrival Settings -->
                            <div style="background: rgba(76, 175, 80, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="auto-arrival-toggle" ${this.autoArrivalEnabled ? 'checked' : ''} 
                                           onchange="window.app.toggleAutoArrival(this.checked)" style="margin: 0;">
                                    <span style="font-size: 0.9em;">🤖 Auto-detect arrival (40m radius)</span>
                                </label>
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                                    When enabled, automatically marks destination as visited when you're nearby
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                                <div><strong>🚶 Distance:</strong> ${distance} km</div>
                                <div><strong>⏱️ Walking Time:</strong> ${time} min</div>
                                <div><strong>📍 Area:</strong> ${destination.area}</div>
                                <div><strong>⭐ Rating:</strong> ${destination.rating}/5</div>
                            </div>
                            <div style="margin-top: 15px;">
                                <h5><i class="fas fa-directions"></i> Turn-by-Turn Directions:</h5>
                                ${directionSteps}
                                ${instructions.length > 3 ? `<small style="color: #666;">... and ${instructions.length - 3} more steps</small>` : ''}
                            </div>
                            <button onclick="window.app.arrivedAtPandal()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; width: 100%;">
                                <i class="fas fa-check"></i> Mark as Visited & Continue
                            </button>
                        </div>
                    `;
                }
            }

            arrivedAtPandal(isAutomatic = false) {
                if (this.currentDestinationIndex < this.activeRoute.length) {
                    const currentDestination = this.activeRoute[this.currentDestinationIndex];
                    const arrivalTime = new Date();
                    
                    // Record the visit
                    this.visitedDestinations.push({
                        pandal: currentDestination,
                        arrivalTime: arrivalTime,
                        destinationNumber: this.currentDestinationIndex + 1,
                        isAutomatic: isAutomatic,
                        timeSpent: this.calculateTimeSpent()
                    });
                    
                    // Show progress update
                    this.updateProgressDisplay();
                    
                    // Move to next destination
                    this.currentDestinationIndex++;
                    
                    if (this.currentDestinationIndex >= this.activeRoute.length) {
                        this.completeRoute();
                    } else {
                        this.updateCurrentDestination();
                        this.createRouteVisualization();
                        this.updateRouteProgress();
                        
                        // Show next destination notification
                        this.showNextDestinationNotification();
                    }
                }
            }

            calculateTimeSpent() {
                if (this.routeStartTime && this.destinationArrivalTimes.length > 0) {
                    const lastTime = this.destinationArrivalTimes.length > 1 ? 
                        this.destinationArrivalTimes[this.destinationArrivalTimes.length - 2].arrivalTime : 
                        this.routeStartTime;
                    return new Date() - new Date(lastTime);
                }
                return 0;
            }

            updateProgressDisplay() {
                const completed = this.currentDestinationIndex + 1;
                const total = this.activeRoute.length;
                const percentage = Math.round((completed / total) * 100);
                
                // Show/hide undo button
                const undoBtn = document.getElementById('undo-arrival-btn');
                if (undoBtn) {
                    undoBtn.style.display = this.visitedDestinations.length > 0 ? 'block' : 'none';
                }
                
                // Update progress text with ordinal numbers
                const progressElement = document.getElementById('route-progress');
                if (progressElement) {
                    let progressHTML = `
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <h4 style="color: #4caf50; margin: 0 0 10px 0;">
                                🎯 Progress: ${completed}/${total} Destinations (${percentage}%)
                            </h4>
                            <div class="progress-bar" style="background: #ddd; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #4caf50, #45a049); width: ${percentage}%; height: 100%; transition: width 0.5s ease;"></div>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9em;">
                    `;
                    
                    // Add completed destinations list
                    this.visitedDestinations.forEach((visit, index) => {
                        const ordinal = this.getOrdinalNumber(visit.destinationNumber);
                        const autoIcon = visit.isAutomatic ? '🤖' : '👤';
                        progressHTML += `
                            <div style="color: #4caf50; margin: 3px 0;">
                                ✅ ${ordinal} - ${visit.pandal.name} ${autoIcon}
                                <small style="opacity: 0.7;">(${visit.arrivalTime.toLocaleTimeString()})</small>
                            </div>
                        `;
                    });
                    
                    progressHTML += '</div></div>';
                    progressElement.innerHTML = progressHTML;
                }
            }

            getOrdinalNumber(num) {
                const suffixes = ['th', 'st', 'nd', 'rd'];
                const mod100 = num % 100;
                return num + (suffixes[(mod100 - 20) % 10] || suffixes[mod100] || suffixes[0]);
            }

            showNextDestinationNotification() {
                if (this.currentDestinationIndex < this.activeRoute.length) {
                    const nextDestination = this.activeRoute[this.currentDestinationIndex];
                    const nextNumber = this.currentDestinationIndex + 1;
                    const ordinal = this.getOrdinalNumber(nextNumber);
                    
                    const notification = document.createElement('div');
                    notification.className = 'arrival-notification';
                    notification.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';
                    notification.innerHTML = `
                        <div class="notification-content">
                            <div class="notification-icon">🎯</div>
                            <div class="notification-text">
                                <h3>Next: ${ordinal} Destination</h3>
                                <p>${nextDestination.name}</p>
                                <small>Navigate to continue your route</small>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="notification-close">×</button>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Auto-remove after 4 seconds
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 4000);
                }
            }

            completeRoute() {
                this.isRouteActive = false;
                
                document.getElementById('current-destination').innerHTML = `
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 10px 0; text-align: center;">
                        <h3 style="color: #4caf50; margin: 0 0 10px 0;">
                            🎉 Route Completed!
                        </h3>
                        <p style="margin: 0; color: #666;">
                            Congratulations! You've visited all ${this.activeRoute.length} pandals on your route.
                        </p>
                        <button onclick="window.app.resetRoute()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                            Plan New Route
                        </button>
                    </div>
                `;
                
                document.getElementById('next-pandal').innerHTML = '';
                document.getElementById('route-progress').innerHTML = '';
                
                // Hide arrived button
                document.getElementById('arrived-btn').style.display = 'none';
            }

            resetRoute() {
                this.isRouteActive = false;
                this.activeRoute = [];
                this.currentDestinationIndex = 0;
                
                // Reset navigation tracking
                this.visitedDestinations = [];
                this.destinationArrivalTimes = [];
                this.routeStartTime = null;
                this.lastNotificationTime = 0;
                
                // Clear route visualization
                this.routePolylines.forEach(line => this.map.removeLayer(line));
                this.routePolylines = [];
                
                // Reset UI
                document.getElementById('pandal-selection').style.display = 'block';
                document.getElementById('active-route').style.display = 'none';
                document.getElementById('arrived-btn').style.display = 'block';
                
                // Clear all checkboxes
                const checkboxes = document.querySelectorAll('#pandal-checklist input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                this.updateSelectedCount();
            }

            toggleAutoArrival(enabled) {
                this.autoArrivalEnabled = enabled;
                const statusText = enabled ? 'enabled' : 'disabled';
                
                // Show brief notification
                const notification = document.createElement('div');
                notification.className = 'arrival-notification';
                notification.style.background = enabled ? 
                    'linear-gradient(135deg, #4caf50, #45a049)' : 
                    'linear-gradient(135deg, #ff9800, #f57c00)';
                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon">${enabled ? '🤖' : '👤'}</div>
                        <div class="notification-text">
                            <h3>Auto-arrival ${statusText}</h3>
                            <p>${enabled ? 'Will auto-detect when you arrive' : 'Manual marking required'}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="notification-close">×</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 3000);
            }

            undoLastArrival() {
                if (this.visitedDestinations.length > 0 && this.currentDestinationIndex > 0) {
                    // Remove last visit
                    const lastVisit = this.visitedDestinations.pop();
                    this.destinationArrivalTimes.pop();
                    
                    // Go back to previous destination
                    this.currentDestinationIndex--;
                    
                    // Update displays
                    this.updateCurrentDestination();
                    this.updateProgressDisplay();
                    this.createRouteVisualization();
                    
                    // Show undo notification
                    const notification = document.createElement('div');
                    notification.className = 'arrival-notification';
                    notification.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
                    notification.innerHTML = `
                        <div class="notification-content">
                            <div class="notification-icon">↩️</div>
                            <div class="notification-text">
                                <h3>Undone: ${lastVisit.pandal.name}</h3>
                                <p>Returned to previous destination</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="notification-close">×</button>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 4000);
                }
            }

            resetRouteSelection() {
                this.resetRoute();
            }

            bindEvents() {
                // Add debugging to check if elements exist
                console.log('Binding events...');

                // Search functionality
                const searchBtn = document.getElementById('search-btn');
                const searchInput = document.getElementById('search-input');
                
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        this.filterPandals();
                    });
                }

                if (searchInput) {
                    searchInput.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            this.filterPandals();
                        }
                    });
                }

                // Filter functionality
                const areaFilter = document.getElementById('area-filter');
                const themeFilter = document.getElementById('theme-filter');
                
                if (areaFilter) {
                    areaFilter.addEventListener('change', () => {
                        this.filterPandals();
                    });
                }

                if (themeFilter) {
                    themeFilter.addEventListener('change', () => {
                        this.filterPandals();
                    });
                }

                // Button events
                const showAllBtn = document.getElementById('show-all-btn');
                if (showAllBtn) {
                    showAllBtn.addEventListener('click', () => {
                        this.showAllPandals();
                    });
                }

                const planRouteBtn = document.getElementById('plan-route-btn');
                if (planRouteBtn) {
                    planRouteBtn.addEventListener('click', () => {
                        this.toggleRoutePlanner();
                    });
                }

                // Route planner buttons (these might not exist initially)
                const startRouteBtn = document.getElementById('start-route-btn');
                if (startRouteBtn) {
                    startRouteBtn.addEventListener('click', () => {
                        this.startSelectedRoute();
                    });
                }

                const arrivedBtn = document.getElementById('arrived-btn');
                if (arrivedBtn) {
                    arrivedBtn.addEventListener('click', () => {
                        this.arrivedAtPandal();
                    });
                }

                const endRouteBtn = document.getElementById('end-route-btn');
                if (endRouteBtn) {
                    endRouteBtn.addEventListener('click', () => {
                        this.resetRoute();
                    });
                }

                const optimizeRouteBtn = document.getElementById('optimize-route-btn');
                if (optimizeRouteBtn) {
                    optimizeRouteBtn.addEventListener('click', () => {
                        this.optimizeRoute();
                    });
                }

                // Modal events
                const modal = document.getElementById('info-modal');
                const toggleBtn = document.getElementById('toggle-info-btn');
                const closeBtn = document.querySelector('.close');

                if (toggleBtn && modal) {
                    toggleBtn.addEventListener('click', () => {
                        modal.style.display = 'block';
                    });
                }

                if (closeBtn && modal) {
                    closeBtn.addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                }

                if (modal) {
                    window.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                }

                // Location tracking button - This is the main issue
                const locationBtn = document.getElementById('location-btn');
                if (locationBtn) {
                    console.log('Location button found, adding event listener');
                    locationBtn.addEventListener('click', () => {
                        console.log('Location button clicked!');
                        this.toggleLocationTracking();
                    });
                } else {
                    console.error('Location button not found!');
                }

                // Change location button
                const changeLocationBtn = document.getElementById('change-location-btn');
                if (changeLocationBtn) {
                    changeLocationBtn.addEventListener('click', () => {
                        document.getElementById('location-selector-overlay').style.display = 'flex';
                    });
                }
            }

            // Location tracking methods
            toggleLocationTracking() {
                console.log('toggleLocationTracking called, current state:', this.isTrackingLocation);
                if (this.isTrackingLocation) {
                    this.stopLocationTracking();
                } else {
                    this.startLocationTracking();
                }
            }

            startLocationTracking() {
                console.log('Starting location tracking...');
                
                // Check for HTTPS requirement on mobile
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        alert('Location access requires HTTPS on mobile devices.\n\nPlease:\n1. Use a local web server with HTTPS\n2. Or access the page through a secure hosting service');
                        return;
                    }
                }
                
                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by this browser.');
                    return;
                }

                const locationBtn = document.getElementById('location-btn');
                if (!locationBtn) {
                    console.error('Location button not found!');
                    return;
                }
                
                locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
                locationBtn.disabled = true;

                // Enhanced geolocation options for mobile
                const geoOptions = {
                    enableHighAccuracy: true,
                    timeout: 20000, // Increased timeout for mobile
                    maximumAge: 30000 // Reduced max age for fresher position
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('Position received:', position);
                        this.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            heading: position.coords.heading || null,
                            accuracy: position.coords.accuracy
                        };
                        
                        this.addUserLocationMarker();
                        this.startWatchingPosition();
                        
                        locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Stop Tracking';
                        locationBtn.disabled = false;
                        locationBtn.className = 'btn btn-warning';
                        locationBtn.title = 'Location tracking active';
                        this.isTrackingLocation = true;

                        // Center map on user location
                        this.map.setView([this.userLocation.lat, this.userLocation.lng], 15);
                        
                        // Update button status after a short delay to allow compass to initialize
                        setTimeout(() => {
                            this.updateLocationButtonStatus();
                        }, 1000);
                        
                        console.log('Location tracking started successfully');
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        this.handleLocationError(error);
                        locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Track My Location';
                        locationBtn.disabled = false;
                    },
                    geoOptions
                );
            }

            stopLocationTracking() {
                console.log('Stopping location tracking...');
                
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }

                // Stop compass tracking
                this.stopCompassTracking();

                if (this.userLocationMarker) {
                    this.map.removeLayer(this.userLocationMarker);
                    this.userLocationMarker = null;
                }

                const locationBtn = document.getElementById('location-btn');
                
                if (locationBtn) {
                    locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Track My Location';
                    locationBtn.className = 'btn btn-success';
                }
                
                this.isTrackingLocation = false;
                this.userLocation = null;
                this.compassHeading = null;
                
                console.log('Location tracking stopped');
            }

            stopCompassTracking() {
                // Remove event listeners for device orientation
                if (this.orientationAbsoluteHandler) {
                    window.removeEventListener('deviceorientationabsolute', this.orientationAbsoluteHandler, true);
                }
                if (this.orientationHandler) {
                    window.removeEventListener('deviceorientation', this.orientationHandler, true);
                }
                this.orientationAbsoluteHandler = null;
                this.orientationHandler = null;
            }

            startWatchingPosition() {
                // Enhanced options for mobile devices
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                const watchOptions = {
                    enableHighAccuracy: true,
                    timeout: isMobile ? 25000 : 15000, // Longer timeout for mobile
                    maximumAge: isMobile ? 15000 : 10000 // Fresher position for mobile
                };
                
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        this.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            heading: position.coords.heading || null,
                            accuracy: position.coords.accuracy
                        };
                        this.updateUserLocationMarker();
                        
                        // Update active route if running
                        if (this.isRouteActive && this.currentDestinationIndex < this.activeRoute.length) {
                            this.updateCurrentDestination();
                            this.createRouteVisualization();
                            this.checkArrivalProximity();
                        }
                    },
                    (error) => {
                        console.warn('Location tracking error:', error);
                        // Don't show error alerts for watch position - just log it
                        if (error.code === error.TIMEOUT) {
                            console.log('Position watch timeout - continuing with last known position');
                        }
                    },
                    watchOptions
                );
                
                // Start listening for device orientation if available
                this.startCompassTracking();
            }

            startCompassTracking() {
                // Initialize compass heading
                this.compassHeading = null;
                
                // Enhanced mobile detection
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                console.log('Starting compass tracking - Mobile:', isMobile, 'iOS:', isIOS);
                
                // Request permission for iOS 13+ devices
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    console.log('Requesting device orientation permission...');
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            console.log('Device orientation permission response:', response);
                            if (response === 'granted') {
                                this.addOrientationListener();
                            } else {
                                console.log('Device orientation permission denied');
                                // For mobile without orientation, still show location without direction
                                if (isMobile) {
                                    console.log('Using location without compass on mobile');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Device orientation permission error:', error);
                            // Fallback: try to add listener anyway for older devices
                            this.addOrientationListener();
                        });
                } else {
                    // For other devices, directly add listener
                    console.log('Adding orientation listener without permission request');
                    this.addOrientationListener();
                }
            }

            addOrientationListener() {
                // Create bound handler functions for proper removal
                this.orientationAbsoluteHandler = (event) => {
                    this.compassHeading = event.alpha; // Alpha is the compass heading
                    this.updateUserLocationMarker();
                    this.updateLocationButtonStatus();
                };

                this.orientationHandler = (event) => {
                    if (!this.compassHeading) {
                        // Convert relative orientation to absolute if possible
                        let heading = event.alpha;
                        if (event.webkitCompassHeading) {
                            heading = event.webkitCompassHeading; // iOS webkit
                        }
                        this.compassHeading = heading;
                        this.updateUserLocationMarker();
                        this.updateLocationButtonStatus();
                    }
                };

                window.addEventListener('deviceorientationabsolute', this.orientationAbsoluteHandler, true);
                // Fallback for devices that don't support deviceorientationabsolute
                window.addEventListener('deviceorientation', this.orientationHandler, true);
            }

            updateLocationButtonStatus() {
                const locationBtn = document.getElementById('location-btn');
                if (locationBtn && this.isTrackingLocation) {
                    const hasCompass = this.compassHeading !== null && !isNaN(this.compassHeading);
                    if (hasCompass) {
                        locationBtn.innerHTML = '<i class="fas fa-compass"></i> Stop Tracking (Compass)';
                        locationBtn.title = 'Location tracking with compass direction active';
                    } else {
                        locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Stop Tracking';
                        locationBtn.title = 'Location tracking active (no compass data)';
                    }
                }
            }

            checkArrivalProximity() {
                if (!this.isRouteActive || this.currentDestinationIndex >= this.activeRoute.length) return;
                
                const currentDestination = this.activeRoute[this.currentDestinationIndex];
                const distance = this.calculateDistance(this.userLocation, currentDestination);
                const currentTime = Date.now();
                
                // Check if we're within arrival detection radius
                if (distance < this.arrivalDetectionRadius && this.autoArrivalEnabled) {
                    // Prevent duplicate notifications within 30 seconds
                    if (currentTime - this.lastNotificationTime > 30000) {
                        this.automaticArrivalDetected(currentDestination, distance);
                        this.lastNotificationTime = currentTime;
                    }
                } else if (distance < 0.05) {
                    // Very close proximity (50m) - highlight arrived button
                    const arrivedBtn = document.getElementById('arrived-btn');
                    if (arrivedBtn) {
                        arrivedBtn.style.background = '#4caf50';
                        arrivedBtn.style.animation = 'pulse 1s infinite';
                        arrivedBtn.innerHTML = '<i class="fas fa-check-circle"></i> You\'re here! Mark as Visited';
                    }
                } else {
                    // Reset arrived button to normal state
                    const arrivedBtn = document.getElementById('arrived-btn');
                    if (arrivedBtn) {
                        arrivedBtn.style.background = '#2196f3';
                        arrivedBtn.style.animation = 'none';
                        arrivedBtn.innerHTML = '<i class="fas fa-check"></i> I\'ve Arrived at This Pandal';
                    }
                }
                
                // Update proximity indicator
                this.updateProximityIndicator(distance);
            }

            automaticArrivalDetected(destination, distance) {
                const arrivalTime = new Date();
                const destinationNumber = this.currentDestinationIndex + 1;
                
                // Record the arrival
                this.destinationArrivalTimes.push({
                    pandal: destination,
                    arrivalTime: arrivalTime,
                    distance: distance,
                    index: this.currentDestinationIndex
                });
                
                // Show arrival notification
                this.showArrivalNotification(destination, destinationNumber);
                
                // Play arrival sound
                this.playArrivalSound();
                
                // Vibrate if supported
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                // Automatically advance to next destination after 3 seconds
                setTimeout(() => {
                    this.arrivedAtPandal(true); // true indicates automatic arrival
                }, 3000);
            }

            showArrivalNotification(destination, destinationNumber) {
                // Create notification popup
                const notification = document.createElement('div');
                notification.className = 'arrival-notification';
                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon">🎉</div>
                        <div class="notification-text">
                            <h3>Destination ${destinationNumber} Reached!</h3>
                            <p>${destination.name}</p>
                            <small>Auto-advancing in 3 seconds...</small>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="notification-close">×</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            updateProximityIndicator(distance) {
                const distanceMeters = Math.round(distance * 1000);
                let proximityText = '';
                let proximityColor = '#666';
                
                if (distance < 0.02) { // Less than 20m
                    proximityText = `🎯 Very Close (${distanceMeters}m)`;
                    proximityColor = '#4caf50';
                } else if (distance < 0.05) { // Less than 50m
                    proximityText = `📍 Close (${distanceMeters}m)`;
                    proximityColor = '#ff9800';
                } else if (distance < 0.1) { // Less than 100m
                    proximityText = `🚶 Approaching (${distanceMeters}m)`;
                    proximityColor = '#2196f3';
                } else {
                    proximityText = `📍 ${distanceMeters}m away`;
                    proximityColor = '#666';
                }
                
                // Update proximity display
                const proximityElement = document.getElementById('proximity-indicator');
                if (proximityElement) {
                    proximityElement.innerHTML = proximityText;
                    proximityElement.style.color = proximityColor;
                }
            }

            playArrivalSound() {
                try {
                    // Create a simple audio context for arrival sound
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5 note
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5 note
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5 note
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    console.log('Audio not supported or permission denied');
                }
            }

            addUserLocationMarker() {
                const userIcon = this.createDirectionalUserIcon();

                this.userLocationMarker = L.marker([this.userLocation.lat, this.userLocation.lng], { 
                    icon: userIcon,
                    zIndexOffset: 1000
                })
                .addTo(this.map)
                .bindPopup(`
                    <div class="custom-popup">
                        <h3><i class="fas fa-map-marker-alt"></i> Your Location</h3>
                        <p>Lat: ${this.userLocation.lat.toFixed(6)}</p>
                        <p>Lng: ${this.userLocation.lng.toFixed(6)}</p>
                        <p>Accuracy: ±${this.userLocation.accuracy ? Math.round(this.userLocation.accuracy) : 'Unknown'} meters</p>
                        ${this.compassHeading !== null ? `<p>Heading: ${Math.round(this.compassHeading)}°</p>` : ''}
                        <button onclick="window.app.findNearestPandals()" style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 5px;">
                            Find Nearest Pandals
                        </button>
                    </div>
                `);
            }

            createDirectionalUserIcon() {
                const hasHeading = this.compassHeading !== null && !isNaN(this.compassHeading);
                const rotation = hasHeading ? this.compassHeading : 0;
                
                return L.divIcon({
                    html: `
                        <div class="user-location-container">
                            <!-- Accuracy circle -->
                            <div class="accuracy-circle" style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                width: 40px;
                                height: 40px;
                                border: 2px solid #4285f4;
                                border-radius: 50%;
                                background: rgba(66, 133, 244, 0.1);
                                animation: pulse-location 2s infinite;
                            "></div>
                            
                            <!-- Main location dot -->
                            <div class="location-dot" style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: #4285f4; 
                                border: 3px solid white; 
                                border-radius: 50%; 
                                width: 16px; 
                                height: 16px;
                                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                z-index: 2;
                            "></div>
                            
                            <!-- Directional arrow (only shown if heading is available) -->
                            ${hasHeading ? `
                            <div class="direction-arrow" style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%) rotate(${rotation}deg);
                                width: 0;
                                height: 0;
                                border-left: 6px solid transparent;
                                border-right: 6px solid transparent;
                                border-bottom: 20px solid #1a73e8;
                                transform-origin: center 16px;
                                z-index: 3;
                                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
                            "></div>
                            ` : ''}
                        </div>
                        
                        <style>
                            .user-location-container {
                                position: relative;
                                width: 40px;
                                height: 40px;
                            }
                            
                            @keyframes pulse-location {
                                0% { 
                                    transform: translate(-50%, -50%) scale(1); 
                                    opacity: 0.8; 
                                }
                                100% { 
                                    transform: translate(-50%, -50%) scale(1.5); 
                                    opacity: 0; 
                                }
                            }
                            
                            .direction-arrow {
                                transition: transform 0.3s ease-out;
                            }
                        </style>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20],
                    className: 'user-location-icon'
                });
            }

            updateUserLocationMarker() {
                if (this.userLocationMarker) {
                    this.userLocationMarker.setLatLng([this.userLocation.lat, this.userLocation.lng]);
                    
                    // Update the icon to reflect current heading
                    const updatedIcon = this.createDirectionalUserIcon();
                    this.userLocationMarker.setIcon(updatedIcon);
                    
                    // Update popup content
                    this.userLocationMarker.setPopupContent(`
                        <div class="custom-popup">
                            <h3><i class="fas fa-map-marker-alt"></i> Your Location</h3>
                            <p>Lat: ${this.userLocation.lat.toFixed(6)}</p>
                            <p>Lng: ${this.userLocation.lng.toFixed(6)}</p>
                            <p>Accuracy: ±${this.userLocation.accuracy ? Math.round(this.userLocation.accuracy) : 'Unknown'} meters</p>
                            ${this.compassHeading !== null ? `<p>Heading: ${Math.round(this.compassHeading)}°</p>` : ''}
                            <button onclick="window.app.findNearestPandals()" style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 5px;">
                                Find Nearest Pandals
                            </button>
                        </div>
                    `);
                }
            }

            handleLocationError(error) {
                console.error('Location error details:', error);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                let message = 'Unable to get your location. ';
                let instructions = '';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Location access was denied.';
                        if (isMobile) {
                            instructions = '\n\nFor mobile devices:\n1. Ensure your browser has location permission\n2. Check your device\'s location services are enabled\n3. Use HTTPS instead of HTTP (required for mobile)\n4. Try refreshing the page and allow location access';
                        } else {
                            instructions = '\n\nTo enable location tracking:\n1. Click the location icon in your browser\'s address bar\n2. Select "Allow" for location access\n3. Refresh the page and try again';
                        }
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Location information is unavailable.';
                        if (isMobile) {
                            instructions = '\n\nFor mobile devices:\n1. Check your device\'s GPS/location services are enabled\n2. Move to an area with better GPS signal\n3. Ensure mobile data or WiFi is connected';
                        } else {
                            instructions = '\n\nPlease check:\n1. Your device has GPS/location services enabled\n2. You have a stable internet connection\n3. Try refreshing the page';
                        }
                        break;
                    case error.TIMEOUT:
                        message += 'Location request timed out.';
                        if (isMobile) {
                            instructions = '\n\nFor mobile devices:\n1. Move to an area with better GPS signal\n2. Check your internet connection\n3. Close other apps that might be using location';
                        } else {
                            instructions = '\n\nPlease:\n1. Check your internet connection\n2. Make sure you\'re not in a location with poor GPS signal\n3. Try again in a few seconds';
                        }
                        break;
                    default:
                        message += 'An unknown error occurred.';
                        if (isMobile) {
                            instructions = '\n\nFor mobile devices:\n1. Ensure the page is loaded via HTTPS\n2. Check browser permissions for location\n3. Try a different mobile browser';
                        } else {
                            instructions = '\n\nTry:\n1. Refreshing the page\n2. Checking your browser permissions\n3. Using a different browser if the problem persists';
                        }
                        break;
                }
                
                // Show protocol warning for mobile users
                if (isMobile && location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    message += '\n\n⚠️ IMPORTANT: Mobile browsers require HTTPS for location access. Please use a secure connection.';
                }
                
                alert(message + instructions);
                
                console.log('Location error handled:', message + instructions);
            }

            // Helper methods for pandal cards
            focusOnPandal(pandalId) {
                const pandal = this.pandals.find(p => p.id === pandalId);
                if (pandal) {
                    this.map.setView([pandal.lat, pandal.lng], 16);
                    const marker = this.markers.find(m => m.pandalData.id === pandalId);
                    if (marker) {
                        marker.openPopup();
                    }
                }
            }

            quickAddToRoute(pandalId) {
                const pandal = this.pandals.find(p => p.id === pandalId);
                if (!pandal) return;

                // If route planner is not visible, show it
                const planner = document.getElementById('route-planner');
                if (planner.style.display === 'none') {
                    this.toggleRoutePlanner();
                }

                // Check the pandal in the checklist
                const checkbox = document.getElementById(`pandal-${pandalId}`);
                if (checkbox) {
                    checkbox.checked = true;
                    this.updateSelectedCount();
                    
                    // Scroll to the pandal in the checklist
                    checkbox.closest('div').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    // Highlight the checkbox briefly
                    const pandalItem = checkbox.closest('div');
                    pandalItem.style.background = '#e8f5e8';
                    pandalItem.style.border = '2px solid #4caf50';
                    
                    setTimeout(() => {
                        pandalItem.style.background = '#f9f9f9';
                        pandalItem.style.border = 'none';
                    }, 2000);
                    
                    // Show success message
                    this.showBriefMessage(`✓ ${pandal.name} added to route plan!`);
                } else {
                    // If checklist is not loaded yet, show route planner first
                    setTimeout(() => this.quickAddToRoute(pandalId), 100);
                }
            }

            showBriefMessage(message) {
                // Create a brief success message
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 50px;
                    right: 20px;
                    background: #4caf50;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    z-index: 10000;
                    font-size: 14px;
                    animation: slideInRight 0.3s ease;
                `;
                messageDiv.textContent = message;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }

            findNearestPandals() {
                if (!this.userLocation) {
                    alert('Please enable location tracking first.');
                    return;
                }

                // Calculate distances to all pandals
                const pandalDistances = this.pandals.map(pandal => ({
                    ...pandal,
                    distance: this.calculateDistance(this.userLocation, pandal)
                }));

                // Sort by distance and get top 5
                const nearestPandals = pandalDistances
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);

                // Display nearest pandals
                this.displayNearestPandals(nearestPandals);

                // Highlight nearest pandals on map
                this.highlightNearestPandals(nearestPandals);
            }

            displayNearestPandals(nearestPandals) {
                const routeInfo = document.getElementById('route-info');
                routeInfo.innerHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4><i class="fas fa-map-marker-alt"></i> Nearest Pandals</h4>
                        ${nearestPandals.map((pandal, index) => `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; cursor: pointer;" 
                                 onclick="window.app.showPandalRoute(${pandal.id})">
                                <strong>${index + 1}. ${pandal.name}</strong><br>
                                <small>📍 ${pandal.distance.toFixed(2)} km away</small><br>
                                <small>🚇 ${pandal.nearestMetro}</small>
                            </div>
                        `).join('')}
                        <button onclick="window.app.createRouteFromUserLocation()" 
                                style="background: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%;">
                            Plan Route from My Location
                        </button>
                    </div>
                `;
            }

            highlightNearestPandals(nearestPandals) {
                // Reset all markers to default
                this.markers.forEach(marker => {
                    const originalIcon = L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    marker.setIcon(originalIcon);
                });

                // Highlight nearest pandals
                nearestPandals.forEach((pandal, index) => {
                    const marker = this.markers.find(m => m.pandalData.id === pandal.id);
                    if (marker) {
                        const highlightIcon = L.divIcon({
                            html: `<div style="background: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${index + 1}</div>`,
                            iconSize: [30, 30],
                            className: 'nearest-pandal-icon'
                        });
                        marker.setIcon(highlightIcon);
                    }
                });
            }

            showPandalRoute(pandalId) {
                if (!this.userLocation) {
                    alert('Please enable location tracking first.');
                    return;
                }

                const pandal = this.pandals.find(p => p.id === pandalId);
                if (!pandal) return;

                // Create route from user location to pandal
                const waypoints = [
                    L.latLng(this.userLocation.lat, this.userLocation.lng),
                    L.latLng(pandal.lat, pandal.lng)
                ];

                // Remove existing route
                if (this.routeControl) {
                    this.map.removeControl(this.routeControl);
                }

                // Create new route line
                const routeLine = L.polyline(waypoints, {
                    color: '#4285f4',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '5, 10'
                }).addTo(this.map);

                // Fit map to show route
                this.map.fitBounds(routeLine.getBounds(), { padding: [20, 20] });

                // Show route info
                const distance = this.calculateDistance(this.userLocation, pandal);
                const estimatedTime = Math.ceil(distance * 10); // 10 minutes per km

                const routeInfo = document.getElementById('route-info');
                routeInfo.innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4><i class="fas fa-route"></i> Route to ${pandal.name}</h4>
                        <p><strong>Distance:</strong> ${distance.toFixed(2)} km</p>
                        <p><strong>Estimated Time:</strong> ${Math.floor(estimatedTime/60)}h ${estimatedTime%60}m</p>
                        <p><strong>Nearest Metro:</strong> ${pandal.nearestMetro}</p>
                        <p><strong>Crowd Level:</strong> ${pandal.crowdLevel}</p>
                        <button onclick="window.app.addToRoute(${pandal.id})" 
                                style="background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                            Add to My Route Plan
                        </button>
                    </div>
                `;
            }

            createRouteFromUserLocation() {
                if (!this.userLocation) {
                    alert('Please enable location tracking first.');
                    return;
                }

                // Add user location as starting point for route planning
                this.selectedPandals = [{
                    id: 'user',
                    name: 'Your Location',
                    lat: this.userLocation.lat,
                    lng: this.userLocation.lng,
                    area: 'Current',
                    theme: 'Start Point'
                }, ...this.selectedPandals];

                this.updateSelectedPandals();
                
                // Show route planner
                document.getElementById('route-planner').style.display = 'block';
            }
        }

        // Fullscreen functionality
        class FullscreenManager {
            constructor() {
                this.isFullscreen = false;
                this.mapContainer = document.querySelector('.map-container');
                this.fullscreenBtn = document.getElementById('fullscreen-toggle');
                this.fullscreenIcon = this.fullscreenBtn.querySelector('i');
                
                this.init();
            }

            init() {
                this.fullscreenBtn.addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                // Handle escape key to exit fullscreen
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isFullscreen) {
                        this.exitFullscreen();
                    }
                });

                // Handle browser fullscreen change events
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement && this.isFullscreen) {
                        this.exitFullscreen();
                    }
                });
            }

            toggleFullscreen() {
                if (this.isFullscreen) {
                    this.exitFullscreen();
                } else {
                    this.enterFullscreen();
                }
            }

            enterFullscreen() {
                this.mapContainer.classList.add('fullscreen');
                this.fullscreenIcon.className = 'fas fa-compress';
                this.fullscreenBtn.title = 'Exit Fullscreen';
                this.isFullscreen = true;

                // Trigger map resize after transition
                setTimeout(() => {
                    if (window.app && window.app.map) {
                        window.app.map.invalidateSize();
                    }
                }, 300);

                // Optional: Also enter browser fullscreen
                if (this.mapContainer.requestFullscreen) {
                    this.mapContainer.requestFullscreen().catch(err => {
                        console.log('Fullscreen request failed:', err);
                    });
                }
            }

            exitFullscreen() {
                this.mapContainer.classList.remove('fullscreen');
                this.fullscreenIcon.className = 'fas fa-expand';
                this.fullscreenBtn.title = 'Toggle Fullscreen';
                this.isFullscreen = false;

                // Exit browser fullscreen if active
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => {
                        console.log('Exit fullscreen failed:', err);
                    });
                }

                // Trigger map resize after transition
                setTimeout(() => {
                    if (window.app && window.app.map) {
                        window.app.map.invalidateSize();
                    }
                }, 300);
            }
        }

        // Location Selection Functions - Make it globally accessible
        window.selectLocation = function(location) {
            console.log('selectLocation called with:', location);
            
            try {
                // Hide location selector
                const overlay = document.getElementById('location-selector-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                    console.log('Overlay hidden successfully');
                } else {
                    console.error('Overlay element not found');
                    return;
                }
                
                // Set selected location in app
                if (window.app) {
                    console.log('App found, calling setLocation');
                    window.app.setLocation(location);
                } else {
                    console.log('App not ready, storing location for later');
                    // Store location for when app is ready
                    window.selectedLocation = location;
                }
                
                // Update page title and header based on location
                let title, headerTitle;
                if (location === 'kolkata') {
                    title = 'Durga Puja Pandal Map - Kolkata 2025';
                    headerTitle = '<i class="fas fa-map-marker-alt"></i> Kolkata Durga Puja Map 2025';
                } else if (location === 'kalyani') {
                    title = 'Durga Puja Pandal Map - Kalyani 2025';
                    headerTitle = '<i class="fas fa-map-marker-alt"></i> Kalyani Durga Puja Map 2025';
                } else if (location === 'chuchura') {
                    title = 'Durga Puja Pandal Map - Chuchura 2025';
                    headerTitle = '<i class="fas fa-map-marker-alt"></i> Chuchura Durga Puja Map 2025';
                } else if (location === 'bandel') {
                    title = 'Durga Puja Pandal Map - Bandel 2025';
                    headerTitle = '<i class="fas fa-map-marker-alt"></i> Bandel Durga Puja Map 2025';
                }
                
                document.title = title;
                
                const headerElement = document.querySelector('header h1');
                if (headerElement) {
                    headerElement.innerHTML = headerTitle;
                }
                
                // Update suggestion engines with selected area
                if (window.suggestionsEngine && window.suggestionsEngine.updateArea) {
                    window.suggestionsEngine.updateArea(location);
                    console.log('Updated PersonalizedSuggestionsEngine with area:', location);
                }
                
                if (window.weatherTimeEngine && window.weatherTimeEngine.updateArea) {
                    window.weatherTimeEngine.updateArea(location);
                    console.log('Updated WeatherTimeEngine with area:', location);
                }
                
                console.log('Location selection completed successfully');
            } catch (error) {
                console.error('Error in selectLocation:', error);
                alert('Error: ' + error.message);
            }
        };

        // Weather Toggle Function
        window.toggleWeatherWidget = function() {
            const widget = document.getElementById('weather-time-widget');
            const toggleBtn = document.getElementById('weather-toggle-btn');
            
            if (!widget) {
                console.log('Weather widget not found');
                return;
            }
            
            if (widget.style.display === 'none' || !widget.classList.contains('show')) {
                // Show widget
                widget.style.display = 'flex';
                widget.classList.add('show');
                toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                toggleBtn.title = 'Close Weather Widget';
                toggleBtn.style.transform = 'rotate(0deg)';
                
                // Add body class for mobile overlay
                document.body.classList.add('weather-widget-open');
                setTimeout(() => {
                    document.body.classList.add('show-overlay');
                }, 50);
                
                console.log('Weather widget shown');
                
                // Initialize weather data if not already loaded
                if (window.weatherTimeEngine && typeof window.weatherTimeEngine.loadWeatherData === 'function') {
                    window.weatherTimeEngine.loadWeatherData();
                }
            } else {
                // Hide widget
                widget.classList.remove('show');
                document.body.classList.remove('show-overlay');
                
                setTimeout(() => {
                    widget.style.display = 'none';
                    document.body.classList.remove('weather-widget-open');
                }, 300);
                
                toggleBtn.innerHTML = '<i class="fas fa-cloud-sun"></i>';
                toggleBtn.title = 'Show Weather Widget';
                toggleBtn.style.transform = 'rotate(0deg)';
                console.log('Weather widget hidden');
            }
        };

        // Auto-detect Location Function
        window.autoDetectLocation = function() {
            const btn = document.getElementById('location-detect-btn');
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }
            
            // Update button state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
            btn.disabled = true;
            
            const geoOptions = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    console.log('User location detected:', lat, lng);
                    
                    // Determine which area the user is in based on coordinates
                    const detectedArea = determineAreaFromCoordinates(lat, lng);
                    
                    if (detectedArea) {
                        console.log('Detected area:', detectedArea);
                        // Auto-select the detected location
                        window.selectLocation(detectedArea);
                        
                        // Show success message
                        btn.innerHTML = `<i class="fas fa-check"></i> ${detectedArea.charAt(0).toUpperCase() + detectedArea.slice(1)} detected!`;
                        btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                        
                        // Reset button after 3 seconds
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-crosshairs"></i> Auto-detect Location';
                            btn.disabled = false;
                            btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                        }, 3000);
                    } else {
                        // Default to Kolkata if location is outside known areas
                        console.log('Location outside known areas, defaulting to Kolkata');
                        window.selectLocation('kolkata');
                        
                        btn.innerHTML = '<i class="fas fa-info-circle"></i> Defaulted to Kolkata';
                        btn.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
                        
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-crosshairs"></i> Auto-detect Location';
                            btn.disabled = false;
                            btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                        }, 3000);
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    
                    let errorMessage = 'Location detection failed';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location timeout';
                            break;
                    }
                    
                    btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMessage}`;
                    btn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-crosshairs"></i> Auto-detect Location';
                        btn.disabled = false;
                        btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                    }, 3000);
                },
                geoOptions
            );
        };

        // Function to determine area from coordinates
        function determineAreaFromCoordinates(lat, lng) {
            // Define approximate coordinate ranges for each area
            const areas = {
                kolkata: {
                    latMin: 22.470, latMax: 22.650,
                    lngMin: 88.300, lngMax: 88.430
                },
                kalyani: {
                    latMin: 22.900, latMax: 23.000,
                    lngMin: 88.400, lngMax: 88.500
                },
                chuchura: {
                    latMin: 22.880, latMax: 22.920,
                    lngMin: 88.380, lngMax: 88.420
                },
                bandel: {
                    latMin: 22.850, latMax: 22.890,
                    lngMin: 88.350, lngMax: 88.390
                }
            };
            
            // Check which area contains the coordinates
            for (const [areaName, bounds] of Object.entries(areas)) {
                if (lat >= bounds.latMin && lat <= bounds.latMax &&
                    lng >= bounds.lngMin && lng <= bounds.lngMax) {
                    return areaName;
                }
            }
            
            // If no exact match, find the closest area
            let closestArea = null;
            let closestDistance = Infinity;
            
            const areaCenters = {
                kolkata: { lat: 22.5726, lng: 88.3639 },
                kalyani: { lat: 22.9350, lng: 88.4410 },
                chuchura: { lat: 22.9006, lng: 88.3953 },
                bandel: { lat: 22.8707, lng: 88.3673 }
            };
            
            for (const [areaName, center] of Object.entries(areaCenters)) {
                const distance = Math.sqrt(
                    Math.pow(lat - center.lat, 2) + Math.pow(lng - center.lng, 2)
                );
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestArea = areaName;
                }
            }
            
            // Only return closest area if within reasonable distance (about 50km)
            return closestDistance < 0.5 ? closestArea : null;
        }

        // Initialize the application
        let app;
        let fullscreenManager;

        // Mobile touch enhancements
        function initMobileTouchEnhancements() {
            // Prevent zoom on double tap for iOS
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Add touch feedback to buttons and cards
            const touchElements = document.querySelectorAll('.btn, .pandal-card, .location-card');
            touchElements.forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                    this.style.opacity = '0.8';
                }, { passive: true });

                element.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = '';
                        this.style.opacity = '';
                    }, 150);
                }, { passive: true });

                element.addEventListener('touchcancel', function() {
                    this.style.transform = '';
                    this.style.opacity = '';
                }, { passive: true });
            });

            // Improve scroll behavior on mobile
            if ('scrollBehavior' in document.documentElement.style) {
                document.documentElement.style.scrollBehavior = 'smooth';
            }

            // Add swipe detection for sidebar on mobile
            if (window.innerWidth <= 768) {
                let startX, startY, distX, distY;
                const threshold = 150;
                const restraint = 100;

                document.addEventListener('touchstart', function(e) {
                    startX = e.changedTouches[0].pageX;
                    startY = e.changedTouches[0].pageY;
                }, { passive: true });

                document.addEventListener('touchend', function(e) {
                    distX = e.changedTouches[0].pageX - startX;
                    distY = e.changedTouches[0].pageY - startY;
                    
                    if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint) {
                        // Horizontal swipe detected
                        if (distX > 0) {
                            // Swipe right - could show sidebar
                            console.log('Swipe right detected');
                        } else {
                            // Swipe left - could hide sidebar
                            console.log('Swipe left detected');
                        }
                    }
                }, { passive: true });
            }

            // Improve select dropdowns on mobile
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('focus', function() {
                    this.style.fontSize = '16px'; // Prevent zoom on iOS
                });
            });

            // Add haptic feedback for supported devices
            function addHapticFeedback(element) {
                element.addEventListener('click', function() {
                    if (navigator.vibrate) {
                        navigator.vibrate(50); // Short vibration
                    }
                });
            }

            // Add haptic feedback to important buttons
            const importantButtons = document.querySelectorAll('.btn-primary, .btn-success, .pandal-card');
            importantButtons.forEach(addHapticFeedback);
        }

        // HTTPS Help Function
        function showHttpsHelp() {
            const helpText = `
To use live location on mobile devices, you need HTTPS. Here are your options:

📱 QUICK SOLUTION: Use the "Demo Location" button for testing

🔧 FOR DEVELOPERS:

Option 1 - Simple Local HTTPS Server:
1. Install Python if not already installed
2. Run: python -m http.server 8000 --bind 127.0.0.1
3. Access via: http://localhost:8000

Option 2 - Use a service like:
• GitHub Pages (free HTTPS hosting)
• Netlify (free tier available)
• Vercel (free tier available)

Option 3 - Local HTTPS with certificates:
• Use tools like live-server with HTTPS
• Set up local SSL certificates

💡 TIP: Modern mobile browsers block location access on HTTP for security reasons.
            `;
            
            alert(helpText);
        }

        // Feedback System Functions (Global scope)
        let selectedRating = 0;

        function openFeedbackModal() {
            console.log('Opening feedback modal...');
            const modal = document.getElementById('feedbackModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                console.log('Feedback modal opened');
            } else {
                console.error('Feedback modal not found');
            }
        }

        function closeFeedbackModal() {
            console.log('Closing feedback modal...');
            const modal = document.getElementById('feedbackModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Reset form
                selectedRating = 0;
                const nameField = document.getElementById('feedbackName');
                const messageField = document.getElementById('feedbackMessage');
                const formDiv = document.getElementById('feedbackForm');
                const successDiv = document.getElementById('feedbackSuccess');
                
                if (nameField) nameField.value = '';
                if (messageField) messageField.value = '';
                if (formDiv) formDiv.style.display = 'flex';
                if (successDiv) successDiv.style.display = 'none';
                
                // Reset stars
                document.querySelectorAll('.rating-star').forEach(star => {
                    star.classList.remove('active');
                });
                console.log('Feedback modal closed and reset');
            }
        }

        function submitFeedback() {
            console.log('Submitting feedback...');
            const nameField = document.getElementById('feedbackName');
            const messageField = document.getElementById('feedbackMessage');
            
            const name = nameField ? nameField.value || 'Anonymous' : 'Anonymous';
            const message = messageField ? messageField.value.trim() : '';
            
            if (!message) {
                alert('Please share your feedback message!');
                return;
            }

            // Log feedback submission
            console.log('Feedback Submitted:', {
                rating: selectedRating,
                name: name,
                message: message,
                timestamp: new Date().toISOString(),
                page: 'Durga Puja Map'
            });

            // Show success message
            const formDiv = document.getElementById('feedbackForm');
            const successDiv = document.getElementById('feedbackSuccess');
            
            if (formDiv) formDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'block';
            
            console.log('Feedback submitted successfully');
        }

        // Initialize rating system
        function initializeRatingSystem() {
            const stars = document.querySelectorAll('.rating-star');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    console.log('Rating selected:', selectedRating);
                    
                    // Update star display
                    stars.forEach((s, i) => {
                        if (i < selectedRating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });

                star.addEventListener('mouseover', function() {
                    const hoverRating = parseInt(this.dataset.rating);
                    stars.forEach((s, i) => {
                        if (i < hoverRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });

            // Reset stars on mouse leave
            const ratingContainer = document.querySelector('.rating-stars');
            if (ratingContainer) {
                ratingContainer.addEventListener('mouseleave', function() {
                    stars.forEach((s, i) => {
                        if (i < selectedRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            }

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('feedbackModal');
                if (event.target === modal) {
                    closeFeedbackModal();
                }
            });
            
            console.log('Rating system initialized');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app...');
            
            // Show mobile HTTPS notice if needed
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isHTTPS = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (isMobile && !isHTTPS && !isLocalhost) {
                const notice = document.getElementById('mobile-https-notice');
                if (notice) {
                    notice.style.display = 'block';
                    console.log('Showing mobile HTTPS notice');
                }
            }
            
            // Initialize mobile touch enhancements
            initMobileTouchEnhancements();
            
            // Add backup event listeners for location buttons
            const kolkataBtn = document.querySelector("button[onclick=\"window.selectLocation('kolkata')\"]");
            const kalyaniBtn = document.querySelector("button[onclick=\"window.selectLocation('kalyani')\"]");
            
            if (kolkataBtn) {
                kolkataBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Kolkata button clicked via event listener');
                    window.selectLocation('kolkata');
                });
                console.log('Kolkata button event listener added');
            } else {
                console.error('Kolkata button not found');
            }
            
            if (kalyaniBtn) {
                kalyaniBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Kalyani button clicked via event listener');
                    window.selectLocation('kalyani');
                });
                console.log('Kalyani button event listener added');
            } else {
                console.error('Kalyani button not found');
            }
            
            // Initialize feedback system
            initializeRatingSystem();
            
            // Initialize new buttons
            initializeLocationAndWeatherButtons();
            
            app = new DurgaPujaMap();
            fullscreenManager = new FullscreenManager();
            
            // Set initial location if stored
            if (window.selectedLocation) {
                app.setLocation(window.selectedLocation);
            }
            
            // Make app globally accessible
            window.app = app;
            
            // Initialize Go to Top button functionality
            initializeGoToTop();
        });

        // Initialize location and weather buttons
        function initializeLocationAndWeatherButtons() {
            // Initialize weather toggle button
            const weatherToggleBtn = document.getElementById('weather-toggle-btn');
            if (weatherToggleBtn) {
                console.log('Weather toggle button found and initialized');
                
                // Add keyboard accessibility
                weatherToggleBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleWeatherWidget();
                    }
                });
            } else {
                console.error('Weather toggle button not found');
            }
            
            // Initialize auto-detect location button
            const locationDetectBtn = document.getElementById('location-detect-btn');
            if (locationDetectBtn) {
                console.log('Location detect button found and initialized');
                
                // Add keyboard accessibility
                locationDetectBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (!locationDetectBtn.disabled) {
                            autoDetectLocation();
                        }
                    }
                });
                
                // Auto-detect location on first load if geolocation is available
                if (navigator.geolocation && !window.selectedLocation) {
                    console.log('Auto-detecting location on first load...');
                    setTimeout(() => {
                        autoDetectLocation();
                    }, 2000); // Wait 2 seconds after page load
                }
            } else {
                console.error('Location detect button not found');
            }
        }

        // Go to Top Button Functionality
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function initializeGoToTop() {
            const goToTopBtn = document.getElementById('goToTopBtn');
            
            // Show/hide button based on scroll position
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    goToTopBtn.classList.add('show');
                } else {
                    goToTopBtn.classList.remove('show');
                }
            });
        }

        // =====================================
        // ADVANCED MOBILE FEATURES
        // =====================================

        // Global variables for mobile features
        let isOnline = navigator.onLine;
        let shakeThreshold = 15;
        let lastShakeTime = 0;
        let shakeAcceleration = { x: 0, y: 0, z: 0 };
        let currentPandalIndex = 0;
        let swipeStartX = 0;
        let swipeStartY = 0;
        let swipeStartTime = 0;
        let notificationPermission = 'default';

        // Initialize all mobile features
        document.addEventListener('DOMContentLoaded', function() {
            initializeOfflineMode();
            initializeShakeToRefresh();
            initializeSwipeGestures();
            initializeEnhancedMapFeatures();
            initializeConnectionStatus();
        });

        // =====================================
        // OFFLINE MODE IMPLEMENTATION
        // =====================================

        async function initializeOfflineMode() {
            console.log('🔄 Initializing offline mode...');

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('✅ Service Worker registered:', registration);

                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });

                    // Listen for messages from Service Worker
                    navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);

                    // Cache current pandal data
                    if (window.app && window.app.pandals) {
                        await cachePandalData(window.app.pandals);
                    }

                } catch (error) {
                    console.error('❌ Service Worker registration failed:', error);
                }
            }

            // Add offline indicator
            createOfflineIndicator();

            // Listen for online/offline events
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
        }

        function createOfflineIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'offline-indicator';
            indicator.innerHTML = `
                <div class="offline-status">
                    <i class="fas fa-wifi-slash"></i>
                    <span>You're offline. Using cached data.</span>
                </div>
            `;
            indicator.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #ff5722;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 10000;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                font-size: 14px;
                font-weight: 600;
            `;
            document.body.appendChild(indicator);
        }

        function handleOnlineStatus() {
            isOnline = true;
            const indicator = document.getElementById('offline-indicator');
            if (indicator) {
                indicator.style.transform = 'translateY(-100%)';
            }
            console.log('🌐 Connection restored');
            
            // Sync any pending data
            syncOfflineData();
        }

        function handleOfflineStatus() {
            isOnline = false;
            const indicator = document.getElementById('offline-indicator');
            if (indicator) {
                indicator.style.transform = 'translateY(0)';
            }
            console.log('📴 Gone offline');
        }

        async function cachePandalData(pandals) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'CACHE_PANDAL_DATA',
                    data: pandals
                });
            }
        }

        function handleServiceWorkerMessage(event) {
            const { type, data } = event.data;
            
            switch (type) {
                case 'DATA_UPDATED':
                    showDataUpdateNotification();
                    break;
                case 'CACHE_STATUS':
                    updateCacheStatus(data);
                    break;
            }
        }

        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px; border-radius: 8px; z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-download"></i>
                        <div>
                            <div style="font-weight: 600;">Update Available</div>
                            <div style="font-size: 12px; opacity: 0.9;">New version ready to install</div>
                        </div>
                        <button onclick="this.parentElement.parentElement.parentElement.remove(); window.location.reload();" 
                                style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            Update
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        async function syncOfflineData() {
            // Implement data synchronization when back online
            console.log('🔄 Syncing offline data...');
        }

        // =====================================
        // SHAKE-TO-REFRESH GESTURE
        // =====================================

        function initializeShakeToRefresh() {
            console.log('📱 Initializing shake-to-refresh...');

            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleDeviceMotion, false);
                
                // Add shake indicator
                addShakeIndicator();
            } else {
                console.warn('Device motion not supported');
            }
        }

        function handleDeviceMotion(event) {
            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration) return;

            const currentTime = new Date().getTime();
            
            if ((currentTime - lastShakeTime) > 500) { // Throttle shake detection
                const deltaX = Math.abs(shakeAcceleration.x - acceleration.x);
                const deltaY = Math.abs(shakeAcceleration.y - acceleration.y);
                const deltaZ = Math.abs(shakeAcceleration.z - acceleration.z);

                if ((deltaX > shakeThreshold && deltaY > shakeThreshold) || 
                    (deltaX > shakeThreshold && deltaZ > shakeThreshold) || 
                    (deltaY > shakeThreshold && deltaZ > shakeThreshold)) {
                    
                    triggerShakeRefresh();
                    lastShakeTime = currentTime;
                }
            }

            shakeAcceleration.x = acceleration.x;
            shakeAcceleration.y = acceleration.y;
            shakeAcceleration.z = acceleration.z;
        }

        function triggerShakeRefresh() {
            console.log('📳 Shake detected - refreshing data...');
            
            // Show shake animation
            showShakeAnimation();
            
            // Refresh the map and data
            if (window.app) {
                // Refresh pandal data
                if (typeof window.app.refreshData === 'function') {
                    window.app.refreshData();
                } else {
                    // Fallback: reload the page
                    window.location.reload();
                }
            }
            
            // Provide haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }

        function addShakeIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'shake-indicator';
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #666;">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Shake to refresh</span>
                </div>
            `;
            indicator.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                background: rgba(255, 255, 255, 0.9);
                padding: 8px 12px;
                border-radius: 20px;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                opacity: 0.7;
                transition: opacity 0.3s ease;
            `;
            document.body.appendChild(indicator);

            // Hide after 5 seconds
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.style.opacity = '0';
                    setTimeout(() => indicator.remove(), 300);
                }
            }, 5000);
        }

        function showShakeAnimation() {
            const animation = document.createElement('div');
            animation.innerHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 20px;
                    border-radius: 50%;
                    z-index: 10002;
                    animation: shake 0.5s ease-in-out;
                ">
                    <i class="fas fa-sync-alt fa-spin" style="font-size: 24px;"></i>
                </div>
            `;
            
            // Add shake animation CSS
            if (!document.getElementById('shake-animation-css')) {
                const style = document.createElement('style');
                style.id = 'shake-animation-css';
                style.innerHTML = `
                    @keyframes shake {
                        0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
                        25% { transform: translate(-52%, -50%) rotate(-5deg); }
                        75% { transform: translate(-48%, -50%) rotate(5deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(animation);
            
            setTimeout(() => {
                if (animation.parentNode) {
                    animation.remove();
                }
            }, 1000);
        }

        // =====================================
        // SWIPE GESTURES FOR NAVIGATION
        // =====================================

        function initializeSwipeGestures() {
            console.log('👆 Initializing swipe gestures...');

            // Add swipe gesture support for pandal cards
            const pandalContainer = document.getElementById('pandal-checklist') || document.body;
            
            pandalContainer.addEventListener('touchstart', handleSwipeStart, { passive: false });
            pandalContainer.addEventListener('touchmove', handleSwipeMove, { passive: false });
            pandalContainer.addEventListener('touchend', handleSwipeEnd, { passive: false });

            // Add swipe indicators
            addSwipeIndicators();
        }

        function handleSwipeStart(event) {
            const touch = event.touches[0];
            swipeStartX = touch.clientX;
            swipeStartY = touch.clientY;
            swipeStartTime = Date.now();
        }

        function handleSwipeMove(event) {
            if (!swipeStartX || !swipeStartY) return;

            const touch = event.touches[0];
            const deltaX = touch.clientX - swipeStartX;
            const deltaY = touch.clientY - swipeStartY;

            // Prevent default scrolling if horizontal swipe is detected
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                event.preventDefault();
            }
        }

        function handleSwipeEnd(event) {
            if (!swipeStartX || !swipeStartY) return;

            const touch = event.changedTouches[0];
            const deltaX = touch.clientX - swipeStartX;
            const deltaY = touch.clientY - swipeStartY;
            const deltaTime = Date.now() - swipeStartTime;

            // Reset values
            swipeStartX = 0;
            swipeStartY = 0;
            swipeStartTime = 0;

            // Check if it's a valid swipe (fast enough and long enough)
            if (deltaTime < 300 && Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 0) {
                    handleSwipeRight();
                } else {
                    handleSwipeLeft();
                }
            }

            // Check for vertical swipes
            if (deltaTime < 300 && Math.abs(deltaY) > 50 && Math.abs(deltaY) > Math.abs(deltaX)) {
                if (deltaY > 0) {
                    handleSwipeDown();
                } else {
                    handleSwipeUp();
                }
            }
        }

        function handleSwipeRight() {
            console.log('👉 Swipe right detected');
            navigateToPreviousPandal();
            showSwipeAnimation('right');
        }

        function handleSwipeLeft() {
            console.log('👈 Swipe left detected');
            navigateToNextPandal();
            showSwipeAnimation('left');
        }

        function handleSwipeDown() {
            console.log('👇 Swipe down detected');
            showPandalDetails();
            showSwipeAnimation('down');
        }

        function handleSwipeUp() {
            console.log('👆 Swipe up detected');
            hidePandalDetails();
            showSwipeAnimation('up');
        }

        function navigateToNextPandal() {
            if (!window.app || !window.app.pandals) return;

            const filteredPandals = window.app.getFilteredPandals ? 
                window.app.getFilteredPandals() : window.app.pandals;
            
            if (filteredPandals.length === 0) return;

            currentPandalIndex = (currentPandalIndex + 1) % filteredPandals.length;
            const nextPandal = filteredPandals[currentPandalIndex];
            
            focusOnPandal(nextPandal);
            showPandalNavigationIndicator(currentPandalIndex + 1, filteredPandals.length);
        }

        function navigateToPreviousPandal() {
            if (!window.app || !window.app.pandals) return;

            const filteredPandals = window.app.getFilteredPandals ? 
                window.app.getFilteredPandals() : window.app.pandals;
            
            if (filteredPandals.length === 0) return;

            currentPandalIndex = currentPandalIndex === 0 ? 
                filteredPandals.length - 1 : currentPandalIndex - 1;
            const prevPandal = filteredPandals[currentPandalIndex];
            
            focusOnPandal(prevPandal);
            showPandalNavigationIndicator(currentPandalIndex + 1, filteredPandals.length);
        }

        function focusOnPandal(pandal) {
            if (!pandal || !window.app) return;

            // Focus map on pandal
            if (window.app.map) {
                window.app.map.setView([pandal.lat, pandal.lng], 16);
                
                // Highlight the pandal marker
                if (window.app.markers) {
                    Object.values(window.app.markers).forEach(marker => {
                        if (marker.pandal && marker.pandal.id === pandal.id) {
                            marker.openPopup();
                        }
                    });
                }
            }

            // Show pandal details
            showPandalQuickDetails(pandal);
        }

        function showPandalQuickDetails(pandal) {
            // Remove existing quick details
            const existing = document.getElementById('quick-pandal-details');
            if (existing) existing.remove();

            const detailsCard = document.createElement('div');
            detailsCard.id = 'quick-pandal-details';
            detailsCard.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    background: white;
                    border-radius: 12px;
                    padding: 15px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 1001;
                    animation: slideUp 0.3s ease;
                    max-height: 200px;
                    overflow-y: auto;
                ">
                    <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 5px 0; color: #333; font-size: 16px;">${pandal.name}</h3>
                            <p style="margin: 0; color: #666; font-size: 12px;">
                                <i class="fas fa-map-marker-alt"></i> ${pandal.area}
                                <span style="margin-left: 10px;">
                                    <i class="fas fa-users"></i> ${pandal.crowdLevel}
                                </span>
                            </p>
                        </div>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 18px; color: #999; cursor: pointer;">×</button>
                    </div>
                    <p style="margin: 5px 0; font-size: 13px; color: #555;">${pandal.description}</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="getDirections(${pandal.lat}, ${pandal.lng})" 
                                style="flex: 1; background: #4caf50; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                            <i class="fas fa-directions"></i> Directions
                        </button>
                        <button onclick="addToRoute(${pandal.id})" 
                                style="flex: 1; background: #2196f3; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Add to Route
                        </button>
                    </div>
                </div>
            `;

            // Add slideUp animation CSS if not already added
            if (!document.getElementById('swipe-animations-css')) {
                const style = document.createElement('style');
                style.id = 'swipe-animations-css';
                style.innerHTML = `
                    @keyframes slideUp {
                        from { transform: translateY(100%); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    @keyframes slideDown {
                        from { transform: translateY(0); opacity: 1; }
                        to { transform: translateY(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(detailsCard);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (detailsCard.parentNode) {
                    detailsCard.style.animation = 'slideDown 0.3s ease';
                    setTimeout(() => detailsCard.remove(), 300);
                }
            }, 5000);
        }

        function showPandalNavigationIndicator(current, total) {
            // Remove existing indicator
            const existing = document.getElementById('pandal-nav-indicator');
            if (existing) existing.remove();

            const indicator = document.createElement('div');
            indicator.id = 'pandal-nav-indicator';
            indicator.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    z-index: 1002;
                    font-weight: 600;
                ">
                    ${current} of ${total} pandals
                </div>
            `;

            document.body.appendChild(indicator);

            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 2000);
        }

        function showSwipeAnimation(direction) {
            const animation = document.createElement('div');
            let arrow = '';
            let transform = '';

            switch (direction) {
                case 'left':
                    arrow = '←';
                    transform = 'translate(-50%, -50%)';
                    break;
                case 'right':
                    arrow = '→';
                    transform = 'translate(-50%, -50%)';
                    break;
                case 'up':
                    arrow = '↑';
                    transform = 'translate(-50%, -50%)';
                    break;
                case 'down':
                    arrow = '↓';
                    transform = 'translate(-50%, -50%)';
                    break;
            }

            animation.innerHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: ${transform};
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 15px;
                    border-radius: 50%;
                    z-index: 10003;
                    font-size: 24px;
                    font-weight: bold;
                    animation: swipeAnimation 0.5s ease;
                    pointer-events: none;
                ">
                    ${arrow}
                </div>
            `;

            // Add animation CSS
            if (!document.getElementById('swipe-animation-css')) {
                const style = document.createElement('style');
                style.id = 'swipe-animation-css';
                style.innerHTML = `
                    @keyframes swipeAnimation {
                        0% { transform: ${transform} scale(0.5); opacity: 0; }
                        50% { transform: ${transform} scale(1.2); opacity: 1; }
                        100% { transform: ${transform} scale(1); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(animation);

            setTimeout(() => {
                if (animation.parentNode) {
                    animation.remove();
                }
            }, 500);

            // Provide haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function addSwipeIndicators() {
            const indicators = document.createElement('div');
            indicators.id = 'swipe-indicators';
            indicators.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 140px;
                    right: 20px;
                    background: rgba(255, 255, 255, 0.9);
                    padding: 10px;
                    border-radius: 8px;
                    font-size: 10px;
                    color: #666;
                    z-index: 1000;
                    max-width: 120px;
                    line-height: 1.3;
                ">
                    <div style="font-weight: 600; margin-bottom: 5px;">Swipe Gestures:</div>
                    <div>← → Next/Previous pandal</div>
                    <div>↑ ↓ Show/Hide details</div>
                </div>
            `;

            document.body.appendChild(indicators);

            // Hide after 8 seconds
            setTimeout(() => {
                if (indicators.parentNode) {
                    indicators.style.opacity = '0';
                    indicators.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => indicators.remove(), 300);
                }
            }, 8000);
        }

        function showPandalDetails() {
            // Expand the current pandal details or show more info
            const quickDetails = document.getElementById('quick-pandal-details');
            if (quickDetails) {
                // Make it taller to show more details
                quickDetails.style.maxHeight = '60vh';
                quickDetails.style.overflowY = 'auto';
            }
        }

        function hidePandalDetails() {
            const quickDetails = document.getElementById('quick-pandal-details');
            if (quickDetails) {
                quickDetails.remove();
            }
        }

        // =====================================
        // ENHANCED INTERACTIVE MAP FEATURES
        // =====================================

        function initializeEnhancedMapFeatures() {
            console.log('🗺️ Initializing enhanced map features...');

            // Wait for map to be initialized
            setTimeout(() => {
                if (window.app && window.app.map) {
                    addEnhancedMapControls();
                    addMapGestures();
                }
            }, 2000);
        }

        function addEnhancedMapControls() {
            const map = window.app.map;
            if (!map) return;

            // Add custom map controls
            const customControls = L.control({ position: 'topleft' });
            customControls.onAdd = function() {
                const div = L.DomUtil.create('div', 'custom-map-controls');
                div.innerHTML = `
                    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); padding: 5px;">
                        <button id="locate-btn" title="My Location" style="
                            display: block; width: 35px; height: 35px; border: none; background: #4caf50; 
                            color: white; border-radius: 4px; margin-bottom: 5px; cursor: pointer;
                        ">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button id="traffic-btn" title="Traffic Info" style="
                            display: block; width: 35px; height: 35px; border: none; background: #ff9800; 
                            color: white; border-radius: 4px; cursor: pointer;
                        ">
                            <i class="fas fa-traffic-light"></i>
                        </button>
                    </div>
                `;
                return div;
            };
            customControls.addTo(map);

            // Add event listeners for custom controls
            setTimeout(() => {
                document.getElementById('locate-btn').onclick = centerOnUserLocation;
                document.getElementById('traffic-btn').onclick = toggleTrafficInfo;
            }, 100);
        }

        function addMapGestures() {
            const map = window.app.map;
            if (!map) return;

            // Enhanced touch controls
            let longPressTimer;
            let longPressActive = false;

            map.on('mousedown touchstart', function(e) {
                longPressActive = false;
                longPressTimer = setTimeout(() => {
                    longPressActive = true;
                    handleLongPress(e);
                }, 800); // 800ms for long press
            });

            map.on('mouseup touchend mousemove touchmove', function() {
                clearTimeout(longPressTimer);
                longPressActive = false;
            });

            // Double-tap to zoom to pandal
            let lastTap = 0;
            map.on('click', function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    // Double tap detected
                    findNearestPandalAndZoom(e.latlng);
                }
                lastTap = currentTime;
            });
        }

        function handleLongPress(e) {
            const latlng = e.latlng;
            
            // Show context menu
            showLocationContextMenu(e.containerPoint, latlng);

            // Provide haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
        }

        function showLocationContextMenu(point, latlng) {
            const contextMenu = document.createElement('div');
            contextMenu.innerHTML = `
                <div style="
                    position: fixed;
                    top: ${point.y}px;
                    left: ${point.x}px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10004;
                    min-width: 150px;
                    animation: fadeIn 0.2s ease;
                " id="map-context-menu">
                    <div style="padding: 10px; border-bottom: 1px solid #eee; font-weight: 600; font-size: 12px;">
                        Location Options
                    </div>
                    <button onclick="getDirectionsToLocation(${latlng.lat}, ${latlng.lng})" style="
                        width: 100%; padding: 10px; border: none; background: none; text-align: left; cursor: pointer; font-size: 13px;
                    ">
                        <i class="fas fa-directions"></i> Get Directions
                    </button>
                    <button onclick="findNearbyPandals(${latlng.lat}, ${latlng.lng})" style="
                        width: 100%; padding: 10px; border: none; background: none; text-align: left; cursor: pointer; font-size: 13px;
                    ">
                        <i class="fas fa-search"></i> Find Nearby Pandals
                    </button>
                    <button onclick="document.getElementById('map-context-menu').remove()" style="
                        width: 100%; padding: 10px; border: none; background: #f44336; color: white; text-align: center; cursor: pointer; font-size: 13px; border-radius: 0 0 8px 8px;
                    ">
                        Cancel
                    </button>
                </div>
            `;

            document.body.appendChild(contextMenu);

            // Remove menu after 5 seconds
            setTimeout(() => {
                const menu = document.getElementById('map-context-menu');
                if (menu) menu.remove();
            }, 5000);
        }

        function centerOnUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    window.app.map.setView([lat, lng], 16);
                    
                    // Add or update user location marker
                    if (window.userLocationMarker) {
                        window.userLocationMarker.setLatLng([lat, lng]);
                    } else {
                        window.userLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<div style="background: #4caf50; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(window.app.map);
                    }
                }, (error) => {
                    alert('Unable to get your location. Please enable location services.');
                });
            }
        }

        function toggleTrafficInfo() {
            showTransportInfo('Traffic status: Moderate congestion expected during festival hours (6 PM - 11 PM)');
        }

        function findNearestPandalAndZoom(latlng) {
            if (!window.app || !window.app.pandals) return;

            const nearest = window.app.pandals.reduce((nearest, pandal) => {
                const distance = calculateDistance(latlng.lat, latlng.lng, pandal.lat, pandal.lng);
                return distance < nearest.distance ? { pandal, distance } : nearest;
            }, { distance: Infinity });

            if (nearest.pandal) {
                window.app.map.setView([nearest.pandal.lat, nearest.pandal.lng], 17);
                focusOnPandal(nearest.pandal);
            }
        }

        // =====================================
        // TRANSPORT INTEGRATION
        // =====================================

        // Initialize connection status monitoring
        function initializeConnectionStatus() {
            const statusIndicator = document.createElement('div');
            statusIndicator.id = 'connection-status';
            statusIndicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: ${isOnline ? '#4caf50' : '#f44336'};
                z-index: 10007;
                border: 2px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(statusIndicator);

            // Update status on connection change
            window.addEventListener('online', () => {
                statusIndicator.style.background = '#4caf50';
            });

            window.addEventListener('offline', () => {
                statusIndicator.style.background = '#f44336';
            });
        }

        // Utility functions
        function getDirections(lat, lng) {
            if (window.app && typeof window.app.getDirectionsTo === 'function') {
                window.app.getDirectionsTo(lat, lng);
            } else {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
            }
        }

        function addToRoute(pandalId) {
            if (window.app && typeof window.app.addPandal === 'function') {
                window.app.addPandal(pandalId);
            }
        }

        function getDirectionsToLocation(lat, lng) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
        }

        function findNearbyPandals(lat, lng) {
            if (!window.app || !window.app.pandals) return;

            const nearby = window.app.pandals.filter(pandal => {
                const distance = calculateDistance(lat, lng, pandal.lat, pandal.lng);
                return distance <= 1; // Within 1km
            });

            if (nearby.length > 0) {
                showTransportInfo(`Found ${nearby.length} pandals within 1km of this location`);
            } else {
                showTransportInfo('No pandals found within 1km of this location');
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        console.log('🚀 All advanced mobile features initialized!');





        // =====================================
        // AREA-SPECIFIC DATA CONFIGURATIONS
        // =====================================

        class AreaDataManager {
            static getAreaConfig(selectedArea) {
                const areaConfigs = {
                    kolkata: {
                        weatherPatterns: {
                            averageTemp: { min: 26, max: 33 },
                            humidity: { min: 65, max: 85 },
                            rainProbability: 0.3,
                            windSpeed: { min: 8, max: 18 },
                            bestVisitTimes: ['6:00-9:00 AM', '7:00-10:00 PM'],
                            crowdPeakHours: ['6:00-11:00 PM', '9:00 AM-12:00 PM']
                        },
                        culturalInfo: {
                            specialEvents: ['Sindoor Khela at Kumortuli', 'Dhaki competitions', 'Cultural programs at Mohammad Ali Park'],
                            localCuisine: ['Street food at Park Circus', 'Bhog at Bagbazar', 'Mishti at traditional shops'],
                            transportTips: ['Use Metro for major pandals', 'Buses available till late night', 'Book cabs in advance'],
                            photography: ['Golden hour at Bagbazar', 'Night lighting at Sreebhumi', 'Traditional art at Kumortuli']
                        },
                        popularAreas: ['North Kolkata (Traditional)', 'South Kolkata (Theme-based)', 'Central (Historic)', 'Salt Lake (Modern)'],
                        famousPandals: ['Bagbazar Sarbojanin', 'Sreebhumi Sporting Club', 'Suruchi Sangha', 'College Square']
                    },
                    kalyani: {
                        weatherPatterns: {
                            averageTemp: { min: 24, max: 31 },
                            humidity: { min: 60, max: 80 },
                            rainProbability: 0.25,
                            windSpeed: { min: 10, max: 20 },
                            bestVisitTimes: ['5:30-8:30 AM', '6:30-9:30 PM'],
                            crowdPeakHours: ['7:00-10:00 PM', '8:00-11:00 AM']
                        },
                        culturalInfo: {
                            specialEvents: ['Township community programs', 'Cultural competitions', 'Garden celebrations'],
                            localCuisine: ['Home-style Bengali food', 'Community bhog distribution', 'Local sweet shops'],
                            transportTips: ['Local buses connect all areas', 'Auto-rickshaws available', 'Cycle-friendly roads'],
                            photography: ['Garden settings', 'Township architecture', 'Community celebrations']
                        },
                        popularAreas: ['ITI More Area', 'Rathtala', 'Township Blocks', 'Park Areas'],
                        famousPandals: ['Kalyani ITI More', 'RathTala Sarbojanin', 'Kalyani Boat Park', 'A-9 Square Park']
                    },
                    chuchura: {
                        weatherPatterns: {
                            averageTemp: { min: 25, max: 32 },
                            humidity: { min: 70, max: 90 },
                            rainProbability: 0.35,
                            windSpeed: { min: 6, max: 15 },
                            bestVisitTimes: ['5:00-8:00 AM', '6:00-9:00 PM'],
                            crowdPeakHours: ['7:00-10:00 PM', '9:00 AM-12:00 PM']
                        },
                        culturalInfo: {
                            specialEvents: ['River aarti at ghats', 'Traditional folk music', 'Heritage walks'],
                            localCuisine: ['Riverside snacks', 'Traditional Bengali meals', 'Local mishti shops'],
                            transportTips: ['River transport available', 'Local rickshaws', 'Heritage walking tours'],
                            photography: ['Historic riverside views', 'Traditional architecture', 'Ghat celebrations']
                        },
                        popularAreas: ['Chapatola', 'Panchanan Tala', 'Riverside Ghats', 'Historic Center'],
                        famousPandals: ['Chapatola', 'Shyambabur Ghat', 'Madhabitola', 'Panchanan Tala']
                    },
                    bandel: {
                        weatherPatterns: {
                            averageTemp: { min: 25, max: 32 },
                            humidity: { min: 65, max: 85 },
                            rainProbability: 0.3,
                            windSpeed: { min: 8, max: 16 },
                            bestVisitTimes: ['5:30-8:30 AM', '6:30-9:30 PM'],
                            crowdPeakHours: ['7:00-9:30 PM', '8:30-11:00 AM']
                        },
                        culturalInfo: {
                            specialEvents: ['Church-temple harmony celebrations', 'Heritage festivals', 'Community gatherings'],
                            localCuisine: ['Portuguese-Bengali fusion', 'Traditional sweets', 'Heritage recipes'],
                            transportTips: ['Heritage railway station', 'Local buses', 'Heritage site tours'],
                            photography: ['Portuguese architecture', 'Heritage buildings', 'Cultural fusion']
                        },
                        popularAreas: ['Historic Center', 'Ujjal Sangha Area', 'Heritage Quarter', 'Residential Areas'],
                        famousPandals: ['Ujjal Sangha', 'Nabin Sangha', 'Kailash Nagar']
                    }
                };
                
                return areaConfigs[selectedArea] || areaConfigs.kolkata;
            }

            static getAreaSpecificPandals(selectedArea, allPandals) {
                return allPandals.filter(pandal => pandal.location === selectedArea);
            }

            static getAreaWeatherAdjustments(selectedArea, baseWeather) {
                const config = this.getAreaConfig(selectedArea);
                const patterns = config.weatherPatterns;
                
                // Adjust weather based on area characteristics
                const adjustedWeather = { ...baseWeather };
                
                // Apply area-specific temperature ranges
                if (adjustedWeather.temperature < patterns.averageTemp.min) {
                    adjustedWeather.temperature = patterns.averageTemp.min + Math.random() * 3;
                } else if (adjustedWeather.temperature > patterns.averageTemp.max) {
                    adjustedWeather.temperature = patterns.averageTemp.max - Math.random() * 2;
                }
                
                // Adjust humidity based on area
                adjustedWeather.humidity = Math.max(patterns.humidity.min, 
                    Math.min(patterns.humidity.max, adjustedWeather.humidity));
                
                // Adjust rain probability
                adjustedWeather.isRaining = Math.random() < patterns.rainProbability;
                
                return adjustedWeather;
            }
        }

        // =====================================
        // PERSONALIZED SUGGESTIONS ENGINE
        // =====================================

        class PersonalizedSuggestionsEngine {
            constructor(selectedArea = 'kolkata') {
                this.selectedArea = selectedArea;
                this.areaConfig = AreaDataManager.getAreaConfig(selectedArea);
                this.userProfile = this.loadUserProfile();
                this.visitHistory = this.loadVisitHistory();
                this.preferences = this.loadPreferences();
                this.behaviorTracker = new UserBehaviorTracker();
                this.initializeSuggestions();
            }

            // Method to update area when user changes location
            updateArea(newArea) {
                this.selectedArea = newArea;
                this.areaConfig = AreaDataManager.getAreaConfig(newArea);
                this.generateDailySuggestions();
                this.updateAreaSpecificHeader();
            }

            updateAreaSpecificHeader() {
                const headerTitle = document.querySelector('#suggestions-panel h3');
                if (headerTitle) {
                    const areaNames = {
                        kolkata: 'Kolkata',
                        kalyani: 'Kalyani', 
                        chuchura: 'Chuchura',
                        bandel: 'Bandel'
                    };
                    headerTitle.innerHTML = `✨ ${areaNames[this.selectedArea]} Suggestions`;
                }
            }

            initializeSuggestions() {
                this.createSuggestionsInterface();
                this.startPersonalizationTracking();
                this.generateDailySuggestions();
            }

            createSuggestionsInterface() {
                const suggestionsContainer = document.createElement('div');
                suggestionsContainer.innerHTML = `
                    <div id="suggestions-panel" style="
                        position: fixed;
                        top: 140px;
                        left: 20px;
                        width: 320px;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        z-index: 10012;
                        display: none;
                        max-height: 70vh;
                        overflow-y: auto;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #8e24aa 0%, #3f51b5 100%);
                            color: white;
                            padding: 15px;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        ">
                            <h3 style="margin: 0; font-size: 16px;">✨ Personal Suggestions</h3>
                            <button onclick="window.suggestionsEngine.closePanel()" style="
                                background: none; border: none; color: white; font-size: 20px; cursor: pointer;
                            ">×</button>
                        </div>

                        <div style="padding: 20px;">
                            <div id="user-insights" style="
                                background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                border-left: 4px solid #8e24aa;
                            ">
                                <h4 style="margin: 0 0 10px 0; color: #4a148c; font-size: 14px;">🎯 Your Puja Profile</h4>
                                <div id="profile-stats" style="font-size: 12px; color: #6a1b9a;"></div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                    🌟 Today's Picks for You
                                </h4>
                                <div id="daily-suggestions" style="font-size: 13px;"></div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 14px;">📈 Trending & Similar Tastes</h4>
                                <div id="trending-suggestions" style="font-size: 13px;"></div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 14px;">🔍 Discover New</h4>
                                <div id="discovery-suggestions" style="font-size: 13px;"></div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">⚙️ Tune Your Preferences</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                                        <input type="checkbox" id="pref-traditional" onchange="window.suggestionsEngine.updatePreference('traditional', this.checked)">
                                        Traditional
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                                        <input type="checkbox" id="pref-modern" onchange="window.suggestionsEngine.updatePreference('modern', this.checked)">
                                        Modern
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                                        <input type="checkbox" id="pref-photography" onchange="window.suggestionsEngine.updatePreference('photography', this.checked)">
                                        Photography
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                                        <input type="checkbox" id="pref-cultural" onchange="window.suggestionsEngine.updatePreference('cultural', this.checked)">
                                        Cultural
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                                        <input type="checkbox" id="pref-food" onchange="window.suggestionsEngine.updatePreference('food', this.checked)">
                                        Food
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                                        <input type="checkbox" id="pref-crowds" onchange="window.suggestionsEngine.updatePreference('crowds', this.checked)">
                                        Avoid Crowds
                                    </label>
                                </div>
                            </div>

                            <button onclick="window.suggestionsEngine.refreshSuggestions()" style="
                                width: 100%;
                                padding: 10px;
                                background: linear-gradient(135deg, #8e24aa 0%, #3f51b5 100%);
                                color: white;
                                border: none;
                                border-radius: 6px;
                                font-size: 13px;
                                cursor: pointer;
                            ">
                                🔄 Refresh Suggestions
                            </button>
                        </div>
                    </div>

                    <button onclick="window.suggestionsEngine.togglePanel()" style="
                        position: fixed;
                        top: 140px;
                        left: 20px;
                        width: 50px;
                        height: 50px;
                        border-radius: 25px;
                        background: linear-gradient(135deg, #8e24aa 0%, #3f51b5 100%);
                        color: white;
                        border: none;
                        cursor: pointer;
                        z-index: 10013;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        font-size: 18px;
                    " id="suggestions-toggle">
                        ✨
                    </button>
                `;

                document.body.appendChild(suggestionsContainer);
                this.loadPreferenceStates();
            }

            togglePanel() {
                const panel = document.getElementById('suggestions-panel');
                const button = document.getElementById('suggestions-toggle');
                
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    button.innerHTML = '✕';
                    this.updateUserProfile();
                    this.generateDailySuggestions();
                } else {
                    panel.style.display = 'none';
                    button.innerHTML = '✨';
                }
            }

            closePanel() {
                document.getElementById('suggestions-panel').style.display = 'none';
                document.getElementById('suggestions-toggle').innerHTML = '✨';
            }

            loadPreferenceStates() {
                const prefs = this.preferences;
                document.getElementById('pref-traditional').checked = prefs.traditional || false;
                document.getElementById('pref-modern').checked = prefs.modern || false;
                document.getElementById('pref-photography').checked = prefs.photography || false;
                document.getElementById('pref-cultural').checked = prefs.cultural || false;
                document.getElementById('pref-food').checked = prefs.food || false;
                document.getElementById('pref-crowds').checked = prefs.crowds || false;
            }

            updatePreference(type, value) {
                this.preferences[type] = value;
                this.savePreferences();
                this.generateDailySuggestions();
            }

            generateDailySuggestions() {
                this.updateUserProfile();
                
                const personalizedPicks = this.getPersonalizedPicks();
                const trendingSuggestions = this.getTrendingSuggestions();
                const discoverySuggestions = this.getDiscoverySuggestions();

                this.displaySuggestions(personalizedPicks, trendingSuggestions, discoverySuggestions);
            }

            updateUserProfile() {
                const stats = this.calculateUserStats();
                const profileDiv = document.getElementById('profile-stats');
                
                if (profileDiv) {
                    profileDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>🏛️ Visited: ${stats.totalVisits} pandals</div>
                            <div>🏆 Favorite: ${stats.favoriteType}</div>
                            <div>⏱️ Avg Time: ${stats.avgTimeSpent} min</div>
                            <div>📅 Days Active: ${stats.activeDays}</div>
                        </div>
                        <div style="background: rgba(142, 36, 170, 0.1); padding: 8px; border-radius: 4px; margin-top: 8px;">
                            <strong>Your Style:</strong> ${stats.userStyle}
                        </div>
                    `;
                }
            }

            getPersonalizedPicks() {
                const userHistory = this.visitHistory;
                const preferences = this.preferences;
                const suggestions = [];
                const famousPandals = this.areaConfig.famousPandals;
                const culturalInfo = this.areaConfig.culturalInfo;

                // Area-specific suggestions based on user preferences
                if (userHistory.traditional > userHistory.modern || preferences.traditional) {
                    if (this.selectedArea === 'kolkata') {
                        suggestions.push({
                            pandal: 'Kumartuli Park',
                            reason: 'Traditional clay work artistry in the famous potter\'s quarter',
                            confidence: 95,
                            icon: '🏛️',
                            tips: 'Best clay work viewing: 7-9 AM, witness artisans at work'
                        });
                    } else if (this.selectedArea === 'kalyani') {
                        suggestions.push({
                            pandal: 'RathTala Sarbojanin',
                            reason: 'Celebrates traditional 5-day spirit with community involvement',
                            confidence: 90,
                            icon: '🏛️',
                            tips: 'Experience township community celebrations'
                        });
                    } else if (this.selectedArea === 'chuchura') {
                        suggestions.push({
                            pandal: 'Chapatola',
                            reason: 'Historic pandal in the heart of heritage Chuchura',
                            confidence: 88,
                            icon: '🏛️',
                            tips: 'Perfect for heritage walks and traditional celebrations'
                        });
                    } else if (this.selectedArea === 'bandel') {
                        suggestions.push({
                            pandal: 'Ujjal Sangha',
                            reason: 'Traditional celebrations in historic heritage town',
                            confidence: 86,
                            icon: '🏛️',
                            tips: 'Experience Portuguese-Bengali cultural fusion'
                        });
                    }
                }

                if (preferences.photography) {
                    if (this.selectedArea === 'kolkata') {
                        suggestions.push({
                            pandal: 'Sreebhumi Sporting Club',
                            reason: 'Instagram-worthy grand replica monuments',
                            confidence: 92,
                            icon: '📸',
                            tips: culturalInfo.photography[1] || 'Golden hour: 6:30-7:30 PM'
                        });
                    } else if (this.selectedArea === 'kalyani') {
                        suggestions.push({
                            pandal: 'Kalyani ITI More',
                            reason: 'Governor\'s award winner for visual delight',
                            confidence: 89,
                            icon: '📸',
                            tips: 'Garden settings with township architecture backdrop'
                        });
                    } else if (this.selectedArea === 'chuchura') {
                        suggestions.push({
                            pandal: 'Shyambabur Ghat',
                            reason: 'Scenic riverside location perfect for photography',
                            confidence: 87,
                            icon: '📸',
                            tips: 'Historic riverside views during sunset hours'
                        });
                    } else if (this.selectedArea === 'bandel') {
                        suggestions.push({
                            pandal: 'Nabin Sangha',
                            reason: 'Heritage architecture with cultural significance',
                            confidence: 85,
                            icon: '📸',
                            tips: 'Portuguese architecture meets Bengali traditions'
                        });
                    }
                }

                if (preferences.cultural) {
                    if (this.selectedArea === 'kolkata') {
                        suggestions.push({
                            pandal: 'Mohammad Ali Park',
                            reason: 'Rich cultural programs and art installations',
                            confidence: 92,
                            icon: '🎭',
                            tips: culturalInfo.specialEvents[2] || 'Cultural shows: 7-9 PM daily'
                        });
                    } else if (this.selectedArea === 'kalyani') {
                        suggestions.push({
                            pandal: 'BJ Block Saradotsav',
                            reason: 'Cultural events and community programs',
                            confidence: 88,
                            icon: '🎭',
                            tips: 'Township community cultural competitions'
                        });
                    } else if (this.selectedArea === 'chuchura') {
                        suggestions.push({
                            pandal: 'Kanaksali',
                            reason: 'Traditional folk music and cultural events',
                            confidence: 86,
                            icon: '🎭',
                            tips: 'River aarti and traditional Bengali music performances'
                        });
                    } else if (this.selectedArea === 'bandel') {
                        suggestions.push({
                            pandal: 'Kailash Nagar',
                            reason: 'Community cultural gatherings with heritage touch',
                            confidence: 84,
                            icon: '🎭',
                            tips: 'Church-temple harmony celebrations'
                        });
                    }
                }

                if (preferences.food) {
                    const foodTip = culturalInfo.localCuisine[0] || 'Local food specialties available';
                    if (this.selectedArea === 'kolkata') {
                        suggestions.push({
                            pandal: 'Park Circus',
                            reason: 'Amazing street food stalls and traditional bhog',
                            confidence: 90,
                            icon: '🍕',
                            tips: foodTip
                        });
                    } else if (this.selectedArea === 'kalyani') {
                        suggestions.push({
                            pandal: 'Prafulla Kanan',
                            reason: 'Home-style Bengali food and community bhog',
                            confidence: 87,
                            icon: '🍕',
                            tips: foodTip
                        });
                    } else if (this.selectedArea === 'chuchura') {
                        suggestions.push({
                            pandal: 'Madhabitola',
                            reason: 'Traditional Bengali meals and riverside snacks',
                            confidence: 85,
                            icon: '🍕',
                            tips: foodTip
                        });
                    } else if (this.selectedArea === 'bandel') {
                        suggestions.push({
                            pandal: 'Ujjal Sangha',
                            reason: 'Portuguese-Bengali fusion cuisine and heritage recipes',
                            confidence: 83,
                            icon: '🍕',
                            tips: foodTip
                        });
                    }
                }

                // Add area-specific default suggestion if none match
                if (suggestions.length === 0) {
                    suggestions.push({
                        pandal: famousPandals[0] || 'Local Heritage Pandal',
                        reason: `Great starting point for exploring ${this.selectedArea}`,
                        confidence: 75,
                        icon: '⭐',
                        tips: 'Best visited during early morning or evening hours'
                    });
                }

                // Add area-specific cultural insights
                suggestions.push({
                    pandal: 'Cultural Highlight',
                    reason: culturalInfo.specialEvents[0] || 'Special cultural event',
                    confidence: 80,
                    icon: '🎪',
                    tips: culturalInfo.transportTips[0] || 'Check local transport options'
                });

                return suggestions.slice(0, 3); // Top 3 picks
            }

            getTrendingSuggestions() {
                // Simulated trending data based on user behavior patterns
                return [
                    {
                        pandal: 'Tridhara Sammilani',
                        trend: 'Rising 📈',
                        reason: 'Users with similar tastes loved it',
                        socialProof: '234 people like you visited',
                        rating: 4.6
                    },
                    {
                        pandal: 'Ekdalia Evergreen',
                        trend: 'Hot 🔥',
                        reason: 'Trending among photography enthusiasts',
                        socialProof: 'Featured in 45 social posts today',
                        rating: 4.4
                    }
                ];
            }

            getDiscoverySuggestions() {
                const unvisited = this.getUnvisitedPandals();
                const discoveries = [];

                unvisited.forEach(pandal => {
                    if (this.wouldUserLike(pandal)) {
                        discoveries.push({
                            pandal: pandal.name,
                            reason: `Hidden gem for ${this.getUserPersona()} like you`,
                            discoveryScore: Math.floor(Math.random() * 30) + 70,
                            uniqueFeature: pandal.uniqueFeature || 'Unique decorative theme'
                        });
                    }
                });

                return discoveries.slice(0, 2);
            }

            displaySuggestions(personalizedPicks, trending, discovery) {
                // Daily suggestions
                const dailyDiv = document.getElementById('daily-suggestions');
                if (dailyDiv) {
                    let html = '';
                    personalizedPicks.forEach(pick => {
                        html += `
                            <div style="
                                border: 1px solid #e1bee7;
                                border-radius: 8px;
                                padding: 12px;
                                margin-bottom: 10px;
                                background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%);
                            ">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <div style="font-weight: bold; color: #4a148c;">${pick.icon} ${pick.pandal}</div>
                                    <div style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">
                                        ${pick.confidence}% match
                                    </div>
                                </div>
                                <div style="color: #6a1b9a; font-size: 11px; margin-bottom: 6px;">${pick.reason}</div>
                                <div style="background: rgba(74, 20, 140, 0.1); padding: 6px; border-radius: 4px; font-size: 10px; color: #4a148c;">
                                    💡 ${pick.tips}
                                </div>
                            </div>
                        `;
                    });
                    dailyDiv.innerHTML = html;
                }

                // Trending suggestions
                const trendingDiv = document.getElementById('trending-suggestions');
                if (trendingDiv) {
                    let html = '';
                    trending.forEach(item => {
                        html += `
                            <div style="
                                border: 1px solid #e8f5e8;
                                border-radius: 8px;
                                padding: 12px;
                                margin-bottom: 10px;
                                background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
                            ">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                    <div style="font-weight: bold; color: #2e7d32;">${item.pandal}</div>
                                    <div style="color: #ff6b6b; font-size: 11px; font-weight: bold;">${item.trend}</div>
                                </div>
                                <div style="color: #388e3c; font-size: 11px; margin-bottom: 4px;">${item.reason}</div>
                                <div style="display: flex; align-items: center; justify-content: space-between; font-size: 10px; color: #4caf50;">
                                    <span>👥 ${item.socialProof}</span>
                                    <span>⭐ ${item.rating}</span>
                                </div>
                            </div>
                        `;
                    });
                    trendingDiv.innerHTML = html;
                }

                // Discovery suggestions
                const discoveryDiv = document.getElementById('discovery-suggestions');
                if (discoveryDiv) {
                    let html = '';
                    discovery.forEach(item => {
                        html += `
                            <div style="
                                border: 1px solid #fff3e0;
                                border-radius: 8px;
                                padding: 12px;
                                margin-bottom: 10px;
                                background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%);
                            ">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                    <div style="font-weight: bold; color: #e65100;">🔍 ${item.pandal}</div>
                                    <div style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">
                                        ${item.discoveryScore}% discovery
                                    </div>
                                </div>
                                <div style="color: #f57c00; font-size: 11px; margin-bottom: 4px;">${item.reason}</div>
                                <div style="background: rgba(229, 81, 0, 0.1); padding: 6px; border-radius: 4px; font-size: 10px; color: #e65100;">
                                    ✨ ${item.uniqueFeature}
                                </div>
                            </div>
                        `;
                    });
                    discoveryDiv.innerHTML = html || '<div style="text-align: center; color: #666; padding: 20px;">All discovered! 🎉</div>';
                }
            }

            refreshSuggestions() {
                // Add loading animation
                document.getElementById('daily-suggestions').innerHTML = '<div style="text-align: center; padding: 20px;"><div style="animation: spin 1s linear infinite;">🔄</div><br>Updating suggestions...</div>';
                
                setTimeout(() => {
                    this.generateDailySuggestions();
                }, 1500);
            }

            calculateUserStats() {
                const history = this.visitHistory;
                const totalVisits = history.pandals?.length || 0;
                const avgTimeSpent = history.totalTime ? Math.floor(history.totalTime / Math.max(totalVisits, 1)) : 30;
                
                let favoriteType = 'Traditional';
                if (history.modern > history.traditional) favoriteType = 'Modern';
                if (history.cultural > Math.max(history.modern, history.traditional)) favoriteType = 'Cultural';

                let userStyle = 'Explorer';
                if (this.preferences.photography) userStyle = 'Visual Artist';
                else if (this.preferences.cultural) userStyle = 'Culture Enthusiast';
                else if (this.preferences.traditional) userStyle = 'Traditionalist';
                else if (this.preferences.modern) userStyle = 'Modernist';

                return {
                    totalVisits,
                    favoriteType,
                    avgTimeSpent,
                    activeDays: Math.min(totalVisits, 7),
                    userStyle
                };
            }

            wouldUserLike(pandal) {
                const preferences = this.preferences;
                const score = 
                    (preferences.traditional && pandal.type === 'traditional' ? 20 : 0) +
                    (preferences.modern && pandal.type === 'modern' ? 20 : 0) +
                    (preferences.photography && pandal.photogenic ? 15 : 0) +
                    (preferences.cultural && pandal.cultural ? 15 : 0);
                
                return score >= 15;
            }

            getUserPersona() {
                const prefs = this.preferences;
                if (prefs.photography) return 'photography enthusiasts';
                if (prefs.cultural) return 'culture lovers';
                if (prefs.traditional) return 'tradition seekers';
                if (prefs.modern) return 'modern art fans';
                return 'Puja explorers';
            }

            getUnvisitedPandals() {
                return [
                    { name: 'Mudiali Club', type: 'traditional', photogenic: true, cultural: false, uniqueFeature: 'Handcrafted sculptures' },
                    { name: 'Suruchi Sangha', type: 'modern', photogenic: true, cultural: false, uniqueFeature: 'LED light installations' },
                    { name: 'Deshapriya Park', type: 'traditional', photogenic: false, cultural: true, uniqueFeature: 'Classical music performances' }
                ];
            }

            startPersonalizationTracking() {
                this.behaviorTracker.startTracking();
                
                // Update suggestions based on behavior every hour
                setInterval(() => {
                    this.behaviorTracker.analyzeBehavior();
                    this.updateUserProfile();
                }, 3600000);
            }

            loadUserProfile() {
                const saved = localStorage.getItem('userProfile');
                return saved ? JSON.parse(saved) : {
                    userId: this.generateUserId(),
                    joinDate: new Date().toISOString(),
                    totalVisits: 0,
                    favoriteTypes: [],
                    timeSpentByType: {},
                    lastActive: new Date().toISOString()
                };
            }

            loadVisitHistory() {
                const saved = localStorage.getItem('visitHistory');
                return saved ? JSON.parse(saved) : {
                    pandals: [],
                    traditional: 0,
                    modern: 0,
                    cultural: 0,
                    totalTime: 0,
                    averageRating: 0
                };
            }

            loadPreferences() {
                const saved = localStorage.getItem('userPreferences');
                return saved ? JSON.parse(saved) : {
                    traditional: true,
                    modern: false,
                    photography: false,
                    cultural: false,
                    food: false,
                    crowds: false
                };
            }

            savePreferences() {
                localStorage.setItem('userPreferences', JSON.stringify(this.preferences));
            }

            generateUserId() {
                return 'user_' + Math.random().toString(36).substr(2, 9);
            }
        }

        // User Behavior Tracker Class
        class UserBehaviorTracker {
            constructor() {
                this.behaviorData = [];
                this.sessionStart = Date.now();
            }

            startTracking() {
                // Track page interactions
                document.addEventListener('click', (e) => {
                    this.trackInteraction('click', e.target);
                });

                // Track time spent on different sections
                this.trackTimeSpent();
            }

            trackInteraction(type, element) {
                const interaction = {
                    type,
                    element: element.tagName,
                    className: element.className,
                    timestamp: Date.now(),
                    sessionTime: Date.now() - this.sessionStart
                };

                this.behaviorData.push(interaction);
            }

            trackTimeSpent() {
                // Implement time tracking logic
                setInterval(() => {
                    // Track which section user is viewing
                    this.logTimeSpent();
                }, 30000); // Every 30 seconds
            }

            logTimeSpent() {
                // Log time spent in different areas
                const timeData = {
                    timestamp: Date.now(),
                    activeElement: document.activeElement?.tagName || 'unknown',
                    scrollPosition: window.scrollY
                };

                this.behaviorData.push(timeData);
            }

            analyzeBehavior() {
                // Analyze behavior patterns to improve suggestions
                const patterns = this.extractPatterns();
                this.updateUserPreferencesBasedOnBehavior(patterns);
            }

            extractPatterns() {
                // Analyze user behavior data to extract patterns
                return {
                    mostClickedElements: this.getMostClickedElements(),
                    averageSessionTime: this.getAverageSessionTime(),
                    preferredInteractionTimes: this.getPreferredTimes()
                };
            }

            getMostClickedElements() {
                const clicks = this.behaviorData.filter(b => b.type === 'click');
                const elementCounts = {};
                
                clicks.forEach(click => {
                    elementCounts[click.element] = (elementCounts[click.element] || 0) + 1;
                });

                return Object.entries(elementCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
            }

            getAverageSessionTime() {
                return this.behaviorData.length > 0 ? 
                    (Date.now() - this.sessionStart) / this.behaviorData.length : 0;
            }

            getPreferredTimes() {
                return this.behaviorData.map(b => new Date(b.timestamp).getHours());
            }

            updateUserPreferencesBasedOnBehavior(patterns) {
                // Update user preferences based on behavior analysis
                // This would integrate with the PersonalizedSuggestionsEngine
            }
        }

        // Initialize suggestions engine
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const selectedArea = window.selectedLocation || 'kolkata';
                window.suggestionsEngine = new PersonalizedSuggestionsEngine(selectedArea);
            }, 4000);
        });

        // =====================================
        // WEATHER & TIME-BASED RECOMMENDATIONS ENGINE
        // =====================================

        class WeatherTimeEngine {
            constructor(selectedArea = 'kolkata') {
                this.selectedArea = selectedArea;
                this.areaConfig = AreaDataManager.getAreaConfig(selectedArea);
                this.weatherData = null;
                this.timeData = this.initializeTimeData();
                this.initializeEngine();
            }

            // Method to update area when user changes location
            updateArea(newArea) {
                this.selectedArea = newArea;
                this.areaConfig = AreaDataManager.getAreaConfig(newArea);
                this.loadWeatherData();
                this.generateWeatherRecommendations();
                this.updateAreaSpecificHeader();
            }

            updateAreaSpecificHeader() {
                const headerTitle = document.querySelector('#weather-time-widget h3');
                if (headerTitle) {
                    const areaNames = {
                        kolkata: 'Kolkata',
                        kalyani: 'Kalyani', 
                        chuchura: 'Chuchura',
                        bandel: 'Bandel'
                    };
                    headerTitle.innerHTML = `🌤️ ${areaNames[this.selectedArea]} Weather`;
                }
            }

            initializeEngine() {
                this.createWeatherTimeInterface();
                this.loadWeatherData();
                this.startTimeTracking();
                this.createFestivalCountdown();
            }

            createWeatherTimeInterface() {
                const weatherTimeContainer = document.createElement('div');
                weatherTimeContainer.innerHTML = `
                    <div id="weather-time-widget" style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        width: 280px;
                        max-height: calc(100vh - 40px);
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.1);
                        z-index: 10014;
                        overflow: hidden;
                        display: none;
                        flex-direction: column;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
                            color: white;
                            padding: 15px;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            flex-shrink: 0;
                        ">
                            <h3 style="margin: 0; font-size: 14px;">🌤️ Weather & Time</h3>
                            <button onclick="toggleWeatherWidget()" style="
                                background: none; border: none; color: white; font-size: 18px; cursor: pointer;
                                padding: 5px; border-radius: 3px; transition: background 0.2s ease;
                            " title="Close Weather Widget" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">✕</button>
                        </div>

                        <div id="weather-time-content" style="
                            padding: 15px;
                            overflow-y: auto;
                            overflow-x: hidden;
                            flex: 1;
                            max-height: calc(100vh - 120px);
                            scrollbar-width: thin;
                            scrollbar-color: #00c9ff transparent;
                        ">
                            <!-- Custom Scrollbar Styles -->
                            <style>
                                #weather-time-content::-webkit-scrollbar {
                                    width: 6px;
                                }
                                #weather-time-content::-webkit-scrollbar-track {
                                    background: rgba(0, 201, 255, 0.1);
                                    border-radius: 3px;
                                }
                                #weather-time-content::-webkit-scrollbar-thumb {
                                    background: linear-gradient(135deg, #00c9ff, #92fe9d);
                                    border-radius: 3px;
                                    transition: background 0.3s ease;
                                }
                                #weather-time-content::-webkit-scrollbar-thumb:hover {
                                    background: linear-gradient(135deg, #0099cc, #7de689);
                                }
                            </style>
                            <!-- Current Weather -->
                            <div id="current-weather" style="
                                background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e8 100%);
                                padding: 12px;
                                border-radius: 8px;
                                margin-bottom: 12px;
                                border-left: 4px solid #2196f3;
                            ">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <div style="font-weight: bold; font-size: 13px;">Current Weather</div>
                                    <div id="weather-icon" style="font-size: 20px;">🌤️</div>
                                </div>
                                <div id="weather-details" style="font-size: 11px; color: #555;"></div>
                            </div>

                            <!-- Festival Countdown -->
                            <div id="festival-countdown" style="
                                background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%);
                                padding: 12px;
                                border-radius: 8px;
                                margin-bottom: 12px;
                                border-left: 4px solid #e91e63;
                                text-align: center;
                            ">
                                <div style="font-weight: bold; font-size: 13px; margin-bottom: 6px;">🎊 Festival Countdown</div>
                                <div id="countdown-timer" style="font-size: 16px; font-weight: bold; color: #c2185b;"></div>
                            </div>

                            <!-- Best Visit Times -->
                            <div style="margin-bottom: 12px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #333;">⏰ Best Times Today</h4>
                                <div id="best-times" style="font-size: 11px;"></div>
                            </div>

                            <!-- Weather Recommendations -->
                            <div style="margin-bottom: 12px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #333;">🌈 Weather Tips</h4>
                                <div id="weather-recommendations" style="font-size: 11px;"></div>
                            </div>

                            <!-- Aarti Timings -->
                            <div style="margin-bottom: 12px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #333;">🙏 Today's Aarti</h4>
                                <div id="aarti-timings" style="font-size: 11px;"></div>
                            </div>

                            <!-- Sunrise/Sunset -->
                            <div>
                                <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #333;">📸 Photography Times</h4>
                                <div id="sun-times" style="font-size: 11px;"></div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(weatherTimeContainer);
                
                // Add scroll enhancement functionality
                this.enhanceScrollBehavior();
            }

            enhanceScrollBehavior() {
                const widget = document.getElementById('weather-time-widget');
                const content = document.getElementById('weather-time-content');
                
                if (!widget || !content) return;

                // Check if content is scrollable and add visual indicator
                const checkScrollable = () => {
                    if (content.scrollHeight > content.clientHeight) {
                        widget.classList.add('scrollable');
                    } else {
                        widget.classList.remove('scrollable');
                    }
                };

                // Initial check
                setTimeout(checkScrollable, 100);

                // Add scroll event listener for smooth scrolling effects
                content.addEventListener('scroll', () => {
                    const scrollPercentage = (content.scrollTop / (content.scrollHeight - content.clientHeight)) * 100;
                    
                    // Update scroll indicator opacity based on scroll position
                    const fadeElement = widget.querySelector('::after');
                    if (scrollPercentage > 80) {
                        widget.style.setProperty('--fade-opacity', '0');
                    } else {
                        widget.style.setProperty('--fade-opacity', '1');
                    }
                });

                // Add keyboard navigation support
                content.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            content.scrollBy(0, -50);
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            content.scrollBy(0, 50);
                            break;
                        case 'PageUp':
                            e.preventDefault();
                            content.scrollBy(0, -content.clientHeight * 0.8);
                            break;
                        case 'PageDown':
                            e.preventDefault();
                            content.scrollBy(0, content.clientHeight * 0.8);
                            break;
                        case 'Home':
                            e.preventDefault();
                            content.scrollTo(0, 0);
                            break;
                        case 'End':
                            e.preventDefault();
                            content.scrollTo(0, content.scrollHeight);
                            break;
                    }
                });

                // Make content focusable for keyboard navigation
                content.setAttribute('tabindex', '0');

                // Re-check scrollable state when content changes
                const observer = new MutationObserver(checkScrollable);
                observer.observe(content, { childList: true, subtree: true });

                // Handle window resize
                window.addEventListener('resize', () => {
                    setTimeout(checkScrollable, 100);
                });

                // Add scroll position memory
                this.addScrollMemory();
            }

            addScrollMemory() {
                const content = document.getElementById('weather-time-content');
                if (!content) return;

                // Restore scroll position
                const savedScrollPosition = localStorage.getItem('weatherWidgetScrollPosition');
                if (savedScrollPosition) {
                    content.scrollTop = parseInt(savedScrollPosition);
                }

                // Save scroll position on scroll
                let scrollTimeout;
                content.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        localStorage.setItem('weatherWidgetScrollPosition', content.scrollTop);
                    }, 500);
                });

                // Add scroll-to-top button when scrolled down
                this.addScrollToTopButton();
            }

            addScrollToTopButton() {
                const widget = document.getElementById('weather-time-widget');
                const content = document.getElementById('weather-time-content');
                if (!widget || !content) return;

                // Create scroll-to-top button
                const scrollTopBtn = document.createElement('button');
                scrollTopBtn.innerHTML = '↑';
                scrollTopBtn.id = 'scroll-to-top-btn';
                scrollTopBtn.style.cssText = `
                    position: absolute;
                    bottom: 10px;
                    right: 10px;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #00c9ff, #92fe9d);
                    color: white;
                    border: none;
                    font-size: 14px;
                    cursor: pointer;
                    opacity: 0;
                    transition: all 0.3s ease;
                    z-index: 10;
                    box-shadow: 0 2px 10px rgba(0, 201, 255, 0.3);
                `;

                // Add hover effects
                scrollTopBtn.addEventListener('mouseenter', () => {
                    scrollTopBtn.style.transform = 'scale(1.1)';
                    scrollTopBtn.style.boxShadow = '0 4px 15px rgba(0, 201, 255, 0.5)';
                });

                scrollTopBtn.addEventListener('mouseleave', () => {
                    scrollTopBtn.style.transform = 'scale(1)';
                    scrollTopBtn.style.boxShadow = '0 2px 10px rgba(0, 201, 255, 0.3)';
                });

                // Add click functionality
                scrollTopBtn.addEventListener('click', () => {
                    content.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });

                widget.appendChild(scrollTopBtn);

                // Show/hide button based on scroll position
                content.addEventListener('scroll', () => {
                    if (content.scrollTop > 100) {
                        scrollTopBtn.style.opacity = '1';
                        scrollTopBtn.style.transform = 'scale(1)';
                    } else {
                        scrollTopBtn.style.opacity = '0';
                        scrollTopBtn.style.transform = 'scale(0.8)';
                    }
                });
            }

            minimizeWidget() {
                const content = document.getElementById('weather-time-content');
                const button = content.previousElementSibling.querySelector('button');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    button.innerHTML = '−';
                } else {
                    content.style.display = 'none';
                    button.innerHTML = '+';
                }
            }

            async loadWeatherData() {
                // Simulated weather API call with area-specific patterns
                const weatherConditions = ['Sunny', 'Cloudy', 'Partly Cloudy', 'Light Rain', 'Clear'];
                const icons = ['☀️', '☁️', '⛅', '🌦️', '🌙'];
                
                const randomIndex = Math.floor(Math.random() * weatherConditions.length);
                const patterns = this.areaConfig.weatherPatterns;
                
                // Generate base weather data
                let baseWeatherData = {
                    condition: weatherConditions[randomIndex],
                    icon: icons[randomIndex],
                    temperature: Math.floor(Math.random() * (patterns.averageTemp.max - patterns.averageTemp.min)) + patterns.averageTemp.min,
                    humidity: Math.floor(Math.random() * (patterns.humidity.max - patterns.humidity.min)) + patterns.humidity.min,
                    windSpeed: Math.floor(Math.random() * (patterns.windSpeed.max - patterns.windSpeed.min)) + patterns.windSpeed.min,
                    uvIndex: Math.floor(Math.random() * 8) + 1, // 1-8
                    isRaining: Math.random() < patterns.rainProbability,
                    visibility: Math.floor(Math.random() * 5) + 5, // 5-10 km
                    pressure: Math.floor(Math.random() * 20) + 1010 // 1010-1030 hPa
                };

                // Apply area-specific adjustments
                this.weatherData = AreaDataManager.getAreaWeatherAdjustments(this.selectedArea, baseWeatherData);
                
                // Update rain condition based on area probability
                if (this.weatherData.isRaining) {
                    this.weatherData.condition = 'Light Rain';
                    this.weatherData.icon = '🌦️';
                }

                this.updateWeatherDisplay();
                this.generateWeatherRecommendations();
            }

            updateWeatherDisplay() {
                const weatherDetails = document.getElementById('weather-details');
                const weatherIcon = document.getElementById('weather-icon');
                
                if (weatherDetails && weatherIcon && this.weatherData) {
                    weatherIcon.innerHTML = this.weatherData.icon;
                    weatherDetails.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>🌡️ ${this.weatherData.temperature}°C</div>
                            <div>💧 ${this.weatherData.humidity}% humidity</div>
                            <div>💨 ${this.weatherData.windSpeed} km/h</div>
                            <div>👁️ ${this.weatherData.visibility} km visibility</div>
                        </div>
                        <div style="margin-top: 6px; text-align: center; font-weight: bold; color: #2196f3;">
                            ${this.weatherData.condition}
                        </div>
                    `;
                }
            }

            generateWeatherRecommendations() {
                const recommendationsDiv = document.getElementById('weather-recommendations');
                if (!recommendationsDiv || !this.weatherData) return;

                let recommendations = [];
                const culturalInfo = this.areaConfig.culturalInfo;
                const famousPandals = this.areaConfig.famousPandals;
                
                if (this.weatherData.isRaining) {
                    if (this.selectedArea === 'kolkata') {
                        recommendations = [
                            '☔ Visit covered pandals: Sreebhumi, Salt Lake FD Block',
                            '🌂 Metro stations provide good shelter',
                            '🚗 Consider taxi/cab for pandal hopping',
                            '📱 Shopping malls near major pandals for breaks'
                        ];
                    } else if (this.selectedArea === 'kalyani') {
                        recommendations = [
                            '☔ Township blocks have covered areas',
                            '🌂 Community centers provide shelter',
                            '🚗 Local autos available during rain',
                            '📱 Plan indoor cultural programs'
                        ];
                    } else if (this.selectedArea === 'chuchura') {
                        recommendations = [
                            '☔ Historic buildings offer traditional shelter',
                            '🌂 River ghat areas may be slippery',
                            '🚗 Heritage walks best postponed',
                            '📱 Indoor cultural events preferred'
                        ];
                    } else if (this.selectedArea === 'bandel') {
                        recommendations = [
                            '☔ Church and heritage buildings provide cover',
                            '🌂 Heritage sites have indoor areas',
                            '🚗 Local transport during rain available',
                            '📱 Visit indoor cultural exhibitions'
                        ];
                    }
                } else if (this.weatherData.temperature > 32) {
                    const bestTimes = this.areaConfig.weatherPatterns.bestVisitTimes;
                    recommendations = [
                        `🌡️ Hot day - visit during ${bestTimes[0] || 'early morning'}`,
                        '💧 Stay hydrated - carry water bottle',
                        '🧴 Use sunscreen and wear hat',
                        `❄️ Prefer covered areas like ${famousPandals[0]} during afternoon`
                    ];
                } else if (this.weatherData.condition === 'Clear' || this.weatherData.condition === 'Sunny') {
                    if (this.selectedArea === 'kolkata') {
                        recommendations = [
                            '☀️ Perfect weather for outdoor pandals!',
                            '📸 Great day for photography at Bagbazar',
                            '🚶‍♂️ Ideal for walking tours in North Kolkata',
                            '🌅 Don\'t miss sunset at riverside pandals'
                        ];
                    } else if (this.selectedArea === 'kalyani') {
                        recommendations = [
                            '☀️ Perfect for township pandal exploration!',
                            '📸 Garden settings ideal for photography',
                            '🚶‍♂️ Cycle-friendly roads for easy travel',
                            '🌅 Community parks beautiful in evening'
                        ];
                    } else if (this.selectedArea === 'chuchura') {
                        recommendations = [
                            '☀️ Perfect for heritage walks!',
                            '📸 Historic architecture photography ideal',
                            '🚶‍♂️ River ghat walks highly recommended',
                            '🌅 Riverside sunset views spectacular'
                        ];
                    } else if (this.selectedArea === 'bandel') {
                        recommendations = [
                            '☀️ Perfect for heritage exploration!',
                            '📸 Portuguese architecture photography',
                            '🚶‍♂️ Heritage site walking tours ideal',
                            '🌅 Church-temple harmony beautiful in sunlight'
                        ];
                    }
                } else {
                    recommendations = [
                        `⛅ Good weather for exploring ${this.selectedArea}`,
                        '🌤️ Comfortable temperature for long visits',
                        `📷 Soft lighting perfect for ${culturalInfo.photography[0] || 'photos'}`,
                        `👕 ${culturalInfo.transportTips[0] || 'Light clothing recommended'}`
                    ];
                }

                // Add area-specific cultural tip
                recommendations.push(`🎪 Special: ${culturalInfo.specialEvents[0] || 'Local cultural events'}`);

                recommendationsDiv.innerHTML = recommendations.map(rec => 
                    `<div style="background: rgba(33, 150, 243, 0.1); padding: 6px 8px; margin-bottom: 4px; border-radius: 4px;">${rec}</div>`
                ).join('');
            }

            createFestivalCountdown() {
                // Festival dates (adjustable based on actual dates)
                const festivalStart = new Date('2025-09-28'); // Mahalaya
                const festivalEnd = new Date('2025-10-03'); // Bijoya Dashami
                
                this.updateCountdown(festivalStart, festivalEnd);
                
                // Update every second
                setInterval(() => {
                    this.updateCountdown(festivalStart, festivalEnd);
                }, 1000);
            }

            updateCountdown(startDate, endDate) {
                const now = new Date();
                const countdownDiv = document.getElementById('countdown-timer');
                
                if (!countdownDiv) return;

                let targetDate, message;
                
                if (now < startDate) {
                    targetDate = startDate;
                    message = 'Until Festival Begins';
                } else if (now >= startDate && now <= endDate) {
                    targetDate = endDate;
                    message = 'Festival Ends In';
                } else {
                    countdownDiv.innerHTML = `
                        <div style="color: #4caf50;">🎉 See you next year!</div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">Thank you for celebrating with us</div>
                    `;
                    return;
                }

                const timeDiff = targetDate - now;
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

                countdownDiv.innerHTML = `
                    <div>${days}d ${hours}h ${minutes}m ${seconds}s</div>
                    <div style="font-size: 10px; color: #666; margin-top: 4px;">${message}</div>
                `;
            }

            startTimeTracking() {
                this.updateBestTimes();
                this.updateAartiTimings();
                this.updateSunTimes();
                
                // Update every hour
                setInterval(() => {
                    this.updateBestTimes();
                    this.updateAartiTimings();
                }, 3600000);

                // Update sun times daily
                setInterval(() => {
                    this.updateSunTimes();
                }, 86400000);
            }

            updateBestTimes() {
                const bestTimesDiv = document.getElementById('best-times');
                if (!bestTimesDiv) return;

                const now = new Date();
                const currentHour = now.getHours();
                const crowdLevels = this.getCrowdPredictions();

                let recommendations = [];

                // Generate time-based recommendations
                if (currentHour >= 5 && currentHour <= 8) {
                    recommendations.push({
                        time: 'Now (Early Morning)',
                        status: 'Excellent',
                        reason: 'Shortest queues, best parking',
                        icon: '🌅',
                        color: '#4caf50'
                    });
                } else if (currentHour >= 22 || currentHour <= 2) {
                    recommendations.push({
                        time: 'Now (Late Night)',
                        status: 'Great',
                        reason: 'Beautiful lighting, fewer crowds',
                        icon: '🌙',
                        color: '#2196f3'
                    });
                }

                // Add upcoming good times
                const upcomingTimes = [
                    { hour: 6, label: 'Early Morning', status: 'Perfect', reason: 'Best for photography' },
                    { hour: 11, label: 'Late Morning', status: 'Good', reason: 'Cultural programs start' },
                    { hour: 19, label: 'Evening', status: 'Busy', reason: 'Peak decorative lighting' },
                    { hour: 22, label: 'Night', status: 'Great', reason: 'Fewer crowds return' }
                ];

                upcomingTimes.forEach(time => {
                    if (time.hour > currentHour) {
                        recommendations.push({
                            time: `${time.hour}:00 (${time.label})`,
                            status: time.status,
                            reason: time.reason,
                            icon: time.hour < 12 ? '🌅' : time.hour < 18 ? '☀️' : '🌙',
                            color: time.status === 'Perfect' ? '#4caf50' : time.status === 'Great' ? '#2196f3' : '#ff9800'
                        });
                    }
                });

                bestTimesDiv.innerHTML = recommendations.slice(0, 3).map(rec => `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; padding: 6px 8px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span>${rec.icon}</span>
                            <div>
                                <div style="font-weight: bold; font-size: 11px;">${rec.time}</div>
                                <div style="font-size: 10px; color: #666;">${rec.reason}</div>
                            </div>
                        </div>
                        <div style="background: ${rec.color}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 9px;">
                            ${rec.status}
                        </div>
                    </div>
                `).join('');
            }

            updateAartiTimings() {
                const aartiDiv = document.getElementById('aarti-timings');
                if (!aartiDiv) return;

                const aartiSchedule = [
                    { time: '6:00 AM', type: 'Morning Aarti', pandals: 'Most Traditional Pandals' },
                    { time: '12:00 PM', type: 'Midday Aarti', pandals: 'Major Pandals' },
                    { time: '6:00 PM', type: 'Evening Aarti', pandals: 'All Pandals' },
                    { time: '9:00 PM', type: 'Night Aarti', pandals: 'Selected Pandals' }
                ];

                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                let nextAarti = null;
                for (const aarti of aartiSchedule) {
                    const aartiTime = this.parseTime(aarti.time);
                    if (aartiTime > currentTime) {
                        nextAarti = aarti;
                        break;
                    }
                }

                if (!nextAarti) nextAarti = aartiSchedule[0]; // Next day's first aarti

                aartiDiv.innerHTML = `
                    <div style="background: rgba(233, 30, 99, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 6px;">
                        <div style="font-weight: bold; color: #c2185b;">🕐 Next: ${nextAarti.time}</div>
                        <div style="font-size: 10px; color: #666;">${nextAarti.type} at ${nextAarti.pandals}</div>
                    </div>
                    
                    <div style="font-size: 10px;">
                        ${aartiSchedule.map(aarti => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px; padding: 3px;">
                                <span>${aarti.time}</span>
                                <span style="color: #666;">${aarti.type}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            updateSunTimes() {
                const sunTimesDiv = document.getElementById('sun-times');
                if (!sunTimesDiv) return;

                // Simulated sunrise/sunset times for Kolkata
                const today = new Date();
                const sunrise = new Date(today);
                sunrise.setHours(5, 45, 0); // Approximate sunrise time
                
                const sunset = new Date(today);
                sunset.setHours(17, 30, 0); // Approximate sunset time

                const goldenHourMorning = new Date(sunrise.getTime() + 30 * 60000); // 30 min after sunrise
                const goldenHourEvening = new Date(sunset.getTime() - 30 * 60000); // 30 min before sunset

                sunTimesDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div style="background: rgba(255, 152, 0, 0.1); padding: 6px; border-radius: 4px; text-align: center;">
                            <div style="font-weight: bold; font-size: 10px;">🌅 Sunrise</div>
                            <div style="font-size: 11px; color: #f57c00;">${sunrise.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                        <div style="background: rgba(255, 87, 34, 0.1); padding: 6px; border-radius: 4px; text-align: center;">
                            <div style="font-weight: bold; font-size: 10px;">🌅 Sunset</div>
                            <div style="font-size: 11px; color: #d84315;">${sunset.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 4px;">
                        <div style="font-weight: bold; font-size: 11px; margin-bottom: 4px;">📸 Golden Hour Photography</div>
                        <div style="font-size: 10px;">
                            <div>Morning: ${goldenHourMorning.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})} - ${new Date(goldenHourMorning.getTime() + 60 * 60000).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div>Evening: ${goldenHourEvening.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})} - ${sunset.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                `;
            }

            getCrowdPredictions() {
                // Simulated crowd prediction based on time
                const hour = new Date().getHours();
                
                if (hour >= 5 && hour <= 8) return 'low';
                if (hour >= 9 && hour <= 17) return 'medium';
                if (hour >= 18 && hour <= 21) return 'high';
                if (hour >= 22 || hour <= 4) return 'low';
                
                return 'medium';
            }

            parseTime(timeStr) {
                const [time, period] = timeStr.split(' ');
                const [hours, minutes] = time.split(':').map(Number);
                let hour24 = hours;
                
                if (period === 'PM' && hours !== 12) hour24 += 12;
                if (period === 'AM' && hours === 12) hour24 = 0;
                
                return hour24 * 60 + minutes;
            }

            initializeTimeData() {
                return {
                    festivalDates: {
                        mahalaya: new Date('2025-09-28'),
                        shashthi: new Date('2025-09-29'),
                        saptami: new Date('2025-09-30'),
                        ashtami: new Date('2025-10-01'),
                        navami: new Date('2025-10-02'),
                        dashami: new Date('2025-10-03')
                    },
                    specialEvents: [
                        { date: '2025-09-29', event: 'Shashthi - Festival Begins', time: '6:00 AM' },
                        { date: '2025-10-01', event: 'Ashtami - Main Celebration', time: 'All Day' },
                        { date: '2025-10-02', event: 'Navami - Cultural Programs', time: '7:00 PM' },
                        { date: '2025-10-03', event: 'Dashami - Visarjan', time: '2:00 PM' }
                    ]
                };
            }

            // Public methods for integration with other systems
            getCurrentWeather() {
                return this.weatherData;
            }

            getWeatherRecommendations() {
                if (!this.weatherData) return [];
                
                if (this.weatherData.isRaining) {
                    return ['indoor', 'covered'];
                } else if (this.weatherData.temperature > 32) {
                    return ['ac', 'shaded'];
                } else {
                    return ['outdoor', 'any'];
                }
            }

            getBestVisitTime() {
                const hour = new Date().getHours();
                
                if (hour >= 5 && hour <= 8) return 'excellent';
                if (hour >= 22 || hour <= 2) return 'good';
                if (hour >= 18 && hour <= 21) return 'crowded';
                
                return 'moderate';
            }

            isGoldenHour() {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                // Morning golden hour: 6:15-7:15 AM
                if (hour === 6 && minute >= 15) return true;
                if (hour === 7 && minute <= 15) return true;
                
                // Evening golden hour: 5:00-6:00 PM
                if (hour === 17) return true;
                
                return false;
            }
        }

        // Initialize weather and time engine
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const selectedArea = window.selectedLocation || 'kolkata';
                window.weatherTimeEngine = new WeatherTimeEngine(selectedArea);
            }, 5000);
        });

        // =====================================
        // PERSONAL ANALYTICS DASHBOARD
        // =====================================

        class PersonalAnalyticsDashboard {
            constructor() {
                this.analytics = this.loadAnalyticsData();
                this.photoMemories = this.loadPhotoMemories();
                this.visitStats = this.loadVisitStats();
                this.initializeDashboard();
            }

            initializeDashboard() {
                this.createDashboardInterface();
                this.startTracking();
                this.updateStats();
            }

            createDashboardInterface() {
                const dashboardContainer = document.createElement('div');
                dashboardContainer.innerHTML = `
                    <div id="analytics-dashboard" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 90vw;
                        max-width: 600px;
                        height: 80vh;
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 12px 48px rgba(0,0,0,0.4);
                        z-index: 10020;
                        display: none;
                        flex-direction: column;
                        overflow: hidden;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        ">
                            <h2 style="margin: 0; font-size: 18px;">📊 Your Puja Journey</h2>
                            <button onclick="window.analyticsDashboard.closeDashboard()" style="
                                background: none; border: none; color: white; font-size: 24px; cursor: pointer;
                            ">×</button>
                        </div>

                        <div style="flex: 1; overflow-y: auto; padding: 20px;">
                            <!-- Stats Overview -->
                            <div id="stats-overview" style="
                                display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px;
                            "></div>

                            <!-- Charts Section -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">📈 Your Activity</h3>
                                <div id="activity-charts" style="
                                    background: #f8f9fa; border-radius: 12px; padding: 20px;
                                "></div>
                            </div>

                            <!-- Photo Timeline -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">📸 Photo Memories</h3>
                                <div id="photo-timeline" style="
                                    max-height: 300px; overflow-y: auto; border: 1px solid #eee; 
                                    border-radius: 8px; padding: 15px; background: #fff;
                                "></div>
                            </div>

                            <!-- Achievements -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">🏆 Achievements</h3>
                                <div id="achievements" style="
                                    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
                                "></div>
                            </div>

                            <!-- Recommendations -->
                            <div>
                                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">💡 Insights & Tips</h3>
                                <div id="personal-insights" style="
                                    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
                                    border-radius: 8px; padding: 15px;
                                "></div>
                            </div>
                        </div>

                        <div style="padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                            <button onclick="window.analyticsDashboard.exportData()" style="
                                flex: 1; padding: 10px; background: #4caf50; color: white; 
                                border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
                            ">
                                📤 Export Data
                            </button>
                            <button onclick="window.analyticsDashboard.shareStats()" style="
                                flex: 1; padding: 10px; background: #2196f3; color: white; 
                                border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
                            ">
                                📱 Share
                            </button>
                            <button onclick="window.analyticsDashboard.resetData()" style="
                                padding: 10px 15px; background: #f44336; color: white; 
                                border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
                            ">
                                🗑️ Reset
                            </button>
                        </div>
                    </div>

                    <button onclick="window.analyticsDashboard.openDashboard()" style="
                        position: fixed;
                        bottom: 20px;
                        right: 80px;
                        width: 50px;
                        height: 50px;
                        border-radius: 25px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        cursor: pointer;
                        z-index: 10021;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        font-size: 18px;
                    " id="analytics-toggle">
                        📊
                    </button>
                `;

                document.body.appendChild(dashboardContainer);
            }

            openDashboard() {
                document.getElementById('analytics-dashboard').style.display = 'flex';
                this.updateStats();
                this.renderCharts();
                this.updatePhotoTimeline();
                this.updateAchievements();
                this.updateInsights();
            }

            closeDashboard() {
                document.getElementById('analytics-dashboard').style.display = 'none';
            }

            updateStats() {
                const stats = this.calculateStats();
                const statsDiv = document.getElementById('stats-overview');
                
                statsDiv.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                        color: white; padding: 15px; border-radius: 12px; text-align: center;
                    ">
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${stats.pandalVisits}</div>
                        <div style="font-size: 12px;">Pandals Visited</div>
                    </div>
                    
                    <div style="
                        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
                        color: white; padding: 15px; border-radius: 12px; text-align: center;
                    ">
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${stats.totalDistance}km</div>
                        <div style="font-size: 12px;">Distance Traveled</div>
                    </div>
                    
                    <div style="
                        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                        color: white; padding: 15px; border-radius: 12px; text-align: center;
                    ">
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${stats.totalTime}h</div>
                        <div style="font-size: 12px;">Time Spent</div>
                    </div>
                `;
            }

            renderCharts() {
                const chartsDiv = document.getElementById('activity-charts');
                const stats = this.calculateStats();
                
                chartsDiv.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px;">Daily Activity</h4>
                        <div id="daily-chart" style="height: 120px; background: white; border-radius: 8px; padding: 15px;">
                            ${this.createDailyChart()}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px;">Pandal Types Preference</h4>
                        <div id="preference-chart" style="height: 100px; background: white; border-radius: 8px; padding: 15px;">
                            ${this.createPreferenceChart()}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin: 0 0 10px 0; font-size: 14px;">Visit Times Distribution</h4>
                        <div id="time-chart" style="height: 80px; background: white; border-radius: 8px; padding: 15px;">
                            ${this.createTimeChart()}
                        </div>
                    </div>
                `;
            }

            createDailyChart() {
                const dailyData = this.analytics.dailyVisits || [];
                const maxVisits = Math.max(...dailyData, 1);
                
                return `
                    <div style="display: flex; align-items: end; justify-content: space-between; height: 80px; gap: 4px;">
                        ${dailyData.map((visits, index) => {
                            const height = (visits / maxVisits) * 70;
                            const date = new Date();
                            date.setDate(date.getDate() - (6 - index));
                            return `
                                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                                    <div style="
                                        background: #2196f3; 
                                        width: 100%; 
                                        height: ${height}px; 
                                        border-radius: 4px 4px 0 0;
                                        min-height: 2px;
                                    "></div>
                                    <div style="font-size: 10px; margin-top: 4px; color: #666;">
                                        ${date.getDate()}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            createPreferenceChart() {
                const preferences = this.analytics.preferences || { traditional: 60, modern: 40 };
                
                return `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                <span>Traditional</span>
                                <span>${preferences.traditional}%</span>
                            </div>
                            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #4caf50; height: 100%; width: ${preferences.traditional}%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                <span>Modern</span>
                                <span>${preferences.modern}%</span>
                            </div>
                            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #ff9800; height: 100%; width: ${preferences.modern}%; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            createTimeChart() {
                const timeData = this.analytics.visitTimes || { morning: 30, afternoon: 20, evening: 35, night: 15 };
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; font-size: 11px;">
                        <div style="flex: ${timeData.morning}; background: #ffeb3b; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            🌅 ${timeData.morning}%
                        </div>
                        <div style="flex: ${timeData.afternoon}; background: #ff9800; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            ☀️ ${timeData.afternoon}%
                        </div>
                        <div style="flex: ${timeData.evening}; background: #f44336; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            🌆 ${timeData.evening}%
                        </div>
                        <div style="flex: ${timeData.night}; background: #3f51b5; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            🌙 ${timeData.night}%
                        </div>
                    </div>
                `;
            }

            updatePhotoTimeline() {
                const timelineDiv = document.getElementById('photo-timeline');
                const photos = this.photoMemories;
                
                if (photos.length === 0) {
                    timelineDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">📸</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">No photos yet!</div>
                            <div style="font-size: 13px;">Start visiting pandals to create your photo timeline</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                photos.forEach((photo, index) => {
                    html += `
                        <div style="
                            display: flex; gap: 15px; margin-bottom: 15px; padding: 15px; 
                            background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; 
                            border-radius: 8px; border-left: 3px solid #2196f3;
                        ">
                            <div style="
                                width: 60px; height: 60px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
                                border-radius: 8px; display: flex; align-items: center; justify-content: center; 
                                font-size: 24px;
                            ">
                                📸
                            </div>
                            
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">
                                    ${photo.pandal}
                                </div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                                    📅 ${photo.date} • 🕐 ${photo.time}
                                </div>
                                <div style="font-size: 11px; color: #555;">
                                    ${photo.description}
                                </div>
                                <div style="margin-top: 6px; display: flex; gap: 5px;">
                                    ${photo.tags.map(tag => 
                                        `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 10px; font-size: 9px;">#${tag}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                timelineDiv.innerHTML = html;
            }

            updateAchievements() {
                const achievementsDiv = document.getElementById('achievements');
                const achievements = this.calculateAchievements();
                
                achievementsDiv.innerHTML = achievements.map(achievement => `
                    <div style="
                        background: ${achievement.unlocked ? 'linear-gradient(135deg, #4caf50, #45a049)' : '#f5f5f5'};
                        color: ${achievement.unlocked ? 'white' : '#999'};
                        padding: 12px; border-radius: 8px; text-align: center;
                        border: ${achievement.unlocked ? 'none' : '2px dashed #ddd'};
                    ">
                        <div style="font-size: 24px; margin-bottom: 6px;">${achievement.icon}</div>
                        <div style="font-size: 12px; font-weight: bold; margin-bottom: 3px;">${achievement.title}</div>
                        <div style="font-size: 10px;">${achievement.description}</div>
                        ${!achievement.unlocked ? `
                            <div style="margin-top: 6px; font-size: 9px; color: #666;">
                                Progress: ${achievement.progress}%
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            updateInsights() {
                const insightsDiv = document.getElementById('personal-insights');
                const insights = this.generateInsights();
                
                insightsDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #4a148c; font-size: 14px;">🎯 Your Puja Style</h4>
                        <div style="font-size: 13px; line-height: 1.5;">${insights.style}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #4a148c; font-size: 14px;">📊 Fun Stats</h4>
                        <div style="font-size: 12px; line-height: 1.6;">
                            ${insights.funStats.map(stat => `<div style="margin-bottom: 4px;">• ${stat}</div>`).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #4a148c; font-size: 14px;">💡 Recommendations</h4>
                        <div style="font-size: 12px; line-height: 1.6;">
                            ${insights.recommendations.map(rec => `<div style="margin-bottom: 4px;">• ${rec}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            calculateStats() {
                return {
                    pandalVisits: this.visitStats.totalVisits || 0,
                    totalDistance: this.visitStats.totalDistance || 0,
                    totalTime: this.visitStats.totalTime || 0,
                    favoriteTime: this.visitStats.favoriteTime || 'Evening',
                    favoriteType: this.visitStats.favoriteType || 'Traditional'
                };
            }

            calculateAchievements() {
                const stats = this.calculateStats();
                
                return [
                    {
                        title: 'First Visit',
                        description: 'Visited your first pandal',
                        icon: '🎯',
                        unlocked: stats.pandalVisits >= 1,
                        progress: Math.min(stats.pandalVisits * 100, 100)
                    },
                    {
                        title: 'Pandal Explorer',
                        description: 'Visited 5 different pandals',
                        icon: '🗺️',
                        unlocked: stats.pandalVisits >= 5,
                        progress: Math.min((stats.pandalVisits / 5) * 100, 100)
                    },
                    {
                        title: 'Marathon Walker',
                        description: 'Walked 10km during Puja',
                        icon: '🚶‍♂️',
                        unlocked: stats.totalDistance >= 10,
                        progress: Math.min((stats.totalDistance / 10) * 100, 100)
                    },
                    {
                        title: 'Photo Enthusiast',
                        description: 'Captured 20 memories',
                        icon: '📸',
                        unlocked: this.photoMemories.length >= 20,
                        progress: Math.min((this.photoMemories.length / 20) * 100, 100)
                    },
                    {
                        title: 'Night Owl',
                        description: 'Visited pandals after 10 PM',
                        icon: '🌙',
                        unlocked: this.visitStats.nightVisits >= 1,
                        progress: this.visitStats.nightVisits >= 1 ? 100 : 0
                    },
                    {
                        title: 'Early Bird',
                        description: 'Visited pandals before 8 AM',
                        icon: '🌅',
                        unlocked: this.visitStats.morningVisits >= 1,
                        progress: this.visitStats.morningVisits >= 1 ? 100 : 0
                    }
                ];
            }

            generateInsights() {
                const stats = this.calculateStats();
                
                let style = 'Casual Explorer';
                if (stats.pandalVisits >= 10) style = 'Dedicated Devotee';
                if (stats.totalDistance >= 15) style = 'Adventure Seeker';
                if (this.photoMemories.length >= 15) style = 'Memory Collector';
                
                const funStats = [
                    `You've spent ${stats.totalTime} hours immersed in festival spirit`,
                    `Your longest visit was ${this.visitStats.longestVisit || 45} minutes`,
                    `You prefer ${stats.favoriteTime.toLowerCase()} visits`,
                    `${((stats.pandalVisits / 7) * 100).toFixed(0)}% of your week was Puja-focused`
                ];
                
                const recommendations = [
                    'Try visiting during different times to experience varied atmospheres',
                    'Explore both traditional and modern pandals for diverse experiences',
                    'Document your journey with photos and notes',
                    'Connect with other devotees to share experiences'
                ];
                
                return { style, funStats, recommendations };
            }

            exportData() {
                const data = {
                    analytics: this.analytics,
                    photoMemories: this.photoMemories,
                    visitStats: this.visitStats,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `puja-analytics-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            shareStats() {
                const stats = this.calculateStats();
                const shareText = `🎊 My Durga Puja Journey 2025!\n\n📍 Visited ${stats.pandalVisits} pandals\n🚶‍♂️ Walked ${stats.totalDistance}km\n⏰ Spent ${stats.totalTime} hours\n\n#DurgaPuja2025 #PujaJourney`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'My Durga Puja Journey',
                        text: shareText
                    });
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('Stats copied to clipboard!');
                    });
                }
            }

            resetData() {
                if (confirm('Are you sure you want to reset all your analytics data? This cannot be undone.')) {
                    localStorage.removeItem('pujaAnalytics');
                    localStorage.removeItem('pujaPhotoMemories');
                    localStorage.removeItem('pujaVisitStats');
                    
                    this.analytics = {};
                    this.photoMemories = [];
                    this.visitStats = {};
                    
                    this.updateStats();
                    this.renderCharts();
                    this.updatePhotoTimeline();
                    this.updateAchievements();
                    this.updateInsights();
                    
                    alert('Analytics data has been reset!');
                }
            }

            startTracking() {
                // Track user interactions and update analytics
                this.trackPageVisits();
                this.trackTimeSpent();
                this.trackDistance();
            }

            trackPageVisits() {
                // Simulate pandal visits
                this.visitStats.totalVisits = (this.visitStats.totalVisits || 0) + Math.floor(Math.random() * 3);
                this.saveVisitStats();
            }

            trackTimeSpent() {
                // Track time spent on app
                const startTime = Date.now();
                
                setInterval(() => {
                    const timeSpent = (Date.now() - startTime) / (1000 * 60 * 60); // Convert to hours
                    this.visitStats.totalTime = (this.visitStats.totalTime || 0) + timeSpent;
                    this.saveVisitStats();
                }, 300000); // Every 5 minutes
            }

            trackDistance() {
                // Simulate distance tracking
                this.visitStats.totalDistance = (this.visitStats.totalDistance || 0) + Math.random() * 2;
                this.saveVisitStats();
            }

            loadAnalyticsData() {
                const saved = localStorage.getItem('pujaAnalytics');
                return saved ? JSON.parse(saved) : {
                    dailyVisits: [2, 3, 1, 4, 2, 3, 1],
                    preferences: { traditional: 60, modern: 40 },
                    visitTimes: { morning: 30, afternoon: 20, evening: 35, night: 15 }
                };
            }

            loadPhotoMemories() {
                const saved = localStorage.getItem('pujaPhotoMemories');
                return saved ? JSON.parse(saved) : [
                    {
                        pandal: 'Bagbazar Sarbojanin',
                        date: '2025-09-29',
                        time: '7:30 PM',
                        description: 'Beautiful evening lighting on the main mandap',
                        tags: ['evening', 'traditional', 'lighting']
                    },
                    {
                        pandal: 'Sreebhumi Sporting Club',
                        date: '2025-09-30',
                        time: '2:15 PM',
                        description: 'Incredible replica of Taj Mahal theme',
                        tags: ['modern', 'architecture', 'innovative']
                    }
                ];
            }

            loadVisitStats() {
                const saved = localStorage.getItem('pujaVisitStats');
                return saved ? JSON.parse(saved) : {
                    totalVisits: 5,
                    totalDistance: 12.5,
                    totalTime: 8.5,
                    favoriteTime: 'Evening',
                    favoriteType: 'Traditional',
                    longestVisit: 45,
                    nightVisits: 1,
                    morningVisits: 1
                };
            }

            saveVisitStats() {
                localStorage.setItem('pujaVisitStats', JSON.stringify(this.visitStats));
            }

            // Public methods for other components to track events
            trackPandalVisit(pandalName, duration, timeOfDay) {
                this.visitStats.totalVisits = (this.visitStats.totalVisits || 0) + 1;
                this.visitStats.totalTime = (this.visitStats.totalTime || 0) + (duration / 60); // Convert minutes to hours
                
                if (timeOfDay === 'night') this.visitStats.nightVisits = (this.visitStats.nightVisits || 0) + 1;
                if (timeOfDay === 'morning') this.visitStats.morningVisits = (this.visitStats.morningVisits || 0) + 1;
                
                this.saveVisitStats();
            }

            addPhotoMemory(pandal, description, tags = []) {
                const memory = {
                    pandal,
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
                    description,
                    tags
                };
                
                this.photoMemories.unshift(memory);
                if (this.photoMemories.length > 50) this.photoMemories.pop(); // Keep only last 50
                
                localStorage.setItem('pujaPhotoMemories', JSON.stringify(this.photoMemories));
            }

            trackDistance(distance) {
                this.visitStats.totalDistance = (this.visitStats.totalDistance || 0) + distance;
                this.saveVisitStats();
            }
        }

        // Initialize personal analytics dashboard
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                window.analyticsDashboard = new PersonalAnalyticsDashboard();
            }, 8000);
        });
    </script>
    </div> <!-- End main-content -->
</body>
</html>